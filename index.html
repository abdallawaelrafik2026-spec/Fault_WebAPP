<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø£Ø¬Ø§Ø²Ø§Øª â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</title>
<style>
  :root{--primary:#0A4C88;--accent:#08365F;--muted:#666}
  body{font-family:Arial, Tahoma, sans-serif;margin:0;background:#f4f6f8;color:#111}
  header{background:var(--primary);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  header h1{margin:0;font-size:18px}
  nav{display:flex;gap:6px;background:var(--accent);padding:8px}
  nav button{background:transparent;border:0;color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer}
  nav button.active{background:#0d5aa2}
  section{padding:16px}
  .box{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 6px rgba(0,0,0,0.05);margin-bottom:12px}
  label{display:block;margin-top:8px;font-size:14px}
  input,select,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box}
  input[type="date"]{font-size:14px;color:#333;min-height:40px;padding:10px}
  input[type="date"]::-webkit-calendar-picker-indicator{cursor:pointer}
  textarea{min-height:70px}
  .btn{background:var(--primary);color:#fff;border:0;padding:8px 10px;border-radius:6px;cursor:pointer}
  .btn.ghost{background:#eee;color:#111}
  .row{display:flex;gap:8px;align-items:center}
  .row .flex{flex:1}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{border:1px solid #ddd;padding:10px;text-align:right;vertical-align:top;min-height:40px}
  th{background:#0A4C88;color:#fff}
  .actions button{margin-left:6px}
  .status-okay{background:#c4f7c4}
  .status-working{background:#fff3b0}
  .status-wait-company{background:#ffd59e}
  .status-wait-part{background:#ffb4b4}
  #tiles{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .tile{flex:1 1 140px;background:#fff;padding:10px;border-radius:6px;text-align:center;box-shadow:0 1px 4px rgba(0,0,0,0.04)}
  canvas{background:#fff;border-radius:6px;padding:8px}
  /* Responsive helpers */
  .table-responsive{overflow-x:auto}
  canvas{max-width:100%;height:auto}
  /* Mobile card view */
  .card-view{display:none;margin-bottom:12px;padding:8px}
  .fault-card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.12)}
  .fault-card-row{display:flex;justify-content:space-between;margin:10px 0;padding:10px 0;font-size:13px;align-items:center;border-bottom:1px solid #f0f0f0}
  .fault-card-row:last-child{border-bottom:none}
  .fault-card-label{font-weight:600;color:#08365F;flex:0 0 35%;word-break:break-word}
  .fault-card-value{text-align:left;flex:1;word-break:break-word;padding-left:12px;color:#333}
  .fault-card-value.empty{color:#999;font-style:italic}
  .fault-card-actions{display:flex;gap:8px;margin-top:16px}
  .fault-card-actions button{flex:1;padding:8px;font-size:13px}
  .fault-card-actions button.btn{font-size:12px}
  .table-view{display:block}
  /* Order card styles */
  .order-card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.12)}
  .order-card-row{display:flex;justify-content:space-between;margin:10px 0;padding:10px 0;font-size:13px;align-items:center;border-bottom:1px solid #f0f0f0}
  .order-card-row:last-child{border-bottom:none}
  .order-card-label{font-weight:600;color:#08365F;flex:0 0 35%;word-break:break-word}
  .order-card-value{text-align:left;flex:1;word-break:break-word;padding-left:12px;color:#333}
  .order-card-value.empty{color:#999;font-style:italic}
  .order-card-actions{display:flex;gap:8px;margin-top:16px}
  .order-card-actions button{flex:1;padding:8px;font-size:13px}
  .order-card-actions button.btn{font-size:12px}
  /* Status badge styling */
  .card-status-badge{display:inline-block;padding:6px 12px;border-radius:6px;font-weight:600;font-size:12px;text-align:center;width:100%}

  @media (max-width:800px){
    header{padding:10px}
    header h1{font-size:16px}
    nav{flex-wrap:wrap}
    nav button{padding:6px 8px;font-size:14px}
    .row{flex-direction:column;align-items:stretch}
    .row .flex{order:99;height:0}
    .tile{flex:1 1 45%}
    .box{padding:10px}
    .table-responsive table{min-width:700px}
  }

  @media (max-width:600px){
    header h1{font-size:15px}
    nav button{font-size:13px;padding:6px}
    .tile{flex-basis:100%}
    .row .flex{display:block;height:auto}
    /* Show cards on mobile, hide table */
    .table-view{display:none}
    .card-view{display:block}
  }
  
  @media (max-width:480px){
    .fault-card-label{flex:0 0 35%}
    .fault-card-actions button{font-size:11px;padding:5px}
  }
  @media print{
    nav,.no-print,.actions,.controls{display:none!important}
    body{background:#fff}
  }
</style>
</head>
<body>
<header>
  <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ§Ù„Ø£Ø¬Ø§Ø²Ø§Øª â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h1>
  <div style="font-size:13px;color:#fff">ÙˆØ¶Ø¹ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</div>
</header>

<nav>
  <button id="navFaults">Ø§Ù„Ø£Ø¹Ø·Ø§Ù„</button>
  <button id="navOrders">Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</button>
  <button id="navAttendance">Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª</button>
  <button id="navTrash">Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</button>
  <button id="navDash">Dashboard</button>
</nav>

<section>
  <!-- FAULTS -->
  <div id="page_faults" class="page">
    <div class="box">
      <h3>ØªØ³Ø¬ÙŠÙ„ / ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø·Ù„</h3>
      <div id="form">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label><input id="machine" />
        <label>Ø±Ù‚Ù… Ø§Ù„Ø®Ø·</label><input id="line" />
        <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„Ø¹Ø·Ù„</label><input id="person" />
        <label>ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„</label><textarea id="description"></textarea>
        <label>Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</label><select id="shift"><option>ØµØ¨Ø§Ø­ÙŠØ©</option><option>Ù…Ø³Ø§Ø¦ÙŠØ©</option><option>Ù„ÙŠÙ„ÙŠØ©</option></select>
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="date" />
        <label>ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®Ø²Ù† (L Number)</label><input id="lcode" />
        <label>Ø§Ø³Ù… Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±</label><input id="partName" placeholder="Ù†Øµ Ø­Ø±" />
        <label>ÙƒÙ…ÙŠØ© Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±</label><input type="number" id="partQty" min="0" value="0" />
        <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø·Ù„</label>
        <select id="status">
          <option>ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­</option>
          <option>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­</option>
          <option>ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©</option>
          <option>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©</option>
          <option>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±</option>
        </select>
        <div class="row" style="margin-top:10px">
          <button id="addBtn" class="btn">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø·Ù„</button>
          <button class="btn ghost" id="clearBtn">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          <div class="flex"></div>
          <button class="btn" id="exportCsvAll">ØªØµØ¯ÙŠØ± CSV</button>
          <button class="btn" id="exportDocAll">ØªØµØ¯ÙŠØ± Word</button>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="row" style="margin-bottom:8px">
        <input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©ØŒ ÙˆØµÙØŒ Ø§Ù„Ù‚Ø§Ø¦Ù…â€¦" style="flex:1" />
        <input id="filterStatus" placeholder="ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© (Ù…Ø«Ø§Ù„: ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­)" style="width:220px;max-width:40%" />
        <button class="btn ghost" id="applyFiltersBtn">ØªØ·Ø¨ÙŠÙ‚</button>
        <button class="btn ghost" id="clearFiltersBtn">Ø¥Ø¹Ø§Ø¯Ø©</button>
      </div>
      <div class="row" style="margin-bottom:8px">
        <label style="margin:0;flex:0 0 auto;padding-right:8px">Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateFromFault" style="flex:0 0 150px" />
        <label style="margin:0;flex:0 0 auto;padding-right:8px;padding-left:8px">Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateToFault" style="flex:0 0 150px" />
        <button class="btn ghost" id="applyDateFilterFaultBtn">Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
        <div class="flex"></div>
      </div>

      <div class="table-view">
      <div class="table-responsive">
      <table id="faultTable">
        <thead>
          <tr>
            <th>#</th><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ø§Ù„Ø®Ø·</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>L Number</th><th>Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      <div id="faultCards" class="card-view"></div>

      <!-- print / PDF button placed below table as requested (B) -->
      <div style="margin-top:10px; text-align:left;">
        <button class="btn" id="printPdfAll">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ ÙƒÙ€ PDF</button>
      </div>
    </div>
  </div>

  <!-- ORDERS -->
  <div id="page_orders" class="page" style="display:none">
    <div class="box">
      <h3>Ø£Ù…Ø± Ø´Ø±Ø§Ø¡ / ØªÙˆØ±ÙŠØ¯</h3>
      <label>Ø±Ù‚Ù… Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label><input id="orderNum" />
      <label>Ø±Ù‚Ù… Ø£Ù…Ø± Ø§Ù„ØªÙˆØ±ÙŠØ¯</label><input id="supplyNum" />
      <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="orderDate" />
      <label>Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label><input id="orderPerson" />
      <label>ØªÙØ§ØµÙŠÙ„ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label><textarea id="orderDetails" placeholder="ØªÙØ§ØµÙŠÙ„ Ø£Ùˆ ÙˆØµÙ Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡"></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="addOrderBtn">Ø¥Ø¶Ø§ÙØ© Ø£Ù…Ø±</button>
        <button class="btn ghost" id="clearOrderBtn">Ù…Ø³Ø­</button>
        <div class="flex"></div>
        <button class="btn" id="exportOrdersCsv">ØªØµØ¯ÙŠØ± CSV</button>
        <button class="btn" id="exportOrdersDoc">ØªØµØ¯ÙŠØ± Word</button>
      </div>
    </div>

    <div class="box">
      <div class="row" style="margin-bottom:8px">
        <input id="searchOrder" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø£Ù…Ø± Ø£Ùˆ Ø§Ù„Ù‚Ø§Ø¦Ù…â€¦" style="flex:1" />
        <button class="btn ghost" id="applyOrderFilterBtn">ØªØ·Ø¨ÙŠÙ‚</button>
      </div>
      <div class="row" style="margin-bottom:8px">
        <label style="margin:0;flex:0 0 auto;padding-right:8px">Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateFromOrder" style="flex:0 0 150px" />
        <label style="margin:0;flex:0 0 auto;padding-right:8px;padding-left:8px">Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateToOrder" style="flex:0 0 150px" />
        <button class="btn ghost" id="applyDateFilterOrderBtn">Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
        <div class="flex"></div>
      </div>
      <div class="table-view">
      <div class="table-responsive">
      <table id="orderTable">
        <thead><tr><th>Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>ØªÙˆØ±ÙŠØ¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ù…Ø±</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th></tr></thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      <div id="orderCards" class="card-view"></div>

      <!-- print / PDF button placed below table as requested (B) -->
      <div style="margin-top:10px; text-align:left;">
        <button class="btn" id="printOrdersBtn">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ ÙƒÙ€ PDF</button>
      </div>
    </div>
  </div>

  <!-- ATTENDANCE -->
  <div id="page_attendance" class="page" style="display:none">
    <div class="box">
      <h3>Ø³Ø¬Ù„ Ø§Ù„ØºÙŠØ§Ø¨</h3>
      <div id="attendanceForm">
        <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</label><input id="workerName" />
        <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</label><input id="workerNum" />
        <label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø¬Ø§Ø²Ø©</label><input type="date" id="absenceDate" />
        <label>Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø¬Ø§Ø²Ø©</label><input type="number" id="daysCount" min="1" value="1" />
        <div class="row" style="margin-top:10px">
          <button class="btn" id="addAttendanceBtn">Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„</button>
          <button class="btn ghost" id="clearAttendanceBtn">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          <div class="flex"></div>
          <button class="btn" id="exportAttendanceCsv">ØªØµØ¯ÙŠØ± CSV</button>
          <button class="btn" id="exportAttendanceDoc">ØªØµØ¯ÙŠØ± Word</button>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="row" style="margin-bottom:8px">
        <input id="searchAttendance" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…â€¦" style="flex:1" />
        <button class="btn ghost" id="applyAttendanceFilterBtn">ØªØ·Ø¨ÙŠÙ‚</button>
      </div>
      <div class="row" style="margin-bottom:8px">
        <label style="margin:0;flex:0 0 auto;padding-right:8px">Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateFromAttendance" style="flex:0 0 150px" />
        <label style="margin:0;flex:0 0 auto;padding-right:8px;padding-left:8px">Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <input type="date" id="dateToAttendance" style="flex:0 0 150px" />
        <button class="btn ghost" id="applyDateFilterAttendanceBtn">Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®</button>
        <div class="flex"></div>
      </div>
      <div class="table-view">
      <div class="table-responsive">
      <table id="attendanceTable">
        <thead>
          <tr>
            <th>#</th><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</th><th>ÙŠÙˆÙ… Ø§Ù„ØªØºÙŠØ¨</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      <div id="attendanceCards" class="card-view"></div>

      <div style="margin-top:10px; text-align:left;">
        <button class="btn" id="printAttendanceBtn">Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ ÙƒÙ€ PDF</button>
      </div>
    </div>
  </div>

  <!-- TRASH -->
  <div id="page_trash" class="page" style="display:none">
    <div class="box">
      <h3>Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</h3>
      <div style="margin-bottom:8px">
        <button class="btn ghost" id="emptyTrashBtn">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</button>
      </div>
      <h4>Ø£Ø¹Ø·Ø§Ù„ Ù…Ø­Ø°ÙˆÙØ©</h4>
      <div class="table-responsive">
      <table id="trashFaults"><thead><tr><th>#</th><th>Ø¨ÙŠØ§Ù†</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th></tr></thead><tbody></tbody></table>
      </div>
      <h4 style="margin-top:12px">Ø£ÙˆØ§Ù…Ø± Ù…Ø­Ø°ÙˆÙØ©</h4>
      <div class="table-responsive">
      <table id="trashOrders"><thead><tr><th>Ø£Ù…Ø±</th><th>ØªÙˆØ±ÙŠØ¯</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th></tr></thead><tbody></tbody></table>
      </div>
      <h4 style="margin-top:12px">Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©</h4>
      <div class="table-responsive">
      <table id="trashAttendance"><thead><tr><th>#</th><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„ / Ø±Ù‚Ù…</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨</th><th class="no-print">Ø£ÙˆØ§Ù…Ø±</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="page_dash" class="page" style="display:none">
    <div id="tiles" style="margin-bottom:12px"></div>
    <div class="box" style="max-width:800px;margin:0 auto">
      <canvas id="pie" width="800" height="300"></canvas>
      <div style="margin-top:12px">
        <div class="table-responsive">
        <table id="dashTable" style="width:100%"><thead><tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzp_3jEVPPKlHxzIC5WVqX01yWi9c4RvVjL4Mp-RNzlTqJpqH84Uf49y4ux-dzON1Y-/exec';
/* storage keys */
const K_FAULTS='faults_v2_final', K_ORDERS='orders_v2_final', K_TRASH='trash_v2_final', K_ATT='attendance_v1';

/* load */
let faults = JSON.parse(localStorage.getItem(K_FAULTS)||'[]');
let orders = JSON.parse(localStorage.getItem(K_ORDERS)||'[]');
let trash = JSON.parse(localStorage.getItem(K_TRASH)||'{"faults":[],"orders":[],"attendance":[]}');
let attendance = JSON.parse(localStorage.getItem(K_ATT)||'[]');

// ØªÙ†Ø¶ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ù† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø²Ø§Ø¦Ø¯
faults.forEach(f => { if(f.date) f.date = formatDateOnly(f.date); });
orders.forEach(o => { if(o.date) o.date = formatDateOnly(o.date); });
trash.faults.forEach(f => { if(f.date) f.date = formatDateOnly(f.date); });
trash.orders.forEach(o => { if(o.date) o.date = formatDateOnly(o.date); });
attendance.forEach(a => { if(a.absenceDate) a.absenceDate = formatDateOnly(a.absenceDate); });
trash.attendance?.forEach(a => { if(a.absenceDate) a.absenceDate = formatDateOnly(a.absenceDate); });
saveAll();

/* Trash sync interval - declare early to avoid ReferenceError */
let trashSyncInterval = null;

/* ui refs */
const navFaults = document.getElementById('navFaults');
const navOrders = document.getElementById('navOrders');
const navAttendance = document.getElementById('navAttendance');
const navTrash = document.getElementById('navTrash');
const navDash = document.getElementById('navDash');

navFaults.onclick = ()=>show('faults');
navOrders.onclick = ()=>show('orders');
navAttendance.onclick = ()=>show('attendance');
navTrash.onclick = ()=>show('trash');
navDash.onclick = ()=>show('dash');

function show(page){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  if(page==='faults'){ document.getElementById('page_faults').style.display='block'; navFaults.classList.add('active'); stopTrashSync(); }
  if(page==='orders'){ document.getElementById('page_orders').style.display='block'; navOrders.classList.add('active'); stopTrashSync(); }
  if(page==='attendance'){ document.getElementById('page_attendance').style.display='block'; navAttendance.classList.add('active'); stopTrashSync(); }
  if(page==='trash'){ document.getElementById('page_trash').style.display='block'; navTrash.classList.add('active'); startTrashSync(); }
  if(page==='dash'){ document.getElementById('page_dash').style.display='block'; navDash.classList.add('active'); drawDashboard(); stopTrashSync(); }
}
show('faults');

/* helpers */
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }
function getTodayDate(){ 
  const d = new Date(); 
  const year = d.getFullYear(); 
  const month = String(d.getMonth()+1).padStart(2,'0'); 
  const day = String(d.getDate()).padStart(2,'0'); 
  return `${year}-${month}-${day}`; 
}
function formatDateOnly(dateStr) {
  if (!dateStr) return '';
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙŠØºØ© YYYY-MM-DD ÙÙ‚Ø·ØŒ Ø£Ø±Ø¬Ø¹Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ
  if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
  // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙˆÙ‚ØªØŒ Ø´ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª
  return dateStr.split('T')[0].split(' ')[0];
}
function saveAll(){ localStorage.setItem(K_FAULTS, JSON.stringify(faults)); localStorage.setItem(K_ORDERS, JSON.stringify(orders)); localStorage.setItem(K_TRASH, JSON.stringify(trash)); localStorage.setItem(K_ATT, JSON.stringify(attendance)); }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø£Ùˆ Dash Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
function displayValue(value) {
  const val = String(value || '').trim();
  if (!val || val === 'undefined' || val === 'null' || val === '0') {
    return '<span class="empty">â€”</span>';
  }
  return escapeHtml(val);
}

function startTrashSync(){
  // if(trashSyncInterval) return; // Already syncing
  if (typeof trashSyncInterval !== "undefined" && trashSyncInterval) {
        clearInterval(trashSyncInterval);
    }
  console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª');
  // Initial load
  loadTrashFromServer();
  // Then refresh every 2 seconds while viewing trash
  trashSyncInterval = setInterval(loadTrashFromServer, 2000);
}

function stopTrashSync(){
  if(trashSyncInterval){
    clearInterval(trashSyncInterval);
    trashSyncInterval = null;
    console.log('â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª');
  }
}

function loadTrashFromServer(){
  // Load deleted faults and orders from server
  fetch(API_URL + '?kind=trash_faults')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      trash.faults = data;
      renderTrash();
    })
    .catch(err => console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©', err));

  fetch(API_URL + '?kind=trash_orders')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      trash.orders = data;
      renderTrash();
    })
    .catch(err => console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©', err));
}

/* render functions */
function renderFaultTable(){
  const tbody = document.querySelector('#faultTable tbody'); tbody.innerHTML='';
  faults.forEach((f,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td>
      <td>${escapeHtml(f.machine)}</td>
      <td>${escapeHtml(f.line)}</td>
      <td>${escapeHtml(f.person)}</td>
      <td>${escapeHtml(f.description)}</td>
      <td>${escapeHtml(f.shift)}</td>
      <td>${escapeHtml(f.date)}</td>
      <td>${escapeHtml(f.lcode)}</td>
      <td>${escapeHtml(f.partName)}</td>
      <td>${escapeHtml(f.partQty)}</td>
      <td class="status-cell">${escapeHtml(f.status)}</td>
      <td class="no-print actions">
        <button class="btn ghost" onclick="startEditFault('${f.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn" onclick="moveToTrashFault('${f.id}')">Ø­Ø°Ù</button>
      </td>`;
    const sc = tr.querySelector('.status-cell');
    if(f.status==='ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­') sc.classList.add('status-okay');
    else if(f.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­' || f.status==='ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©') sc.classList.add('status-working');
    else if(f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©') sc.classList.add('status-wait-company');
    else if(f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±') sc.classList.add('status-wait-part');
    tbody.appendChild(tr);
  });
  saveAll();
}

function renderOrderTable(){
  const tbody = document.querySelector('#orderTable tbody'); tbody.innerHTML='';
  orders.forEach((o,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(o.orderNum)}</td><td>${escapeHtml(o.supplyNum)}</td><td>${escapeHtml(o.date)}</td><td>${escapeHtml(o.person)}</td><td>${escapeHtml(o.details||'')}</td>
      <td class="no-print actions"><button class="btn ghost" onclick="startEditOrder('${o.id}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn" onclick="moveToTrashOrder('${o.id}')">Ø­Ø°Ù</button></td>`;
    tbody.appendChild(tr);
  });
  saveAll();
}

function renderTrash(){
  const tf = document.querySelector('#trashFaults tbody'); tf.innerHTML='';
  trash.faults.forEach((f,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i+1} - ${escapeHtml(f.machine)} (${escapeHtml(f.date)})</td>
      <td class="no-print actions"><button class="btn" onclick="restoreFault('${f.id}')">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button><button class="btn ghost" onclick="permanentDeleteFault('${f.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button></td>`;
    tf.appendChild(tr);
  });
  const to = document.querySelector('#trashOrders tbody'); to.innerHTML='';
  trash.orders.forEach((o,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(o.orderNum)} - ${escapeHtml(o.date)}</td><td class="no-print actions"><button class="btn" onclick="restoreOrder('${o.id}')">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button><button class="btn ghost" onclick="permanentDeleteOrder('${o.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button></td>`;
    to.appendChild(tr);
  });
}

/* CRUD faults */
let editingFaultId = null;
document.getElementById('addBtn').addEventListener('click', onAddOrSave);
document.getElementById('clearBtn').addEventListener('click', clearFaultForm);
function clearFaultForm(){
  editingFaultId = null;
  document.getElementById('machine').value=''; 
  document.getElementById('line').value=''; 
  document.getElementById('person').value=''; 
  document.getElementById('description').value=''; 
  document.getElementById('shift').value='ØµØ¨Ø§Ø­ÙŠØ©'; 
  document.getElementById('date').value=getTodayDate(); 
  document.getElementById('lcode').value=''; 
  document.getElementById('partName').value=''; 
  document.getElementById('partQty').value=0; 
  document.getElementById('status').value='ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­'; 
  document.getElementById('addBtn').innerText='Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø·Ù„';
}

function onAddOrSave(){
  if(editingFaultId) return saveEditFault();
  const f = {
    id: uid(),
    machine: document.getElementById('machine').value.trim(),
    line: document.getElementById('line').value.trim(),
    person: document.getElementById('person').value.trim(),
    description: document.getElementById('description').value.trim(),
    shift: document.getElementById('shift').value,
    date: formatDateOnly(document.getElementById('date').value),
    lcode: document.getElementById('lcode').value.trim(),
    partName: document.getElementById('partName').value.trim(),
    partQty: Number(document.getElementById('partQty').value||0),
    status: document.getElementById('status').value
  };
  fetch(API_URL, {
  method: 'POST',
  // headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({ kind: 'fault', op: 'add', data: f })
}).then(r => r.json())
  .then(res => {
    if (!res.ok) alert('ÙÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ø·Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
  }).catch(err => {
    console.error(err);
    alert('Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
  });
  faults.unshift(f);
  clearFaultForm(); 
  renderFaultTable(); 
  drawDashboard(); 
  show('faults');
}

/* edit fault */
function startEditFault(id){
  const f = faults.find(x=>x.id===id); if(!f) return alert('Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); editingFaultId = id;
  document.getElementById('machine').value = f.machine;
  document.getElementById('line').value = f.line;
  document.getElementById('person').value = f.person;
  document.getElementById('description').value = f.description;
  document.getElementById('shift').value = f.shift;
  document.getElementById('date').value = f.date;
  document.getElementById('lcode').value = f.lcode;
  document.getElementById('partName').value = f.partName;
  document.getElementById('partQty').value = f.partQty;
  document.getElementById('status').value = f.status;
  document.getElementById('addBtn').innerText = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
}

function saveEditFault(){
  const idx = faults.findIndex(x=>x.id===editingFaultId); if(idx===-1) return alert('Ø®Ø·Ø£ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');

  // Ø­Ø¯Ù‘Ø« ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©
  faults[idx].machine = document.getElementById('machine').value.trim();
  faults[idx].line = document.getElementById('line').value.trim();
  faults[idx].person = document.getElementById('person').value.trim();
  faults[idx].description = document.getElementById('description').value.trim();
  faults[idx].shift = document.getElementById('shift').value;
  faults[idx].date = formatDateOnly(document.getElementById('date').value);
  faults[idx].lcode = document.getElementById('lcode').value.trim();
  faults[idx].partName = document.getElementById('partName').value.trim();
  faults[idx].partQty = Number(document.getElementById('partQty').value||0);
  faults[idx].status = document.getElementById('status').value;

   // Ø§Ø¨Ø¹Øª Update Ù„Ù„Ù€ Sheet
  const f = faults[idx];
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'fault', op: 'update', data: f })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù… ÙŠÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± (Sheet)');
    })
    .catch(err => console.error('fault update error', err));

  editingFaultId = null;
  clearFaultForm(); 
  renderFaultTable(); 
  drawDashboard(); 
  show('faults');
}

function moveToTrashFault(id){
  const f = faults.find(x=>x.id===id);
  if(!f) return;
  
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ True ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  f.deleted = true;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'fault', op: 'update', data: f })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø°Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('fault move to trash error', err));

  // Ø§Ù†Ù‚Ù„ Ù…Ù† faults Ø¥Ù„Ù‰ trash Ù…Ø­Ù„ÙŠÙ‹Ø§
  const idx = faults.findIndex(x=>x.id===id);
  if(idx !== -1) {
    trash.faults.unshift(faults.splice(idx,1)[0]);
    saveAll();
    renderFaultTable();
    renderTrash();
    drawDashboard();
  }
}

function restoreFault(id){
  const f = trash.faults.find(x=>x.id===id);
  if(!f) return;
  
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ False ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  f.deleted = false;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'fault', op: 'update', data: f })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('fault restore error', err));

  // Ø§Ù†Ù‚Ù„ Ù…Ù† trash Ø¥Ù„Ù‰ faults Ù…Ø­Ù„ÙŠÙ‹Ø§
  const idx = trash.faults.findIndex(x=>x.id===id);
  if(idx !== -1) {
    faults.unshift(trash.faults.splice(idx,1)[0]);
    saveAll();
    renderFaultTable();
    renderTrash();
    drawDashboard();
  }
}
// function permanentDeleteFault(id){ const idx = trash.faults.findIndex(x=>x.id===id); if(idx===-1) return; if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return; trash.faults.splice(idx,1); saveAll(); renderTrash(); }
function permanentDeleteFault(id){
  const idx = trash.faults.findIndex(x=>x.id===id); 
  if(idx===-1) return;
  if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return;

  // Ø£ÙŠÙ‚Ù Ø§Ù„Ù€ sync Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¹Ø´Ø§Ù† Ù…Ø§ ØªØ±Ø¬Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  stopTrashSync();

  // Ø§Ø¨Ø¹Øª Delete Ù„Ù„Ù€ Sheet
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'fault', op: 'delete', data: { id } })
  }).then(r=>r.json())
    .then(res => {
      // Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø­Ø°ÙØŒ Ø´ÙŠÙ‘Ù„ Ø§Ù„Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØ£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
      trash.faults.splice(idx,1); 
      saveAll(); 
      renderTrash();
      // Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
      startTrashSync();
      if(!res.ok) alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Sheet)');
    })
    .catch(err => {
      console.error('fault delete error', err);
      alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
      // Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø­ØªÙ‰ Ù„Ùˆ ÙÙŠ Ø®Ø·Ø£
      startTrashSync();
    });
}


/* CRUD orders */
let editingOrderId = null;
document.getElementById('addOrderBtn').addEventListener('click', ()=> {
  if(editingOrderId) return saveEditOrder(); addOrder();});
document.getElementById('clearOrderBtn').addEventListener('click', clearOrderForm);

function addOrder(){
  const o = { 
    id: uid(), 
    orderNum: document.getElementById('orderNum').value.trim(), 
    supplyNum: document.getElementById('supplyNum').value.trim(), 
    date: formatDateOnly(document.getElementById('orderDate').value), 
    person: document.getElementById('orderPerson').value.trim(), 
    details: document.getElementById('orderDetails').value.trim() 
  };
  fetch(API_URL, {
  method: 'POST',
  // headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({ kind: 'order', op: 'add', data: o })
}).then(r => r.json())
  .then(res => {
    if (!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø£Ù…Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
  }).catch(err => {
    console.error(err);
    alert('Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
  });
  orders.unshift(o); clearOrderForm(); renderOrderTable(); renderTrash();
}
function startEditOrder(id){
  const o = orders.find(x=>x.id===id); if(!o) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); editingOrderId=id; document.getElementById('orderNum').value=o.orderNum; document.getElementById('supplyNum').value=o.supplyNum; document.getElementById('orderDate').value=o.date; document.getElementById('orderPerson').value=o.person; document.getElementById('orderDetails').value=o.details; document.getElementById('addOrderBtn').innerText='Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
}
// function saveEditOrder(){ const idx=orders.findIndex(x=>x.id===editingOrderId); if(idx===-1) return; orders[idx].orderNum=document.getElementById('orderNum').value.trim(); orders[idx].supplyNum=document.getElementById('supplyNum').value.trim(); orders[idx].date=document.getElementById('orderDate').value; orders[idx].person=document.getElementById('orderPerson').value.trim(); orders[idx].details=document.getElementById('orderDetails').value.trim(); editingOrderId=null; clearOrderForm(); renderOrderTable(); }
function saveEditOrder(){
  const idx = orders.findIndex(x=>x.id===editingOrderId); 
  if(idx===-1) return;

  orders[idx].orderNum = document.getElementById('orderNum').value.trim();
  orders[idx].supplyNum= document.getElementById('supplyNum').value.trim();
  orders[idx].date     = formatDateOnly(document.getElementById('orderDate').value);
  orders[idx].person   = document.getElementById('orderPerson').value.trim();
  orders[idx].details  = document.getElementById('orderDetails').value.trim();

  const o = orders[idx];
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'order', op: 'update', data: o })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù…Ø± Ù„Ù… ÙŠÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('order update error', err));

  editingOrderId=null; 
  clearOrderForm(); 
  renderOrderTable();
}

function clearOrderForm(){ 
  document.getElementById('orderNum').value=''; 
  document.getElementById('supplyNum').value=''; 
  document.getElementById('orderDate').value=getTodayDate(); 
  document.getElementById('orderPerson').value=''; 
  document.getElementById('orderDetails').value=''; 
  editingOrderId=null; 
  document.getElementById('addOrderBtn').innerText='Ø¥Ø¶Ø§ÙØ© Ø£Ù…Ø±'; 
}

function moveToTrashOrder(id){
  const o = orders.find(x=>x.id===id);
  if(!o) return;
  
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ True ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  o.deleted = true;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'order', op: 'update', data: o })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø°Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('order move to trash error', err));

  // Ø§Ù†Ù‚Ù„ Ù…Ù† orders Ø¥Ù„Ù‰ trash Ù…Ø­Ù„ÙŠÙ‹Ø§
  const idx = orders.findIndex(x=>x.id===id);
  if(idx !== -1) {
    trash.orders.unshift(orders.splice(idx,1)[0]);
    saveAll();
    renderOrderTable();
    renderTrash();
  }
}

function restoreOrder(id){
  const o = trash.orders.find(x=>x.id===id);
  if(!o) return;
  
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ False ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  o.deleted = false;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'order', op: 'update', data: o })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('order restore error', err));

  // Ø§Ù†Ù‚Ù„ Ù…Ù† trash Ø¥Ù„Ù‰ orders Ù…Ø­Ù„ÙŠÙ‹Ø§
  const idx = trash.orders.findIndex(x=>x.id===id);
  if(idx !== -1) {
    orders.unshift(trash.orders.splice(idx,1)[0]);
    saveAll();
    renderOrderTable();
    renderTrash();
  }
}
function permanentDeleteOrder(id){
  const idx = trash.orders.findIndex(x=>x.id===id); 
  if(idx===-1) return;
  if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return;

  // Ø£ÙŠÙ‚Ù Ø§Ù„Ù€ sync Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¹Ø´Ø§Ù† Ù…Ø§ ØªØ±Ø¬Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  stopTrashSync();

  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'order', op: 'delete', data: { id } })
  }).then(r=>r.json())
    .then(res => {
      // Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø­Ø°ÙØŒ Ø´ÙŠÙ‘Ù„ Ø§Ù„Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØ£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
      trash.orders.splice(idx,1); 
      saveAll(); 
      renderTrash();
      // Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
      startTrashSync();
      if(!res.ok) alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Sheet)');
    })
    .catch(err => {
      console.error('order delete error', err);
      alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
      // Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø­ØªÙ‰ Ù„Ùˆ ÙÙŠ Ø®Ø·Ø£
      startTrashSync();
    });
}

// function permanentDeleteOrder(id){ const idx=trash.orders.findIndex(x=>x.id===id); if(idx===-1) return; if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return; trash.orders.splice(idx,1); saveAll(); renderTrash(); }
document.getElementById('emptyTrashBtn').addEventListener('click', ()=> 
            { if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§ØªØŸ')) return; 
            trash={faults:[],orders:[],attendance:[]}; 
            saveAll(); 
            renderTrash(); });

            document.getElementById('emptyTrashBtn').addEventListener('click', () => {
  if (!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª (Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø±)ØŸ')) return;

  // Ø¬Ù‡Ù‘Ø² Ø§Ù„Ù€ IDs Ø§Ù„Ù„ÙŠ Ù‡ØªØªÙ…Ø³Ø­ Ù…Ù† Ø§Ù„Ø´ÙŠØª
  const faultIds = trash.faults.map(f => f.id);
  const orderIds = trash.orders.map(o => o.id);

  const requests = [];

  // Ø§Ø¨Ø¹Øª Ø·Ù„Ø¨ Ø­Ø°Ù Ù„ÙƒÙ„ Ø¹Ø·Ù„
  faultIds.forEach(id => {
    requests.push(
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ kind: 'fault', op: 'delete', data: { id } })
      })
    );
  });

  // Ø§Ø¨Ø¹Øª Ø·Ù„Ø¨ Ø­Ø°Ù Ù„ÙƒÙ„ Ø£Ù…Ø± Ø´Ø±Ø§Ø¡
  orderIds.forEach(id => {
    requests.push(
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ kind: 'order', op: 'delete', data: { id } })
      })
    );
  });

  // Ù„Ù…Ø§ ØªØ®Ù„Øµ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø­ØªÙ‰ Ù„Ùˆ ÙÙŠ Ø¨Ø¹Ø¶Ù‡Ø§ ÙØ´Ù„)
  Promise.allSettled(requests).then(() => {
    // ÙØ¶Ù‘ÙŠ Ø§Ù„Ø³Ù„Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§
    trash = { faults: [], orders: [], attendance: [] };
    saveAll();
    renderTrash();
    alert('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª Ù…Ù† Ø§Ù„Ø³Ù„Ø©ØŒ ÙˆØ­Ø§ÙˆÙ„Ù†Ø§ Ø­Ø°ÙÙ‡Ø§ Ù…Ù† DB Ø£ÙŠØ¶Ù‹Ø§.');
  }).catch(err => {
    console.error('empty trash error', err);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù Ù…Ù† Google SheetØŒ Ù„ÙƒÙ† ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§.');
  });
});

/* ATTENDANCE: CRUD, render, exports */
let editingAttendanceId = null;

// Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£ÙŠØ§Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ
const arabicDayNames = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©', 'Ø§Ù„Ø³Ø¨Øª'];

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø¬Ø§Ø²Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
function calculateVacationDays(startDateStr, numDays) {
  const startDate = new Date(startDateStr);
  const dayNames = [];
  
  for (let i = 0; i < numDays; i++) {
    const currentDate = new Date(startDate);
    currentDate.setDate(startDate.getDate() + i);
    const dayIndex = currentDate.getDay();
    dayNames.push(arabicDayNames[dayIndex]);
  }
  
  return dayNames.join(', ');
}

document.getElementById('addAttendanceBtn').addEventListener('click', ()=>{ if(editingAttendanceId) return saveEditAttendance(); addAttendance(); });
document.getElementById('clearAttendanceBtn').addEventListener('click', clearAttendanceForm);

function clearAttendanceForm(){
  editingAttendanceId = null;
  document.getElementById('workerName').value=''; 
  document.getElementById('workerNum').value=''; 
  document.getElementById('absenceDate').value=getTodayDate(); 
  document.getElementById('daysCount').value=1; 
  document.getElementById('addAttendanceBtn').innerText='Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„';
}

function addAttendance(){
  const startDate = formatDateOnly(document.getElementById('absenceDate').value);
  const daysCount = Number(document.getElementById('daysCount').value||1);
  
  if (!startDate) {
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø¬Ø§Ø²Ø©');
    return;
  }
  
  // Ø§Ø­Ø³Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø¬Ø§Ø²Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  const daysName = calculateVacationDays(startDate, daysCount);
  
  const a = { 
    id: uid(), 
    workerName: document.getElementById('workerName').value.trim(), 
    workerNum: document.getElementById('workerNum').value.trim(), 
    absenceDate: startDate, 
    daysCount: daysCount, 
    absenceDay: daysName  // Ø§Ù„Ø£ÙŠØ§Ù… Ù…Ø­Ø³ÙˆØ¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  };
  
  // Ø§Ø¨Ø¹Øª Ù„Ù„Ù€ Server
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'add', data: a })
  }).then(r => r.json())
    .then(res => {
      if (!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
    }).catch(err => {
      console.error(err);
      alert('Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ù‡ÙŠØªØ­ÙØ¸ Local Ø¨Ø³');
    });
  
  attendance.unshift(a);
  clearAttendanceForm(); renderAttendanceTable(); show('attendance');
}

function startEditAttendance(id){ 
  const a = attendance.find(x=>x.id===id); 
  if(!a) return alert('Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); 
  editingAttendanceId = id; 
  document.getElementById('workerName').value=a.workerName; 
  document.getElementById('workerNum').value=a.workerNum; 
  document.getElementById('absenceDate').value=a.absenceDate; 
  document.getElementById('daysCount').value=a.daysCount; 
  document.getElementById('addAttendanceBtn').innerText='Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'; 
}

function saveEditAttendance(){ 
  const idx = attendance.findIndex(x=>x.id===editingAttendanceId); 
  if(idx===-1) return alert('Ø®Ø·Ø£ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
  
  const startDate = formatDateOnly(document.getElementById('absenceDate').value);
  const daysCount = Number(document.getElementById('daysCount').value||1);
  
  // Ø§Ø­Ø³Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  const daysName = calculateVacationDays(startDate, daysCount);
  
  attendance[idx].workerName = document.getElementById('workerName').value.trim(); 
  attendance[idx].workerNum = document.getElementById('workerNum').value.trim(); 
  attendance[idx].absenceDate = startDate; 
  attendance[idx].daysCount = daysCount;
  attendance[idx].absenceDay = daysName;
  
  // Ø§Ø¨Ø¹Øª Update Ù„Ù„Ù€ Server
  const a = attendance[idx];
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'update', data: a })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù… ÙŠÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('attendance update error', err));
  
  editingAttendanceId = null; 
  clearAttendanceForm(); 
  renderAttendanceTable(); 
}

function deleteAttendance(id){
  if(!confirm('Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
  const idx = attendance.findIndex(x=>x.id===id);
  if(idx===-1) return;
  
  const item = attendance[idx];
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ True ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  item.deleted = true;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'update', data: item })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø°Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('attendance move to trash error', err));
  
  // move to trash.attendance
  const movedItem = attendance.splice(idx,1)[0];
  if(!trash.attendance) trash.attendance = [];
  trash.attendance.unshift(movedItem);
  saveAll();
  renderAttendanceTable();
  renderTrash();
}

function restoreAttendance(id){
  const idx = trash.attendance.findIndex(x=>x.id===id);
  if(idx===-1) return;
  
  const item = trash.attendance[idx];
  // Ø­Ø¯Ù‘Ø« Ø­Ù‚Ù„ Delete Ø¥Ù„Ù‰ False ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
  item.deleted = false;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'update', data: item })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±');
    })
    .catch(err => console.error('attendance restore error', err));
  
  // Ø§Ù†Ù‚Ù„ Ù…Ù† trash Ø¥Ù„Ù‰ attendance Ù…Ø­Ù„ÙŠÙ‹Ø§
  const movedItem = trash.attendance.splice(idx,1)[0];
  attendance.unshift(movedItem);
  saveAll();
  renderAttendanceTable();
  renderTrash();
}

function permanentDeleteAttendance(id){
  const idx = trash.attendance.findIndex(x=>x.id===id);
  if(idx===-1) return;
  if(!confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return;
  
  // Ø£ÙŠÙ‚Ù Ø§Ù„Ù€ sync Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¹Ø´Ø§Ù† Ù…Ø§ ØªØ±Ø¬Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
  stopTrashSync();

  // Ø§Ø¨Ø¹Øª Delete Ù„Ù„Ù€ Server
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'delete', data: { id } })
  }).then(r=>r.json())
    .then(res => {
      // Ø¨Ø¹Ø¯ Ù…Ø§ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø­Ø°ÙØŒ Ø´ÙŠÙ‘Ù„ Ø§Ù„Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆØ£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
      trash.attendance.splice(idx,1); 
      saveAll(); 
      renderTrash();
      // Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
      startTrashSync();
      if(!res.ok) alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (Sheet)');
    })
    .catch(err => {
      console.error('attendance delete error', err);
      alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
      // Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø­ØªÙ‰ Ù„Ùˆ ÙÙŠ Ø®Ø·Ø£
      startTrashSync();
    });
}

function renderAttendanceTable(){ const tbody = document.querySelector('#attendanceTable tbody'); tbody.innerHTML=''; const cardsDiv = document.getElementById('attendanceCards'); cardsDiv.innerHTML=''; attendance.forEach((a,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(a.workerName)}</td><td>${escapeHtml(a.workerNum)}</td><td>${escapeHtml(a.absenceDate)}</td><td>${escapeHtml(a.daysCount)}</td><td>${escapeHtml(a.absenceDay)}</td><td class="no-print actions"><button class="btn ghost" onclick="startEditAttendance('${a.id}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn" onclick="deleteAttendance('${a.id}')">Ø­Ø°Ù</button></td>`; tbody.appendChild(tr);
    // card view
    const card = document.createElement('div'); card.className='order-card'; card.innerHTML = `
      <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">${i+1} - ${escapeHtml(a.workerName)}</div>
      <div class="order-card-row"><div class="order-card-label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„:</div><div class="order-card-value">${displayValue(a.workerNum)}</div></div>
      <div class="order-card-row"><div class="order-card-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨:</div><div class="order-card-value">${displayValue(a.absenceDate)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…:</div><div class="order-card-value">${displayValue(a.daysCount)}</div></div>
      <div class="order-card-row"><div class="order-card-label">ÙŠÙˆÙ… Ø§Ù„ØªØºÙŠØ¨:</div><div class="order-card-value">${displayValue(a.absenceDay)}</div></div>
      <div class="order-card-actions"><button class="btn ghost" onclick="startEditAttendance('${a.id}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn" onclick="deleteAttendance('${a.id}')">Ø­Ø°Ù</button></div>
    `; cardsDiv.appendChild(card);
  }); saveAll(); }

/* Attendance filters & exports */
document.getElementById('applyAttendanceFilterBtn').addEventListener('click', applyAttendanceFilters);
function applyAttendanceFilters(){ 
  const q=(document.getElementById('searchAttendance').value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromAttendance').value;
  const dateTo = document.getElementById('dateToAttendance').value;
  
  // Filter table view
  document.querySelectorAll('#attendanceTable tbody tr').forEach(tr=> {
    const text = tr.innerText.toLowerCase();
    const cells = tr.querySelectorAll('td');
    const rowDate = cells[3]?.textContent || ''; // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ 3
    
    const dateMatch = (!dateFrom || !dateTo || (rowDate >= dateFrom && rowDate <= dateTo));
    tr.style.display = (!q || text.includes(q)) && dateMatch ? '' : 'none';
  });
  
  // Filter card view
  document.querySelectorAll('#attendanceCards .order-card').forEach(card=> {
    const text = card.innerText.toLowerCase();
    const dateText = Array.from(card.querySelectorAll('.order-card-row')).find(row => row.textContent.includes('ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨'))?.textContent || '';
    const rowDate = dateText.replace('ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨', '').trim();
    
    const dateMatch = (!dateFrom || !dateTo || (rowDate >= dateFrom && rowDate <= dateTo));
    card.style.display = (!q || text.includes(q)) && dateMatch ? '' : 'none';
  });
}

// Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
document.getElementById('applyDateFilterAttendanceBtn')?.addEventListener('click', applyAttendanceFilters);
document.getElementById('searchAttendance').addEventListener('input', applyAttendanceFilters);

document.getElementById('exportAttendanceCsv').addEventListener('click', ()=>{
  // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±
  const visibleRows = Array.from(document.querySelectorAll('#attendanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const headers=['#','workerName','workerNum','absenceDate','daysCount','absenceDay'];
  const rows = [];
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    rows.push({
      '#': i+1,
      workerName: cells[1].textContent,
      workerNum: cells[2].textContent,
      absenceDate: cells[3].textContent,
      daysCount: cells[4].textContent,
      absenceDay: cells[5].textContent
    });
  });
  const csv = arrayToCsv(headers, rows);
  downloadBlob(csv, `attendance_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
});

document.getElementById('exportAttendanceDoc').addEventListener('click', ()=>{
  // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±
  const visibleRows = Array.from(document.querySelectorAll('#attendanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const title='ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨'; 
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body><h2 style="text-align:center">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3 style="text-align:center">${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p><table><thead><tr><th>#</th><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</th><th>ÙŠÙˆÙ… Ø§Ù„ØªØºÙŠØ¨</th></tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td><td>${escapeHtml(cells[5].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  downloadBlob(html, `attendance_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
});

document.getElementById('printAttendanceBtn').addEventListener('click', ()=>{
  // Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±
  const visibleRows = Array.from(document.querySelectorAll('#attendanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
  
  const title='ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØºÙŠØ§Ø¨'; 
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3>${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
  html += `<table><thead><tr><th>#</th><th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØºÙŠØ¨</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…</th><th>ÙŠÙˆÙ… Ø§Ù„ØªØºÙŠØ¨</th></tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td><td>${escapeHtml(cells[5].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  const w=window.open('','_blank'); 
  w.document.write(html); 
  w.document.close(); 
  setTimeout(()=>w.print(),300);
});

/* filters */
document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
document.getElementById('clearFiltersBtn').addEventListener('click', ()=>{ 
  document.getElementById('search').value=''; 
  document.getElementById('filterStatus').value=''; 
  document.getElementById('dateFromFault').value=''; 
  document.getElementById('dateToFault').value=''; 
  applyFilters(); 
});

function applyFilters(){
  const q = (document.getElementById('search').value||'').toLowerCase();
  const st = (document.getElementById('filterStatus').value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromFault').value;
  const dateTo = document.getElementById('dateToFault').value;
  
  // Filter table view
  document.querySelectorAll('#faultTable tbody tr').forEach(tr=>{
    const text = tr.innerText.toLowerCase();
    const cells = tr.querySelectorAll('td');
    const rowDate = cells[6]?.textContent || ''; // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ 6
    
    const dateMatch = (!dateFrom || !dateTo || (rowDate >= dateFrom && rowDate <= dateTo));
    tr.style.display = ((!q || text.includes(q)) && (!st || text.includes(st)) && dateMatch) ? '' : 'none';
  });
  
  // Filter card view
  document.querySelectorAll('#faultCards .fault-card').forEach(card=>{
    const text = card.innerText.toLowerCase();
    const dateText = Array.from(card.querySelectorAll('.fault-card-row')).find(row => row.textContent.includes('Ø§Ù„ØªØ§Ø±ÙŠØ®'))?.textContent || '';
    const rowDate = dateText.replace('Ø§Ù„ØªØ§Ø±ÙŠØ®', '').trim();
    
    const dateMatch = (!dateFrom || !dateTo || (rowDate >= dateFrom && rowDate <= dateTo));
    card.style.display = ((!q || text.includes(q)) && (!st || text.includes(st)) && dateMatch) ? '' : 'none';
  });
}

// Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
document.getElementById('applyDateFilterFaultBtn')?.addEventListener('click', applyFilters);

/* order filter */
document.getElementById('applyOrderFilterBtn').addEventListener('click', applyOrderFilters);
function applyOrderFilters(){ 
  const q=(document.getElementById('searchOrder').value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromOrder').value;
  const dateTo = document.getElementById('dateToOrder').value;
  
  // Filter table view
  document.querySelectorAll('#orderTable tbody tr').forEach(tr=>{
    const text = tr.innerText.toLowerCase();
    const cells = tr.querySelectorAll('td');
    const rowDate = cells[2]?.textContent || ''; // Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ 2
    
    const dateMatch = (!dateFrom || !dateTo || (rowDate >= dateFrom && rowDate <= dateTo));
    tr.style.display = (!q || text.toLowerCase().includes(q)) && dateMatch ? '' : 'none';
  });
  
  // Filter card view
  document.querySelectorAll('#orderCards .order-card').forEach(card=>{
    const text = card.innerText.toLowerCase();
    const dateText = Array.from(card.querySelectorAll('.order-card-row')).find(row => row.textContent.includes('Ø§Ù„ØªØ§Ø±ÙŠØ®'))?.textContent || '';
    const rowDate = dateText.replace('Ø§Ù„ØªØ§Ø±ÙŠØ®', '').trim();
    
    const dateMatch = (!dateFrom || !dateTo || (rowDate >= dateFrom && rowDate <= dateTo));
    card.style.display = (!q || text.includes(q)) && dateMatch ? '' : 'none';
  });
}

// Ø¯Ø§Ù„Ø© Ù…Ù†ÙØµÙ„Ø© Ù„ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø·
document.getElementById('applyDateFilterOrderBtn')?.addEventListener('click', applyOrderFilters);

/* exports: CSV and Word (table) and print */
function arrayToCsv(headers, rows){
  const esc = v => `"${String(v||'').replace(/"/g,'""')}"`;
  const lines = [headers.map(esc).join(',')].concat(rows.map(r=>headers.map(h=>esc(r[h])).join(',')));
  return lines.join('\r\n');
}
function downloadBlob(content, filename, type){
  const blob = new Blob([content], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
}

/* Faults exports (filtered only) */
document.getElementById('exportCsvAll').addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#faultTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const headers = ['#','machine','line','person','description','shift','date','lcode','partName','partQty','status'];
  const rows = [];
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    rows.push({
      '#': i+1,
      machine: cells[1].textContent,
      line: cells[2].textContent,
      person: cells[3].textContent,
      description: cells[4].textContent,
      shift: cells[5].textContent,
      date: cells[6].textContent,
      lcode: cells[7].textContent,
      partName: cells[8].textContent,
      partQty: cells[9].textContent,
      status: cells[10].textContent
    });
  });
  const csv = arrayToCsv(headers, rows);
  downloadBlob(csv, `faults_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
});

/* Word export as table (filtered faults only) */
document.getElementById('exportDocAll').addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#faultTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const title = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¹Ø·Ø§Ù„';
  const headers = ['#','Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©','Ø§Ù„Ø®Ø·','Ø§Ù„Ù‚Ø§Ø¦Ù…','Ø§Ù„ÙˆØµÙ','Ø§Ù„ÙˆØ±Ø¯ÙŠØ©','Ø§Ù„ØªØ§Ø±ÙŠØ®','L Number','Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©','Ø§Ù„ÙƒÙ…ÙŠØ©','Ø§Ù„Ø­Ø§Ù„Ø©'];
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body><h2 style="text-align:center">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3 style="text-align:center">${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p><table><thead><tr>${headers.map(h=>'<th>'+h+'</th>').join('')}</tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=>{
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td><td>${escapeHtml(cells[5].textContent)}</td><td>${escapeHtml(cells[6].textContent)}</td><td>${escapeHtml(cells[7].textContent)}</td><td>${escapeHtml(cells[8].textContent)}</td><td>${escapeHtml(cells[9].textContent)}</td><td>${escapeHtml(cells[10].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  downloadBlob(html, `faults_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
});

/* Print/PDF (opens printable window with filtered table only) */
document.getElementById('printPdfAll').addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#faultTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
  
  const title = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¹Ø·Ø§Ù„';
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3>${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
  html += `<table><thead><tr><th>#</th><th>Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</th><th>Ø§Ù„Ø®Ø·</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„ÙˆØ±Ø¯ÙŠØ©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>L Number</th><th>Ø§Ù„Ù‚Ø·Ø¹Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td><td>${escapeHtml(cells[5].textContent)}</td><td>${escapeHtml(cells[6].textContent)}</td><td>${escapeHtml(cells[7].textContent)}</td><td>${escapeHtml(cells[8].textContent)}</td><td>${escapeHtml(cells[9].textContent)}</td><td>${escapeHtml(cells[10].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  const w = window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=> w.print(),400);
});

/* Orders exports (filtered only) */
document.getElementById('exportOrdersCsv').addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#orderTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const headers=['#','orderNum','supplyNum','date','person','details'];
  const rows = [];
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    rows.push({
      '#': i+1,
      orderNum: cells[0].textContent,
      supplyNum: cells[1].textContent,
      date: cells[2].textContent,
      person: cells[3].textContent,
      details: cells[4].textContent
    });
  });
  const csv = arrayToCsv(headers, rows);
  downloadBlob(csv, `orders_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
});
document.getElementById('exportOrdersDoc').addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#orderTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
  
  const title='ØªÙ‚Ø±ÙŠØ± Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡';
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body><h2 style="text-align:center">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3 style="text-align:center">${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p><table><thead><tr><th>#</th><th>Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>ØªÙˆØ±ÙŠØ¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[0].textContent)}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  downloadBlob(html, `orders_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
});
document.getElementById('printOrdersBtn').addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#orderTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©'); return; }
  
  const title='ØªÙ‚Ø±ÙŠØ± Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡'; 
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ ÙˆØ£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h2><h3>${title}</h3><p>ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString()}</p></div>`;
  html += `<table><thead><tr><th>#</th><th>Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th><th>ØªÙˆØ±ÙŠØ¯</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù‚Ø§Ø¦Ù…</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[0].textContent)}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  const w=window.open('','_blank'); 
  w.document.write(html); 
  w.document.close(); 
  setTimeout(()=>w.print(),300);
});

/* dashboard */
function drawDashboard(){
  const total = faults.length;
  const done = faults.filter(f=>f.status==='ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­').length;
  const working = faults.filter(f=>f.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­').length;
  const testing = faults.filter(f=>f.status==='ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©').length;
  const waitC = faults.filter(f=>f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©').length;
  const waitP = faults.filter(f=>f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±').length;

  const tiles = document.getElementById('tiles'); tiles.innerHTML='';
  const addTile = (title,val)=> { const d=document.createElement('div'); d.className='tile'; d.innerHTML=`<h4>${title}</h4><div style="font-weight:700;font-size:20px">${val}</div>`; tiles.appendChild(d); };
  addTile('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„', total); addTile('ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­', done); addTile('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­', working); addTile('ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©', testing); addTile('Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©', waitC); addTile('Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±', waitP);

  const canvas = document.getElementById('pie'); const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
  const data = [done, working, testing, waitC, waitP]; const colors=['#8ed08e','#ffd966','#fff3b0','#ffd59e','#ffb4b4']; const labels=['ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­','ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©','Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©','Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±'];
  const cx=canvas.width/2, cy=canvas.height/2, r=Math.min(cx,cy)-20;
  let start=0; const totalSum = data.reduce((a,b)=>a+b,0);
  for(let i=0;i<data.length;i++){
    const slice = totalSum===0?0:(data[i]/totalSum)*(Math.PI*2);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle=colors[i]; ctx.arc(cx,cy,r,start,start+slice); ctx.closePath(); ctx.fill();
    start += slice;
  }
  ctx.font='13px Arial'; let ly=10; for(let i=0;i<labels.length;i++){ ctx.fillStyle=colors[i]; ctx.fillRect(10,ly,12,12); ctx.fillStyle='#000'; ctx.fillText(` ${labels[i]} (${data[i]})`, 28, ly+10); ly+=18; }
  const tbody = document.querySelector('#dashTable tbody'); tbody.innerHTML=''; labels.forEach((lab,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${lab}</td><td>${data[i]}</td>`; tbody.appendChild(tr);});
}

/* init render */
renderFaultTable(); renderOrderTable(); renderAttendanceTable(); renderTrash(); drawDashboard();

function loadFromServer() {
  // 1) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  fetch(API_URL + '?kind=faults')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      // Ù†Ø¶Ù‘Ù Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
      data.forEach(f => { if(f.date) f.date = formatDateOnly(f.date); });
      // ÙØµÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù†Ø´Ø·Ø© Ø¹Ù† Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ "Delete?"
      faults = data.filter(f => !f.deleted && f.deleted !== 'Yes' && f.deleted !== 'TRUE' && f.deleted !== true);
      const deletedFaults = data.filter(f => f.deleted === 'Yes' || f.deleted === 'TRUE' || f.deleted === true);
      
      trash.faults = deletedFaults;  // Ø­Ø· Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙÙŠ Ø§Ù„Ø³Ù„Ø©
      renderFaultTable();         // Ø§Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ù†Ø´Ø·Ø©
      renderTrash();              // Ø§Ø¹Ø±Ø¶ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
      drawDashboard();            // Ø­Ø¯Ù‘Ø« Ø§Ù„Ù€ Dashboard
      saveAll();                  // Ø§Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
    })
    .catch(err => {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø·Ø§Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±', err);
    });

  // 2) ØªØ­Ù…ÙŠÙ„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  fetch(API_URL + '?kind=orders')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      // Ù†Ø¶Ù‘Ù Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
      data.forEach(o => { if(o.date) o.date = formatDateOnly(o.date); });
      // ÙØµÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Ø´Ø·Ø© Ø¹Ù† Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ "Delete?"
      orders = data.filter(o => !o.deleted && o.deleted !== 'Yes' && o.deleted !== 'TRUE' && o.deleted !== true);
      const deletedOrders = data.filter(o => o.deleted === 'Yes' || o.deleted === 'TRUE' || o.deleted === true);
      
      trash.orders = deletedOrders;  // Ø­Ø· Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙÙŠ Ø§Ù„Ø³Ù„Ø©
      renderOrderTable();         // Ø§Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Ø´Ø·Ø©
      renderTrash();              // Ø§Ø¹Ø±Ø¶ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
      saveAll();                  // Ø§Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
    })
    .catch(err => {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±', err);
    });

  // 3) ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
  fetch(API_URL + '?kind=attendance')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      // Ù†Ø¶Ù‘Ù Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
      data.forEach(a => { if(a.absenceDate) a.absenceDate = formatDateOnly(a.absenceDate); });
      // ÙØµÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ø¹Ù† Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ "deleted"
      attendance = data.filter(a => !a.deleted && a.deleted !== 'Yes' && a.deleted !== 'TRUE' && a.deleted !== true);
      const deletedAttendance = data.filter(a => a.deleted === 'Yes' || a.deleted === 'TRUE' || a.deleted === true);
      
      trash.attendance = deletedAttendance;  // Ø­Ø· Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙÙŠ Ø§Ù„Ø³Ù„Ø©
      renderAttendanceTable();            // Ø§Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
      renderTrash();                      // Ø§Ø¹Ø±Ø¶ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
      saveAll();                          // Ø§Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§
    })
    .catch(err => {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±', err);
    });
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¹Ø¯ Ù…Ø§ Ù†Ø¹Ù…Ù„ Ø±Ù†Ø¯Ø± Ù…Ø¨Ø¯Ø¦ÙŠ Ù…Ù† localStorage (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø©)
loadFromServer();

/* implement render functions after declarations to avoid hoisting issues (redefine) */
function renderFaultTable(){ 
  const tbody = document.querySelector('#faultTable tbody'); 
  tbody.innerHTML=''; 
  const cardsDiv = document.getElementById('faultCards');
  cardsDiv.innerHTML = '';
  
  faults.forEach((f,i)=>{ 
    // Table row
    const tr=document.createElement('tr'); 
    tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(f.machine)}</td><td>${escapeHtml(f.line)}</td><td>${escapeHtml(f.person)}</td><td>${escapeHtml(f.description)}</td><td>${escapeHtml(f.shift)}</td><td>${escapeHtml(f.date)}</td><td>${escapeHtml(f.lcode)}</td><td>${escapeHtml(f.partName)}</td><td>${escapeHtml(f.partQty)}</td><td class="status-cell">${escapeHtml(f.status)}</td><td class="no-print actions"><button class="btn ghost" onclick="startEditFault('${f.id}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn" onclick="moveToTrashFault('${f.id}')">Ø­Ø°Ù</button></td>`; 
    const sc = tr.querySelector('.status-cell'); 
    if(f.status==='ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­') sc.classList.add('status-okay'); 
    else if(f.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­' || f.status==='ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©') sc.classList.add('status-working'); 
    else if(f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©') sc.classList.add('status-wait-company'); 
    else if(f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø·Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø±') sc.classList.add('status-wait-part'); 
    tbody.appendChild(tr); 
    
    // Card view for mobile
    const card = document.createElement('div');
    card.className = 'fault-card';
    const statusClass = f.status==='ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­'?'status-okay':(f.status==='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥ØµÙ„Ø§Ø­'||f.status==='ØªØ­Øª Ø§Ù„ØªØ¬Ø±Ø¨Ø©')?'status-working':(f.status==='Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ø´Ø±ÙƒØ©')?'status-wait-company':'status-wait-part';
    card.innerHTML = `
      <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">${i+1} - ${escapeHtml(f.machine)}</div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„Ø®Ø·:</div><div class="fault-card-value">${displayValue(f.line)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„Ù‚Ø§Ø¦Ù…:</div><div class="fault-card-value">${displayValue(f.person)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„ÙˆØµÙ:</div><div class="fault-card-value">${displayValue(f.description)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„ÙˆØ±Ø¯ÙŠØ©:</div><div class="fault-card-value">${displayValue(f.shift)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div><div class="fault-card-value">${displayValue(f.date)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">L Number:</div><div class="fault-card-value">${displayValue(f.lcode)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ø³Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©:</div><div class="fault-card-value">${displayValue(f.partName)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">Ø§Ù„ÙƒÙ…ÙŠØ©:</div><div class="fault-card-value">${displayValue(f.partQty)}</div></div>
      <div class="fault-card-row" style="margin-top:14px"><div class="fault-card-label">Ø§Ù„Ø­Ø§Ù„Ø©:</div><div class="fault-card-value"><div class="card-status-badge ${statusClass}">${escapeHtml(f.status)}</div></div></div>
      <div class="fault-card-actions">
        <button class="btn ghost" onclick="startEditFault('${f.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn" onclick="moveToTrashFault('${f.id}')">Ø­Ø°Ù</button>
      </div>
    `;
    cardsDiv.appendChild(card);
  }); 
  saveAll(); 
}

function renderOrderTable(){ 
  const tbody = document.querySelector('#orderTable tbody'); 
  tbody.innerHTML=''; 
  const cardsDiv = document.getElementById('orderCards');
  cardsDiv.innerHTML = '';
  
  orders.forEach((o,i)=>{ 
    // Table row
    const tr=document.createElement('tr'); 
    tr.innerHTML = `<td>${escapeHtml(o.orderNum)}</td><td>${escapeHtml(o.supplyNum)}</td><td>${escapeHtml(o.date)}</td><td>${escapeHtml(o.person)}</td><td>${escapeHtml(o.details||'')}</td><td class="no-print actions"><button class="btn ghost" onclick="startEditOrder('${o.id}')">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn" onclick="moveToTrashOrder('${o.id}')">Ø­Ø°Ù</button></td>`; 
    tbody.appendChild(tr); 
    
    // Card view for mobile
    const card = document.createElement('div');
    card.className = 'order-card';
    card.innerHTML = `
      <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">Ø£Ù…Ø± #${i+1}</div>
      <div class="order-card-row"><div class="order-card-label">Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:</div><div class="order-card-value">${displayValue(o.orderNum)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„ØªÙˆØ±ÙŠØ¯:</div><div class="order-card-value">${displayValue(o.supplyNum)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</div><div class="order-card-value">${displayValue(o.date)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„Ù‚Ø§Ø¦Ù…:</div><div class="order-card-value">${displayValue(o.person)}</div></div>
      <div class="order-card-row"><div class="order-card-label">Ø§Ù„ØªÙØ§ØµÙŠÙ„:</div><div class="order-card-value">${displayValue(o.details)}</div></div>
      <div class="order-card-actions">
        <button class="btn ghost" onclick="startEditOrder('${o.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn" onclick="moveToTrashOrder('${o.id}')">Ø­Ø°Ù</button>
      </div>
    `;
    cardsDiv.appendChild(card);
  }); 
  saveAll(); 
}

function renderTrash(){ const tf = document.querySelector('#trashFaults tbody'); tf.innerHTML=''; trash.faults.forEach((f,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1} - ${escapeHtml(f.machine)} (${escapeHtml(f.date)})</td><td class="no-print actions"><button class="btn" onclick="restoreFault('${f.id}')">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button><button class="btn ghost" onclick="permanentDeleteFault('${f.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button></td>`; tf.appendChild(tr); }); const to = document.querySelector('#trashOrders tbody'); to.innerHTML=''; trash.orders.forEach((o,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${escapeHtml(o.orderNum)} - ${escapeHtml(o.date)}</td><td class="no-print actions"><button class="btn" onclick="restoreOrder('${o.id}')">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button><button class="btn ghost" onclick="permanentDeleteOrder('${o.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button></td>`; to.appendChild(tr); }); }
function renderTrash(){
  const tf = document.querySelector('#trashFaults tbody'); tf.innerHTML=''; trash.faults.forEach((f,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1} - ${escapeHtml(f.machine)} (${escapeHtml(f.date)})</td><td class="no-print actions"><button class="btn" onclick="restoreFault('${f.id}')">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button><button class="btn ghost" onclick="permanentDeleteFault('${f.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button></td>`; tf.appendChild(tr); });
  const to = document.querySelector('#trashOrders tbody'); to.innerHTML=''; trash.orders.forEach((o,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${escapeHtml(o.orderNum)} - ${escapeHtml(o.date)}</td><td class="no-print actions"><button class="btn" onclick="restoreOrder('${o.id}')">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button><button class="btn ghost" onclick="permanentDeleteOrder('${o.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button></td>`; to.appendChild(tr); });
  const ta = document.querySelector('#trashAttendance tbody');
  if(ta){
    ta.innerHTML='';
    (trash.attendance||[]).forEach((a,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(a.workerName)} / ${escapeHtml(a.workerNum)}</td><td>${escapeHtml(a.absenceDate)}</td><td class="no-print actions"><button class="btn" onclick="restoreAttendance('${a.id}')">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button><button class="btn ghost" onclick="permanentDeleteAttendance('${a.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button></td>`;
      ta.appendChild(tr);
    });
  }
}

/* wire inputs for live filters & actions */
document.getElementById('search').addEventListener('input', applyFilters);
document.getElementById('filterStatus').addEventListener('input', applyFilters);
document.getElementById('searchOrder').addEventListener('input', applyOrderFilters);

/* ensure exports buttons exist even if no data */
document.getElementById('exportCsvAll').addEventListener('click', ()=>{ if(!faults.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return;} /* handled above */ });
document.getElementById('exportDocAll').addEventListener('click', ()=>{ if(!faults.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return;} });
document.getElementById('exportOrdersCsv').addEventListener('click', ()=>{ if(!orders.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ§Ù…Ø± Ù„Ù„ØªØµØ¯ÙŠØ±'); return;} });
document.getElementById('exportOrdersDoc').addEventListener('click', ()=>{ if(!orders.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ§Ù…Ø± Ù„Ù„ØªØµØ¯ÙŠØ±'); return;} });
document.getElementById('printPdfAll').addEventListener('click', ()=>{/* handled above */});
document.getElementById('printOrdersBtn').addEventListener('click', ()=>{/* handled above */});

/* final save */
saveAll();
</script>
</body>
</html>
