<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>نظام إدارة الأعطال والصيانة وأوامر الشراء والأجازات — الكهرباء</title>
<style>
  :root{--primary:#0A4C88;--accent:#08365F;--muted:#666}
  body{font-family:Arial, Tahoma, sans-serif;margin:0;background:#f4f6f8;color:#111}
  header{background:var(--primary);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  header h1{margin:0;font-size:18px}
  nav{display:flex;gap:6px;background:var(--accent);padding:8px}
  nav button{background:transparent;border:0;color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer}
  nav button.active{background:#0d5aa2}
  section{padding:16px}
  .box{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 6px rgba(0,0,0,0.05);margin-bottom:12px}
  label{display:block;margin-top:8px;font-size:14px}
  input,select,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box}
  input[type="date"]{font-size:14px;color:#333;min-height:40px;padding:10px}
  input[type="date"]::-webkit-calendar-picker-indicator{cursor:pointer}
  textarea{min-height:70px}
  .btn{background:var(--primary);color:#fff;border:0;padding:8px 10px;border-radius:6px;cursor:pointer}
  .btn.ghost{background:#eee;color:#111}
  .row{display:flex;gap:8px;align-items:center}
  .row .flex{flex:1}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  th,td{border:1px solid #ddd;padding:10px;text-align:right;vertical-align:top;min-height:40px}
  th{background:#0A4C88;color:#fff}
  .actions button{margin-left:6px}
  .status-okay{background:#c4f7c4}
  .status-working{background:#fff3b0}
  .status-wait-company{background:#ffd59e}
  .status-wait-part{background:#ffb4b4}
  #tiles{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .tile{flex:1 1 140px;background:#fff;padding:10px;border-radius:6px;text-align:center;box-shadow:0 1px 4px rgba(0,0,0,0.04)}
  canvas{background:#fff;border-radius:6px;padding:8px}
  /* Responsive helpers */
  .table-responsive{overflow-x:auto}
  canvas{max-width:100%;height:auto}
  /* Mobile card view */
  .card-view{display:none;margin-bottom:12px;padding:8px}
  .fault-card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.12)}
  .fault-card-row{display:flex;justify-content:space-between;margin:10px 0;padding:10px 0;font-size:13px;align-items:center;border-bottom:1px solid #f0f0f0}
  .fault-card-row:last-child{border-bottom:none}
  .fault-card-label{font-weight:600;color:#08365F;flex:0 0 35%;word-break:break-word}
  .fault-card-value{text-align:left;flex:1;word-break:break-word;padding-left:12px;color:#333}
  .fault-card-value.empty{color:#999;font-style:italic}
  .fault-card-actions{display:flex;gap:8px;margin-top:16px}
  .fault-card-actions button{flex:1;padding:8px;font-size:13px}
  .fault-card-actions button.btn{font-size:12px}
  .table-view{display:block}
  /* Order card styles */
  .order-card{background:#fff;border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.12)}
  .order-card-row{display:flex;justify-content:space-between;margin:10px 0;padding:10px 0;font-size:13px;align-items:center;border-bottom:1px solid #f0f0f0}
  .order-card-row:last-child{border-bottom:none}
  .order-card-label{font-weight:600;color:#08365F;flex:0 0 35%;word-break:break-word}
  .order-card-value{text-align:left;flex:1;word-break:break-word;padding-left:12px;color:#333}
  .order-card-value.empty{color:#999;font-style:italic}
  .order-card-actions{display:flex;gap:8px;margin-top:16px}
  .order-card-actions button{flex:1;padding:8px;font-size:13px}
  .order-card-actions button.btn{font-size:12px}
  /* Status badge styling */
  .card-status-badge{display:inline-block;padding:6px 12px;border-radius:6px;font-weight:600;font-size:12px;text-align:center;width:100%}

  @media (max-width:800px){
    header{padding:10px}
    header h1{font-size:16px}
    nav{flex-wrap:wrap}
    nav button{padding:6px 8px;font-size:14px}
    .row{flex-direction:column;align-items:stretch}
    .row .flex{order:99;height:0}
    .tile{flex:1 1 45%}
    .box{padding:10px}
    .table-responsive table{min-width:700px}
  }

  @media (max-width:600px){
    header h1{font-size:15px}
    nav button{font-size:13px;padding:6px}
    .tile{flex-basis:100%}
    .row .flex{display:block;height:auto}
    .row input[type="date"]{flex:1 !important;max-width:none !important;min-width:auto}
    /* Show cards on mobile, hide table */
    .table-view{display:none !important}
    .card-view{display:block !important}
    .home-btn{padding:8px 14px !important}
  }
  
  @media (max-width:480px){
    .fault-card-label{flex:0 0 35%}
    .fault-card-actions button{font-size:11px;padding:5px}
    .row input[type="date"]{flex:0 0 45% !important;margin:4px}
    .row label{flex:0 0 100%;margin-bottom:4px;font-size:12px}
    .row button{flex:1;margin:4px 0}
  }
  @media print{
    nav,.no-print,.actions,.controls{display:none!important}
    body{background:#fff;margin:0;padding:0;font-size:12px}
    .box,section,header{padding:0!important;margin:0!important;box-shadow:none!important}
    .summary-title{font-size:18px!important}
    .summary-desc{font-size:13px!important}
    .summary-date{font-size:12px!important}
    .summary-total{font-size:13px!important;padding:6px 0!important}
    .group-title{font-size:15px!important;padding:6px 0!important}
    .cards-wrap{flex-wrap:wrap!important;gap:8px!important}
    .summary-card{min-width:120px!important;max-width:160px!important;padding:10px 8px!important;margin-bottom:6px!important}
    .card-title{font-size:13px!important}
    .card-count{font-size:15px!important;padding:4px 8px!important}
    table{font-size:11px!important}
    th,td{padding:4px!important}
    h2,h3{font-size:15px!important;margin:4px 0!important}
    .footer{font-size:10px!important;margin-top:10px!important}
    .group-section{margin-bottom:12px!important}
    .cards-wrap,.summary-card{flex-direction:column!important;align-items:stretch!important}
  }
  /* Password modal (attendance access) */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal-overlay.active{display:flex}
  .modal{background:#fff;padding:18px;border-radius:8px;min-width:320px;max-width:92%;box-shadow:0 6px 30px rgba(0,0,0,0.25);direction:rtl;text-align:right}
  .modal h3{margin:0 0 8px;font-size:16px}
  .modal .modal-row{margin-top:8px}
  .modal input[type="password"]{width:100%;padding:8px;border:1px solid #ccc;border-radius:6px}
  .modal .modal-actions{display:flex;gap:8px;margin-top:12px;justify-content:flex-end}
  .modal .modal-actions button{padding:8px 12px;border-radius:6px;border:0;cursor:pointer}
  .modal .btn-primary{background:var(--primary);color:#fff}
  .modal .btn-ghost{background:#eee}

  /* Home fullscreen simple page */
  #page_home.home-fullscreen{min-height:calc(100vh - 0px);display:flex;align-items:center;justify-content:center;background:#fff}
  #page_home.home-fullscreen .home-inner{max-width:920px;margin:0 auto;padding:24px}
  #page_home.home-fullscreen h1{font-size:32px;margin-bottom:8px;color:var(--primary);font-weight:700}
  #page_home.home-fullscreen p.lead{color:var(--muted);margin-bottom:18px;font-size:15px}
  /* professional button list */
  #page_home .home-buttons{display:grid;grid-template-columns:1fr;gap:12px;width:360px;margin:0 auto}
  @media(min-width:760px){ #page_home .home-buttons{width:420px} }
  .home-btn{display:flex;align-items:center;gap:12px;padding:14px 18px;font-size:16px;border-radius:12px;border:1px solid rgba(10,76,136,0.08);background:#fff;box-shadow:0 6px 18px rgba(10,76,136,0.06);cursor:pointer;transition:transform .14s ease,box-shadow .14s ease}
  .home-btn:hover{transform:translateY(-6px);box-shadow:0 16px 36px rgba(10,76,136,0.12)}
  .home-btn .icon{width:44px;height:44px;display:inline-flex;align-items:center;justify-content:center;border-radius:10px;background:rgba(10,76,136,0.06);color:var(--primary);font-size:18px}
  .home-btn .label{flex:1;text-align:right;font-weight:700;color:#08365F;font-size:17px}
  .home-btn.secondary .icon{background:rgba(255,112,67,0.08);color:#ff7043}
  .home-btn.success .icon{background:rgba(76,175,80,0.08);color:#4caf50}
  .home-btn.info .icon{background:rgba(0,151,167,0.08);color:#0097a7}
  .home-btn.ghost{background:#fafafa}
  .home-btn.contrast .label{color:#fff}
  .home-btn.contrast .icon{background:rgba(255,255,255,0.12);color:#fff}
  /* Mobile tweaks: larger touch targets and spacing */
  @media(max-width:420px){
    #page_home.home-fullscreen{padding:20px}
    #page_home .home-inner{padding:8px}
    #page_home .home-buttons{gap:14px;width:100%}
    .home-btn{padding:18px 16px;font-size:18px;border-radius:12px}
    .home-btn .icon{width:46px;height:46px}
    .home-btn .label{font-size:17px}
  }
  /* Mobile-only entry animations for home buttons */
  @media(max-width:420px){
    .home-btn{opacity:0;transform:translateY(12px)}
    @keyframes fadeUpMobile{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    #page_home .home-buttons .home-btn:nth-child(1){animation:fadeUpMobile .42s ease .08s forwards}
    #page_home .home-buttons .home-btn:nth-child(2){animation:fadeUpMobile .42s ease .14s forwards}
    #page_home .home-buttons .home-btn:nth-child(3){animation:fadeUpMobile .42s ease .20s forwards}
    #page_home .home-buttons .home-btn:nth-child(4){animation:fadeUpMobile .42s ease .26s forwards}
    #page_home .home-buttons .home-btn:nth-child(5){animation:fadeUpMobile .42s ease .32s forwards}
  }
</style>
</head>
<body>
<header>
  <h1>نظام إدارة الأعطال والصيانة وأوامر الشراء والأجازات — الكهرباء</h1>
  <div style="font-size:13px;color:#fff">وضع أونلاين</div>
</header>

<nav>
  <button id="navHome">الرئيسية</button>
  <button id="navFaults">الأعطال</button>
  <button id="navMaintenance">الصيانة</button>
  <button id="navOrders">أوامر الشراء</button>
  <button id="navAttendance">الأجازات</button>
  <button id="navTrash">سلة المحذوفات</button>
  <button id="navDash">Dashboard</button>
</nav>

<section>
  <div id="page_home" class="page home-fullscreen">
    <div class="home-inner">
      <h1 style="margin:0 0 12px;text-align:center;color:var(--primary)">نظام إدارة الأعطال والصيانة وأوامر الشراء والأجازات (الكهرباء)</h1>
      <p class="lead" style="text-align:center;margin:0 0 20px;color:var(--muted)">اختر القسم للبدء</p>
      <div class="home-buttons">
        <button class="btn home-btn contrast" style="background:#e53935" onclick="show('faults');setTimeout(()=>showLatestFaultNotification(),350)">
          <span class="icon" aria-hidden>
            <!-- Original Warning / Fault SVG -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M1 21h22L12 2 1 21z" fill="#fff"/><path d="M13 16h-2v2h2v-2zm0-8h-2v6h2V8z" fill="#000"/></svg>
          </span>
          <span class="label">الأعطال</span>
        </button>
        <button class="btn home-btn secondary" style="background:#ff7043" onclick="show('maintenance');setTimeout(()=>showLatestMaintenanceNotification(),350)">
          <span class="icon" aria-hidden>
            <!-- Original Wrench / Maintenance SVG -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22.7 19.3l-2-2c-.4-.4-1-.4-1.4 0l-1.1 1.1c-1.3-.5-2.7-1-4-1.6l.7-1.7-6.1-6.1-1.7.7c-.6-1.3-1.1-2.7-1.6-4L7.6 4c.2-.6.1-1.2-.4-1.7L4.2.9C3.8.5 3.2.5 2.8.9L1.3 2.4C.9 2.8.8 3.4 1 3.9c1.2 4 2.5 7.9 3.7 11.9 1.2 3.9 4.3 7 8.2 8.2 4 .2 7.9-1 11.9-3.7.5-.2.8-.8.4-1.2l-1.5-1.5c-.5-.4-1.1-.4-1.5 0l-1.6 1.6c-.5.5-1.1.4-1.5 0z" fill="#fff"/></svg>
          </span>
          <span class="label">الصيانة</span>
        </button>
        <button class="btn home-btn success" style="background:#4caf50" onclick="show('orders');setTimeout(()=>showLatestOrderNotification(),350)">
          <span class="icon" aria-hidden>
            <!-- Original Cart / Orders SVG -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 4h-2l-1 2h2l1-2zm0 0h10l1.2 6H6.8L7 4zM6 20a2 2 0 100-4 2 2 0 000 4zm10 0a2 2 0 100-4 2 2 0 000 4z" fill="#fff"/></svg>
          </span>
          <span class="label">أوامر الشراء</span>
        </button>
        <button class="btn home-btn info" style="background:#0097a7" onclick="show('attendance');setTimeout(()=>showLatestAttendanceNotification(),350)">
          <span class="icon" aria-hidden>
            <!-- Original Calendar / Attendance SVG -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 10h5v5H7z" fill="#fff"/><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v13a2 2 0 002 2h14a2 2 0 002-2V6c0-1.1-.9-2-2-2z" fill="#fff"/></svg>
          </span>
          <span class="label">الأجازات</span>
        </button>
        <button class="btn home-btn contrast" style="background:#3949ab" onclick="show('dash');">
          <span class="icon" aria-hidden>
            <!-- Original Chart / Dashboard SVG -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 13h4v8H3v-8zm6-6h4v14h-4V7zm6-4h4v18h-4V3z" fill="#fff"/></svg>
          </span>
          <span class="label">Dashboard</span>
        </button>
      </div>
    </div>
  </div>
  <!-- FAULTS -->
  <div id="page_faults" class="page">
    <div class="box">
      <h3>تسجيل / تعديل عطل</h3>
      <div id="form">
        <label>مكان الماكينة</label>
        <select id="machineGroup">
          <option value="">اختر مكان الماكينة</option>
        </select>
        <div id="machineItemContainer">
          <label style="margin-top:6px">الماكينة</label>
          <select id="machineItem" disabled>
            <option value="">اختر الماكينة</option>
          </select>
        </div>
        <div id="customMachineGroupContainer" style="display:none">          
          <div id="customMachinePlaceContainer">
            <label style="margin-top:6px">مكان الماكينة</label>
            <input type="text" id="customMachinePlace" placeholder="أدخل مكان الماكينة" />
          </div>
          <label style="margin-top:6px">اسم الماكينة</label>
          <input type="text" id="customMachineName" placeholder="أدخل اسم الماكينة" />
        </div>
        <label>اسم القائم بالعطل</label>
        <div class="row" style="align-items:center;gap:8px">
          <button type="button" id="personToggle" class="btn ghost" style="width:auto">اختر القائم(ين)</button>
          <div id="personChips" style="min-height:28px;display:inline-block"></div>
        </div>
        <select id="person" multiple required style="min-height:80px;display:none;margin-top:6px">
          <option value="">اختر اسم</option>
                  <option>حسن مسعد</option>
                  <option>محمد جودة</option>
                  <option>احمد علي</option>
                  <option>علي مرسي</option>
                  <option>عمر حمزة</option>
                  <option>محمد البديوي</option>
                  <option>احمد خالد</option>
                  <option>حسن بهاء</option>
                  <option>عبدالله وائل</option>
                  <option>معاذ كمال</option>
                  <option>اسلام مصطفي سمير</option>
                  <option>محمد صبحي</option>
                  <option>محمود ناجي</option>
                  <option>محمد احمد</option>
                  <option>محمود عبدالحكيم</option>
                  <option>اسلام محمد احمد</option>
                </select>
        <label>وصف العطل</label><textarea id="description"placeholder="شرح وصف  العطل"></textarea>
        <label>حل العطل</label><textarea id="solution" placeholder="شرح حل العطل"></textarea>
        <label>الوردية</label><select id="shift"><option>صباحية</option><option>مسائية</option><option>ليلية</option></select>
        <label>التاريخ</label><input type="date" id="date" required />
        <label>هل تم تغيير قطعة غيار؟</label>
        <select id="partChanged">
          <option value="no">لا</option>
          <option value="yes">نعم</option>
        </select>
        <div id="partFieldsContainer" style="display:none">
          <label>كود المخزن (L Number)</label><input id="lcode" />
          <label>اسم قطعة الغيار</label><input id="partName" placeholder="أسم قطعة الغيار" />
          <label>كمية قطعة الغيار</label><input type="number" id="partQty" min="0" value="0" />
        </div>
        <label>حالة العطل</label>
        <select id="status">
          <option>تم الإصلاح</option>
          <option>جاري الإصلاح</option>
          <option>تحت التجربة</option>
          <option>بانتظار رد الشركة</option>
          <option>بانتظار قطعة الغيار</option>
        </select>
        <div class="row" style="margin-top:10px">
          <button id="addBtn" class="btn">إضافة العطل</button>
          <button class="btn ghost" id="clearBtn">مسح الحقول</button>
          <div class="flex"></div>
          <button class="btn" id="exportCsvAll">تصدير CSV</button>
          <button class="btn" id="exportDocAll">تصدير Word</button>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="row" style="margin-bottom:8px">
        <input id="search" placeholder="بحث باسم الماكينة، وصف، القائم…" style="flex:1" />
        <input id="filterStatus" placeholder="فلتر الحالة (مثال: تم الإصلاح)" style="width:220px;max-width:40%" />
        <button class="btn ghost" id="applyFiltersBtn">تطبيق</button>
        <button class="btn ghost" id="clearFiltersBtn">إعادة</button>
      </div>
      <div class="row" style="margin-bottom:8px;flex-wrap:wrap">
        <label style="margin:0;flex:0 0 auto;padding-right:8px;min-width:80px">من التاريخ:</label>
        <input type="date" id="dateFromFault" style="flex:1;min-width:120px;margin:0 4px" />
        <label style="margin:0;flex:0 0 auto;padding-right:8px;padding-left:8px;min-width:80px">إلى التاريخ:</label>
        <input type="date" id="dateToFault" style="flex:1;min-width:120px;margin:0 4px" />
        <button class="btn ghost" id="applyDateFilterFaultBtn" style="flex:0 0 auto;margin:0 4px">بحث بالتاريخ</button>
        <div class="flex"></div>
      </div>

      <div class="table-view">
      <div class="table-responsive">
      <table id="faultTable">
        <thead>
          <tr>
            <th>#</th><th>الماكينة</th><th>الخط</th><th>القائم</th><th>الوصف</th><th>حل العطل</th><th>الوردية</th><th>التاريخ</th><th>L Number</th><th>اسم القطعة</th><th>الكمية</th><th>الحالة</th><th class="no-print">أوامر</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      <div id="faultCards" class="card-view"></div>

      <div id="faultsPagination" style="margin-top:12px; text-align:center; display:flex; gap:6px; justify-content:center; flex-wrap:wrap"></div>

      <!-- print / PDF buttons -->
      <div style="margin-top:10px; text-align:left; display:flex; gap:8px;">
        <button class="btn" id="printPdfCurrentPage">طباعة الصفحة الحالية</button>
        <button class="btn" style="background:#0077b6" id="printPdfAll">طباعة الكل</button>
        <button class="btn" style="background:#009688" id="printFaultsSummaryBtn">طباعة ملخص الأعطال</button>
      </div>
    </div>
  </div>

  <!-- MAINTENANCE -->
  <div id="page_maintenance" class="page" style="display:none">
    <div class="box">
      <h3>تسجيل / تعديل صيانة</h3>
      <div id="maintenanceForm">
        <label>مكان الماكينة</label>
        <select id="mainGroup">
          <option value="">اختر مكان الماكينة</option>
        </select>
        <div id="mainItemContainer">
          <label style="margin-top:6px">الماكينة</label>
          <select id="mainItem" disabled>
            <option value="">اختر الماكينة</option>
          </select>
        </div>
        <div id="customMainGroupContainer" style="display:none">
          <div id="customMainPlaceContainer">
            <label style="margin-top:6px">مكان الماكينة</label>
            <input type="text" id="customMainPlace" placeholder="أدخل مكان الماكينة" />
          </div>
          <label style="margin-top:6px">اسم الماكينة</label>
          <input type="text" id="customMainName" placeholder="أدخل اسم الماكينة" />
        </div>
        <label>اسم القائم بالصيانة</label>
        <div class="row" style="align-items:center;gap:8px">
          <button type="button" id="mainPersonToggle" class="btn ghost" style="width:auto">اختر القائم(ين)</button>
          <div id="mainPersonChips" style="min-height:28px;display:inline-block"></div>
        </div>
        <select id="mainPerson" multiple style="min-height:80px;display:none;margin-top:6px">
          <option value="">اختر اسم</option>
                  <option>KBA Egypt</option>
                  <option>CBE Team</option>
                  <option>عمر حمزة</option>
                  <option>محمد البديوي</option>
                  <option>احمد خالد</option>
                  <option>حسن بهاء</option>
                  <option>عبدالله وائل</option>
                  <option>معاذ كمال</option>
                  <option>اسلام مصطفي سمير</option>
                  <option>محمد صبحي</option>
                  <option>محمود ناجي</option>
                  <option>محمد احمد</option>
                  <option>محمود عبدالحكيم</option>
                  <option>اسلام محمد احمد</option>
                  
                </select>
        <label>التاريخ</label><input type="date" id="mainDate" required />
       <label>هل تم تغيير قطعة غيار؟</label>
        <select id="mainPartChanged">
          <option value="no">لا</option>
          <option value="yes">نعم</option>
        </select>
        <div id="mainPartFieldsContainer" style="display:none">
          <label>كود المخزن (L Number)</label><input id="mainLcode" />
          <label>اسم قطعة الغيار</label><input id="mainPartName" placeholder="اسم قعة الغيار" />
          <label>كمية قطعة الغيار</label><input type="number" id="mainPartQty" min="0" value="0" />
        </div>
        <label>نوع الصيانة</label>
        <select id="mainType">
          <option>أسبوعية</option>
          <option>شهرية</option>
          <option>ربع سنوي</option>
          <option>سنوية</option>
          <option>طارئة</option>
        </select>
        <label>ملاحظات</label><textarea id="mainNotes" placeholder="ملاحظات أو وصف الصيانة"></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="addMaintenanceBtn">إضافة صيانة</button>
          <button class="btn ghost" id="clearMaintenanceBtn">مسح الحقول</button>
          <div class="flex"></div>
          <button class="btn" id="exportMaintenanceCsv">تصدير CSV</button>
          <button class="btn" id="exportMaintenanceDoc">تصدير Word</button>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="row" style="margin-bottom:8px">
        <input id="searchMaintenance" placeholder="بحث باسم الماكينة أو القائم…" style="flex:1" />
        <button class="btn ghost" id="applyMaintenanceFilterBtn">تطبيق</button>
      </div>
      <div class="row" style="margin-bottom:8px;flex-wrap:wrap">
        <label style="margin:0;flex:0 0 auto;padding-right:8px;min-width:80px">من التاريخ:</label>
        <input type="date" id="dateFromMaintenance" style="flex:1;min-width:120px;margin:0 4px" />
        <label style="margin:0;flex:0 0 auto;padding-right:8px;padding-left:8px;min-width:80px">إلى التاريخ:</label>
        <input type="date" id="dateToMaintenance" style="flex:1;min-width:120px;margin:0 4px" />
        <button class="btn ghost" id="applyDateFilterMaintenanceBtn" style="flex:0 0 auto;margin:0 4px">بحث بالتاريخ</button>
        <div class="flex"></div>
      </div>

      <div class="table-view">
      <div class="table-responsive">
      <table id="maintenanceTable">
        <thead>
          <tr>
            <th>#</th><th>الماكينة</th><th>الخط</th><th>القائم</th><th>التاريخ</th><th>L Number</th><th>القطعة</th><th>الكمية</th><th>النوع</th><th>الملاحظات</th><th class="no-print">أوامر</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      <div id="maintenanceCards" class="card-view"></div>

      <div id="maintenancePagination" style="margin-top:12px; text-align:center; display:flex; gap:6px; justify-content:center; flex-wrap:wrap"></div>

      <div style="margin-top:10px; text-align:left; display:flex; gap:8px;">
        <button class="btn" id="printMaintenanceCurrentPage">طباعة الصفحة الحالية</button>
        <button class="btn" style="background:#0077b6" id="printMaintenanceBtn">طباعة الكل</button>
        <button class="btn" style="background:#009688" id="printMaintenanceSummaryBtn">طباعة ملخص الصيانات</button>
      </div>
    </div>
  </div>

  <!-- ORDERS -->
  <div id="page_orders" class="page" style="display:none">
    <div class="box">
      <h3>أمر شراء / توريد</h3>
      <label>رقم أمر الشراء</label><input id="orderNum" />
      <label>رقم أمر التوريد</label><input id="supplyNum" />
      <label>التاريخ</label><input type="date" id="orderDate" required />
      <label>القائم على أمر الشراء</label>
        <div class="row" style="align-items:center;gap:8px">
          <button type="button" id="orderPersonToggle" class="btn ghost" style="width:auto">اختر القائم(ين)</button>
          <div id="orderPersonChips" style="min-height:28px;display:inline-block"></div>
        </div>
        <select id="orderPerson" multiple style="min-height:80px;display:none;margin-top:6px">
          <option value="">اختر اسم</option>
                  <option>حسن مسعد</option>
                  <option>محمد جودة</option>
                  <option>احمد علي</option>
                  <option>علي مرسي</option>
                  <option>عمر حمزة</option>
                  <option>محمد البديوي</option>
                  <option>احمد خالد</option>
                  <option>حسن بهاء</option>
                  <option>عبدالله وائل</option>
                  <option>معاذ كمال</option>
                  <option>اسلام مصطفي سمير</option>
                  <option>محمد صبحي</option>
                  <option>محمود ناجي</option>
                  <option>محمد احمد</option>
                  <option>محمود عبدالحكيم</option>
                  <option>اسلام محمد احمد</option>
                </select>
      <label>تفاصيل أمر الشراء</label><textarea id="orderDetails" placeholder="تفاصيل أو وصف أمر الشراء"></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="addOrderBtn">إضافة أمر</button>
        <button class="btn ghost" id="clearOrderBtn">مسح</button>
        <div class="flex"></div>
        <button class="btn" id="exportOrdersCsv">تصدير CSV</button>
        <button class="btn" id="exportOrdersDoc">تصدير Word</button>
      </div>
    </div>

    <div class="box">
      <div class="row" style="margin-bottom:8px">
        <input id="searchOrder" placeholder="بحث برقم الأمر أو القائم…" style="flex:1" />
        <button class="btn ghost" id="applyOrderFilterBtn">تطبيق</button>
      </div>
      <div class="row" style="margin-bottom:8px;flex-wrap:wrap">
        <label style="margin:0;flex:0 0 auto;padding-right:8px;min-width:80px">من التاريخ:</label>
        <input type="date" id="dateFromOrder" style="flex:1;min-width:120px;margin:0 4px" />
        <label style="margin:0;flex:0 0 auto;padding-right:8px;padding-left:8px;min-width:80px">إلى التاريخ:</label>
        <input type="date" id="dateToOrder" style="flex:1;min-width:120px;margin:0 4px" />
        <button class="btn ghost" id="applyDateFilterOrderBtn" style="flex:0 0 auto;margin:0 4px">بحث بالتاريخ</button>
        <div class="flex"></div>
      </div>
      <div class="table-view">
      <div class="table-responsive">
      <table id="orderTable">
        <thead><tr><th>أمر الشراء</th><th>توريد</th><th>التاريخ</th><th>القائم</th><th>تفاصيل الأمر</th><th class="no-print">أوامر</th></tr></thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      <div id="orderCards" class="card-view"></div>

      <div id="ordersPagination" style="margin-top:12px; text-align:center; display:flex; gap:6px; justify-content:center; flex-wrap:wrap"></div>

      <!-- print / PDF buttons -->
      <div style="margin-top:10px; text-align:left; display:flex; gap:8px;">
        <button class="btn" id="printOrdersCurrentPage">طباعة الصفحة الحالية</button>
        <button class="btn" style="background:#0077b6" id="printOrdersBtn">طباعة الكل</button>
      </div>
    </div>
  </div>

  <!-- ATTENDANCE -->
  <div id="page_attendance" class="page" style="display:none">
    <div class="box">
      <h3>سجل الغياب</h3>
      <div id="attendanceForm">
        <label>اسم العامل</label>
        <select id="workerName">
          <option value="">اختر اسم العامل</option>
          <option value="عمر حمزة">عمر حمزة</option>
          <option value="محمد البديوي">محمد البديوي</option>
          <option value="احمد خالد">احمد خالد</option>
          <option value="حسن بهاء">حسن بهاء</option>
          <option value="عبدالله وائل">عبدالله وائل</option>
          <option value="معاذ كمال">معاذ كمال</option>
          <option value="إسلام مصطفي سمير">إسلام مصطفي سمير</option>
          <option value="محمد صبحي">محمد صبحي</option>
          <option value="محمود ناجي">محمود ناجي</option>
          <option value="محمد احمد">محمد احمد</option>
          <option value="محمود عبدالحكيم">محمود عبدالحكيم</option>
          <option value="اسلام محمد احمد">اسلام محمد احمد</option>
        </select>
        <label>رقم العامل</label><input id="workerNum" disabled />
        <label>تاريخ بداية الأجازة</label><input type="date" id="absenceDate" required />
        <label>عدد أيام الأجازة</label><input type="number" id="daysCount" min="1" value="1" />
        <label>نوع الاجازة</label>
        <select id="vacationType" required>
          <option value="">اختر نوع الاجازة</option>
          <option value="اجازة اعتيادي">اجازة اعتيادي</option>
          <option value="خمسة متصلين">خمسة متصلين</option>
          <option value="بدل راحة">بدل راحة</option>
          <option value="مأمورية">مأمورية</option>
          <option value="مرضي خدمة ذاتية 12 يوم">مرضي خدمة ذاتية 12 يوم</option>
          <option value="رصيد مرحل من السنة اللي فاتت">رصيد مرحل من السنة اللي فاتت</option>
        </select>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="addAttendanceBtn">إضافة سجل</button>
          <button class="btn ghost" id="clearAttendanceBtn">مسح الحقول</button>
          <div class="flex"></div>
          <button class="btn" id="exportAttendanceCsv">تصدير CSV</button>
          <button class="btn" id="exportAttendanceDoc">تصدير Word</button>
        </div>
      </div>
    </div>

    <div class="box">
      <div class="row" style="margin-bottom:8px">
        <input id="searchAttendance" placeholder="بحث باسم العامل أو الرقم…" style="flex:1" />
        <button class="btn ghost" id="applyAttendanceFilterBtn">تطبيق</button>
      </div>
      <div id="attendanceSummary" style="margin:8px 0;font-weight:600;display:none"></div>
      <div class="row" style="margin-bottom:8px;flex-wrap:wrap">
        <label style="margin:0;flex:0 0 auto;padding-right:8px;min-width:80px">من التاريخ:</label>
        <input type="date" id="dateFromAttendance" style="flex:1;min-width:120px;margin:0 4px" />
        <label style="margin:0;flex:0 0 auto;padding-right:8px;padding-left:8px;min-width:80px">إلى التاريخ:</label>
        <input type="date" id="dateToAttendance" style="flex:1;min-width:120px;margin:0 4px" />
        <button class="btn ghost" id="applyDateFilterAttendanceBtn" style="flex:0 0 auto;margin:0 4px">بحث بالتاريخ</button>
        <div class="flex"></div>
      </div>
      <div class="table-view">
      <div class="table-responsive">
      <table id="attendanceTable">
        <thead>
          <tr>
            <th>#</th><th>اسم العامل</th><th>رقم العامل</th><th>تاريخ التغيب</th><th>عدد الأيام</th><th>يوم التغيب</th><th>نوع الاجازة</th><th class="no-print">أوامر</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      </div>
      <div id="attendanceCards" class="card-view"></div>

      <!-- Password modal for attendance cards (keeps cards hidden unless unlocked) -->
      <div id="attendancePasswordModal" class="modal-overlay" aria-hidden="true" role="dialog">
        <div class="modal" role="document" aria-labelledby="attendancePasswordTitle">
          <h3 id="attendancePasswordTitle">فتح عرض سجلات الأجازات</h3>
          <div class="modal-row">ادخل كلمة المرور لعرض بطاقات الأجازات.</div>
          <div class="modal-row"><input id="attendancePasswordInput" type="password" placeholder="كلمة المرور" /></div>
          <div class="modal-actions">
            <button id="attendancePasswordCancel" class="btn btn-ghost">إلغاء</button>
            <button id="attendancePasswordSubmit" class="btn btn-primary">فتح</button>
          </div>
        </div>
      </div>

      <div id="attendancePagination" style="margin-top:12px; text-align:center; display:flex; gap:6px; justify-content:center; flex-wrap:wrap"></div>

      <div style="margin-top:10px; text-align:left; display:flex; gap:8px;">
        <button class="btn" id="printAttendanceCurrentPage">طباعة الصفحة الحالية</button>
        <button class="btn" style="background:#0077b6" id="printAttendanceBtn">طباعة الكل</button>
      </div>
    </div>
  </div>

  <!-- TRASH -->
  <div id="page_trash" class="page" style="display:none">
    <div class="box">
      <h3>سلة المحذوفات</h3>
      <div style="margin-bottom:8px">
        <button class="btn ghost" id="emptyTrashBtn">حذف نهائي لكل المحذوفات</button>
      </div>
      <h4>أعطال محذوفة</h4>
      <div class="table-responsive">
      <table id="trashFaults"><thead><tr><th>#</th><th>بيان</th><th class="no-print">أوامر</th></tr></thead><tbody></tbody></table>
      </div>
      <h4 style="margin-top:12px">أوامر محذوفة</h4>
      <div class="table-responsive">
      <table id="trashOrders"><thead><tr><th>أمر</th><th>توريد</th><th class="no-print">أوامر</th></tr></thead><tbody></tbody></table>
      </div>
      <h4 style="margin-top:12px">سجلات الغياب المحذوفة</h4>
      <div class="table-responsive">
      <table id="trashAttendance"><thead><tr><th>#</th><th>اسم العامل / رقم</th><th>تاريخ التغيب</th><th class="no-print">أوامر</th></tr></thead><tbody></tbody></table>
      </div>
      <h4 style="margin-top:12px">سجلات الصيانة المحذوفة</h4>
      <div class="table-responsive">
      <table id="trashMaintenance"><thead><tr><th>#</th><th>بيان</th><th class="no-print">أوامر</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="page_dash" class="page" style="display:none">
    <div id="tiles" style="margin-bottom:12px"></div>
    <input type="hidden" id="filterMaintenanceType" value="" />
    <div class="box" style="max-width:800px;margin:0 auto">
      <canvas id="pie" width="800" height="300"></canvas>
      <div style="margin-top:12px">
        <div class="table-responsive">
        <table id="dashTable" style="width:100%"><thead><tr><th>الحالة</th><th>العدد</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
/* ╔════════════════════════════════════════════════════════════════╗
   ║         نظام إدارة الأعطال والصيانة وأوامر الشراء والأجازات    ║
   ║                                                                ║
   ║  ملخص الأقسام الرئيسية للكود:                                   ║
   ║  ─────────────────────────────────────────────────────────── ║
   ║  1. إعداد الـ API والمتغيرات الأساسية                         ║
   ║  2. خريطة أسماء العمال وأرقامهم                               ║
   ║  3. تحميل البيانات من التخزين المحلي                         ║
   ║  4. دوال مساعدة للترقيم والمعالجة الأساسية                    ║
   ║  5. دوال مساعدة عامة (uid, تنسيق التاريخ، etc)               ║
   ║  6. دوال اختيار وإدارة قوائم الماكينات                       ║
   ║  7. عمليات CRUD للأعطال                                      ║
   ║  8. عمليات CRUD لأوامر الشراء                                 ║
   ║  9. عمليات CRUD للصيانة                                      ║
   ║  10. تصفية وفلترة سجلات الصيانة                              ║
   ║  11. إدارة سلة المحذوفات والتصديرات                          ║
   ║  12. عمليات CRUD وتصدير سجلات الأجازات والحضور               ║
   ║  13. فلترة البحث والتصفية للأعطال والأوامر                   ║
   ║  14. دوال التصدير والطباعة (CSV, Word, PDF)                 ║
   ║  15. لوحة التحكم والإحصائيات                                 ║
   ║  16. الإنشاء والتهيئة الأولية                                ║
   ║  17. دوال الرسم والتصيير (Render) الرئيسية                   ║
   ║  18. ربط أزرار وحقول الإدخال مع أحداث البحث والفلترة         ║
   ║                                                                ║
   ║  الملاحظة: جميع الدوال محفوظة وتعمل كما هي — لم نغير أي       ║
   ║  منطق، فقط أضفنا تقسيمات تنظيمية للقراءة الأسهل              ║
   ╚════════════════════════════════════════════════════════════════╝
*/

// ═════════════════════════════════════════════════════════════════
// 1. إعداد الـ API والمتغيرات الأساسية
// ═════════════════════════════════════════════════════════════════
const API_URL = 'https://script.google.com/macros/s/AKfycbyUCz69cQVqmsZ3wUFXt4HElNOEMnh-gzghZBX6YbpzOcf4RdX-j78min8OPKUwCCA/exec';

/* storage keys */
const K_FAULTS='faults_v2_final', K_ORDERS='orders_v2_final', K_TRASH='trash_v2_final', K_ATT='attendance_v1', K_MAINTENANCE='maintenance_v1';
// ═════════════════════════════════════════════════════════════════
// 2. خريطة أسماء العمال وأرقامهم
// ═════════════════════════════════════════════════════════════════
// worker name → worker number mapping (persisted)
const K_WORKERS = 'worker_map_v1';
let WORKER_MAP = JSON.parse(localStorage.getItem(K_WORKERS) || '{}');
function saveWorkerMap(){ localStorage.setItem(K_WORKERS, JSON.stringify(WORKER_MAP)); }
// merge user-provided worker mappings (overwrite or add)
const NEW_WORKERS = {
  "حسن بهاء": "207487",
  "محمد البديوي": "207070",
  "احمد خالد": "207478",
  "عمر حمزة": "207053",
  "عبدالله وائل": "207533",
  "معاذ كمال": "208568",
  "محمود ناجي": "207252",
  "إسلام مصطفي سمير": "207081",
  "محمد صبحي": "207230",
  "محمد احمد": "207097",
  "محمود عبدالحكيم": "207106",
  "اسلام محمد احمد": "207061",
};
Object.assign(WORKER_MAP, NEW_WORKERS);
saveWorkerMap();

// ═════════════════════════════════════════════════════════════════
// 3. تحميل البيانات من التخزين المحلي
// ═════════════════════════════════════════════════════════════════
/* load */
let faults = JSON.parse(localStorage.getItem(K_FAULTS)||'[]');
let orders = JSON.parse(localStorage.getItem(K_ORDERS)||'[]');
let maintenance = JSON.parse(localStorage.getItem(K_MAINTENANCE)||'[]');
let trash = JSON.parse(localStorage.getItem(K_TRASH)||'{"faults":[],"orders":[],"attendance":[],"maintenance":[]}');
let attendance = JSON.parse(localStorage.getItem(K_ATT)||'[]');

// ═════════════════════════════════════════════════════════════════
// تنضيف وتنسيق البيانات المحملة
// ═════════════════════════════════════════════════════════════════
// تأكد من أن trash.maintenance موجودة
if(!trash.maintenance) trash.maintenance = [];

// تنضيف البيانات الموجودة من الوقت الزائد
faults.forEach(f => { if(f.date) f.date = formatDateOnly(f.date); });
orders.forEach(o => { if(o.date) o.date = formatDateOnly(o.date); });
maintenance.forEach(m => { if(m.date) m.date = formatDateOnly(m.date); });
trash.faults.forEach(f => { if(f.date) f.date = formatDateOnly(f.date); });
trash.orders.forEach(o => { if(o.date) o.date = formatDateOnly(o.date); });
trash.maintenance?.forEach(m => { if(m.date) m.date = formatDateOnly(m.date); });

/* PAGINATION SETUP */
const ITEMS_PER_PAGE = 10;
let currentPageFaults = 1;
let currentPageOrders = 1;
let currentPageMaintenance = 1;
let currentPageAttendance = 1;
let isFilteredFaults = false;
let isFilteredOrders = false;
let isFilteredMaintenance = false;
let isFilteredAttendance = false;

// ═════════════════════════════════════════════════════════════════
// 4. دوال مساعدة للترقيم والمعالجة الأساسية
// ═════════════════════════════════════════════════════════════════
function getPaginatedData(data) {
  // عكس الترتيب (آخر عنصر أولاً)
  return data.slice().reverse();
}

function paginate(data, pageNum) {
  const reversed = getPaginatedData(data);
  const start = (pageNum - 1) * ITEMS_PER_PAGE;
  const end = start + ITEMS_PER_PAGE;
  return {
    items: reversed.slice(start, end),
    totalPages: Math.ceil(reversed.length / ITEMS_PER_PAGE),
    totalItems: reversed.length,
    currentPage: pageNum
  };
}

function updatePaginationButtons(containerSelector, totalPages, currentPage, onPageChange) {
  const container = document.querySelector(containerSelector);
  if (!container) return;
  
  container.innerHTML = '';
  
  // زرار الصفحة الأولى
  const firstBtn = document.createElement('button');
  firstBtn.className = 'btn ghost';
  firstBtn.textContent = '|< أول صفحة';
  firstBtn.disabled = currentPage === 1;
  firstBtn.onclick = () => onPageChange(1);
  container.appendChild(firstBtn);
  
  // زرار السابق
  const prevBtn = document.createElement('button');
  prevBtn.className = 'btn ghost';
  prevBtn.textContent = '< السابقة';
  prevBtn.disabled = currentPage === 1;
  prevBtn.onclick = () => onPageChange(currentPage - 1);
  container.appendChild(prevBtn);
  
  // رقم الصفحة
  const pageInfo = document.createElement('span');
  pageInfo.style.cssText = 'margin:0 8px;display:inline-block;color:#666';
  pageInfo.textContent = `الصفحة ${currentPage} من ${totalPages}`;
  container.appendChild(pageInfo);
  
  // زرار التالي
  const nextBtn = document.createElement('button');
  nextBtn.className = 'btn ghost';
  nextBtn.textContent = 'التالية >';
  nextBtn.disabled = currentPage === totalPages;
  nextBtn.onclick = () => onPageChange(currentPage + 1);
  container.appendChild(nextBtn);
  
  // زرار آخر صفحة
  const lastBtn = document.createElement('button');
  lastBtn.className = 'btn ghost';
  lastBtn.textContent = 'آخر صفحة >|';
  lastBtn.disabled = currentPage === totalPages;
  lastBtn.onclick = () => onPageChange(totalPages);
  container.appendChild(lastBtn);
}
attendance.forEach(a => { if(a.absenceDate) a.absenceDate = formatDateOnly(a.absenceDate); });
trash.attendance?.forEach(a => { if(a.absenceDate) a.absenceDate = formatDateOnly(a.absenceDate); });
saveAll();

/* Trash sync interval - declare early to avoid ReferenceError */
let trashSyncInterval = null;

/* ui refs */
// ═════════════════════════════════════════════════════════════════
// تهيئة واجهة المستخدم والعناصر الأساسية
// ═════════════════════════════════════════════════════════════════
const navFaults = document.getElementById('navFaults');
const navMaintenance = document.getElementById('navMaintenance');
const navOrders = document.getElementById('navOrders');
const navAttendance = document.getElementById('navAttendance');
const navTrash = document.getElementById('navTrash');
const navDash = document.getElementById('navDash');
const navHome = document.getElementById('navHome');

navFaults.onclick = ()=>{show('faults'); setTimeout(()=>showLatestFaultNotification(), 500);};
navMaintenance.onclick = ()=>{show('maintenance'); setTimeout(()=>showLatestMaintenanceNotification(), 500);};
navOrders.onclick = ()=>{show('orders'); setTimeout(()=>showLatestOrderNotification(), 500);};
navAttendance.onclick = ()=>{show('attendance'); setTimeout(()=>showLatestAttendanceNotification(), 500);};
navTrash.onclick = ()=>show('trash');
navDash.onclick = ()=>show('dash');
if(navHome) navHome.onclick = ()=>show('home');

function show(page){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  // Handle home page: hide header/nav for a clean white landing
  if(page === 'home'){
    const headerEl = document.querySelector('header');
    const navEl = document.querySelector('nav');
    if(headerEl) headerEl.style.display = 'none';
    if(navEl) navEl.style.display = 'none';
    document.body.style.background = '#fff';
    const el = document.getElementById('page_home'); if(el) { el.classList.add('home-fullscreen'); el.style.display = 'block'; }
    return;
  }
  // restore header/nav when not on home
  const headerEl = document.querySelector('header');
  const navEl = document.querySelector('nav');
  if(headerEl) headerEl.style.display = '';
  if(navEl) navEl.style.display = '';
  document.body.style.background = '';

  if(page==='faults'){ document.getElementById('page_faults').style.display='block'; navFaults.classList.add('active'); stopTrashSync(); }
  if(page==='maintenance'){ document.getElementById('page_maintenance').style.display='block'; navMaintenance.classList.add('active'); stopTrashSync(); }
  if(page==='orders'){ document.getElementById('page_orders').style.display='block'; navOrders.classList.add('active'); stopTrashSync(); }
  if(page==='attendance'){ document.getElementById('page_attendance').style.display='block'; navAttendance.classList.add('active'); stopTrashSync(); }
  if(page==='trash'){ document.getElementById('page_trash').style.display='block'; navTrash.classList.add('active'); startTrashSync(); }
  if(page==='dash'){ document.getElementById('page_dash').style.display='block'; navDash.classList.add('active'); drawDashboard(); stopTrashSync(); }
}
show('home');

// دالة لتصغير حجم عنوان الصفحة الرئيسية في وضع الهاتف
function adjustHomePageTitleSize() {
  const homeTitle = document.querySelector('#page_home h1');
  if (homeTitle) {
    if (window.innerWidth <= 600) {
      homeTitle.style.fontSize = '20px';
    } else {
      homeTitle.style.fontSize = '';
    }
  }
}

// استدعاء الدالة عند تحميل الصفحة
window.addEventListener('load', adjustHomePageTitleSize);

// استدعاء الدالة عند تغيير حجم النافذة
window.addEventListener('resize', adjustHomePageTitleSize);

/* ═════════════════════════════════════════════════════════════════
   إشعارات الدخول والتحديث
   ═════════════════════════════════════════════════════════════════ */

// دالة لعرض آخر عطل تم تسجيله
function showLatestFaultNotification() {
  if(faults && faults.length > 0) {
    // البحث عن آخر عطل تم تسجيله فعلياً بناءً على التاريخ (الأحدث)
    // وإذا تكرر التاريخ، اختر آخر عطل تم إضافته في نفس التاريخ
    let latestFault = faults[0];
    let latestDate = new Date(latestFault.date || 0).getTime();
    
    for(let i = 1; i < faults.length; i++) {
      const faultDate = new Date(faults[i].date || 0).getTime();
      if(faultDate >= latestDate) {
        latestDate = faultDate;
        latestFault = faults[i];
      }
    }
    
    const faultInfo = `
الماكينة: ${latestFault.machine}
القائم: ${latestFault.person}
الوصف: ${latestFault.description}
حل العطل: ${latestFault.solution || '-'}
التاريخ: ${latestFault.date}
الحالة: ${latestFault.status}`;
    
    showNotification('آخر عطل مسجل', faultInfo);
  }
}

// دالة لعرض آخر صيانة تم تسجيلها
function showLatestMaintenanceNotification() {
  if(maintenance && maintenance.length > 0) {
    // البحث عن آخر صيانة تم تسجيلها فعلياً بناءً على التاريخ (الأحدث)
    // وإذا تكرر التاريخ، اختر آخر صيانة تم إضافتها في نفس التاريخ
    let latestMaintenance = maintenance[0];
    let latestDate = new Date(latestMaintenance.date || 0).getTime();
    
    for(let i = 1; i < maintenance.length; i++) {
      const maintDate = new Date(maintenance[i].date || 0).getTime();
      if(maintDate >= latestDate) {
        latestDate = maintDate;
        latestMaintenance = maintenance[i];
      }
    }
    
    const mainInfo = `
الماكينة: ${latestMaintenance.machine}
القائم: ${latestMaintenance.person}
النوع: ${latestMaintenance.type}
التاريخ: ${latestMaintenance.date}
الملاحظات: ${latestMaintenance.notes || '-'}
تغيير قطع غيار: ${latestMaintenance.partChanged === 'yes' ? 'نعم' : 'لا'}${latestMaintenance.partChanged === 'yes' ? `
اسم القطعة: ${latestMaintenance.partName || '-'}
الكمية: ${latestMaintenance.partQty || '-'}` : ''}`;
    
    showNotification('آخر صيانة مسجلة', mainInfo);
  }
}

// دالة لعرض آخر أمر شراء تم تسجيله
function showLatestOrderNotification() {
  if(orders && orders.length > 0) {
    // البحث عن آخر أمر تم تسجيله بناءً على التاريخ (الأحدث)
    let latestOrder = orders[0];
    let latestDate = new Date(latestOrder.date || 0).getTime();
    
    for(let i = 1; i < orders.length; i++) {
      const orderDate = new Date(orders[i].date || 0).getTime();
      if(orderDate > latestDate) {
        latestDate = orderDate;
        latestOrder = orders[i];
      }
    }
    
    const orderInfo = `
رقم الأمر: ${latestOrder.orderNum || '-'}
التوريد: ${latestOrder.supplyNum || '-'}
التاريخ: ${latestOrder.date || '-'}
القائم: ${latestOrder.person}`;
    
    showNotification('آخر أمر شراء مسجل', orderInfo);
  }
}

// دالة لعرض آخر أجازة تم تسجيلها
function showLatestAttendanceNotification() {
  if(attendance && attendance.length > 0) {
    // البحث عن آخر أجازة تم تسجيلها بناءً على التاريخ (الأحدث)
    let latestAtt = attendance[0];
    let latestDate = new Date(latestAtt.absenceDate || 0).getTime();
    
    for(let i = 1; i < attendance.length; i++) {
      const attDate = new Date(attendance[i].absenceDate || 0).getTime();
      if(attDate > latestDate) {
        latestDate = attDate;
        latestAtt = attendance[i];
      }
    }
    
    const attInfo = `
اسم الموظف: ${latestAtt.workerName}
تاريخ الأجازة: ${latestAtt.absenceDate}
عدد الأيام: ${latestAtt.daysCount}
النوع: ${latestAtt.vacationType}`;
    
    showNotification('آخر أجازة مسجلة', attInfo);
  }
}

// إشعار عند تحميل الصفحة (دخول الموقع)
window.addEventListener('load', function() {
  setTimeout(function() {
    const welcomeTime = new Date().toLocaleTimeString('ar-EG');
    showNotification('مرحباً بك', 'تم الدخول إلى النظام - ' + welcomeTime);
  }, 500);
});

// إشعار عند تحديث الصفحة
window.addEventListener('beforeunload', function() {
  console.log('⏹️ سيتم تحديث الصفحة');
});

window.addEventListener('pageshow', function(event) {
  if(event.persisted) {
    // عودة من cache (الزر الخلفي)
    const time = new Date().toLocaleTimeString('ar-EG');
    showNotification('عودة للصفحة', 'تم استعادة البيانات - ' + time);
  } else {
    // تحديث جديد
    const time = new Date().toLocaleTimeString('ar-EG');
    showNotification('تحديث النظام', 'تم تحديث الصفحة - ' + time);
  }
});

// إشعار عند مغادرة الصفحة (اختياري)
window.addEventListener('unload', function() {
  console.log('🚪 المستخدم غادر الصفحة');
});

/* helpers */
// ═════════════════════════════════════════════════════════════════
// 5. دوال مساعدة عامة
// ═════════════════════════════════════════════════════════════════
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }
function getTodayDate(){ 
  const d = new Date(); 
  const year = d.getFullYear(); 
  const month = String(d.getMonth()+1).padStart(2,'0'); 
  const day = String(d.getDate()).padStart(2,'0'); 
  return `${year}-${month}-${day}`; 
}
function formatDateOnly(dateStr) {
  if (!dateStr) return '';
  // إذا كانت الصيغة YYYY-MM-DD فقط، أرجعها كما هي
  if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
  // إذا كانت تحتوي على وقت، شيل الوقت
  return dateStr.split('T')[0].split(' ')[0];
}
function saveAll(){ 
  localStorage.setItem(K_FAULTS, JSON.stringify(faults)); 
  localStorage.setItem(K_ORDERS, JSON.stringify(orders)); 
  localStorage.setItem(K_MAINTENANCE, JSON.stringify(maintenance)); 
  localStorage.setItem(K_TRASH, JSON.stringify(trash)); 
  localStorage.setItem(K_ATT, JSON.stringify(attendance)); 
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ═════════════════════════════════════════════════════════════════
   نظام الإشعارات الشامل
   ═════════════════════════════════════════════════════════════════ */

// دالة الإشعار الرئيسية (رسالة نصية + صوت + إشعار متصفح)
function showNotification(title, message, type = 'success') {
  // 1. رسالة نصية على الشاشة (Toast)
  showSuccess(message);
  
  // 2. تشغيل صوت الإشعار
  playNotificationSound();
  
  // 3. إشعار متصفح (Browser Notification)
  if('Notification' in window && Notification.permission === 'granted') {
    new Notification(title, {
      body: message,
      icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%230A4C88"/><text x="50" y="60" font-size="50" fill="white" text-anchor="middle" font-weight="bold">⚙</text></svg>',
      tag: 'system-notification'
    });
  }
}

// دالة تشغيل صوت الإشعار
function playNotificationSound() {
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  oscillator.frequency.value = 800; // تردد الصوت
  oscillator.type = 'sine';
  
  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.1);
}

// طلب إذن إشعارات المتصفح عند التحميل
if('Notification' in window && Notification.permission === 'default') {
  Notification.requestPermission();
}

// دالة إرسال بريد إلكتروني
const NOTIFICATION_EMAIL = 'abdallawael2025@gmail.com';

function sendEmailNotification(title, message) {
  // تسجيل الرسالة في console للمتابعة
  const timestamp = new Date().toLocaleString('ar-EG');
  console.log('📧 إرسال بريد إلكتروني:', { title, message, to: NOTIFICATION_EMAIL, timestamp });
  
  // محاولة إرسال عبر FormSubmit (خدمة مجانية)
  const emailData = {
    email: NOTIFICATION_EMAIL,
    name: 'نظام الإشعارات',
    subject: title,
    message: message,
    timestamp: timestamp
  };
  
  // جرب إرسال عبر FormSubmit.co
  fetch('https://formsubmit.co/ajax/' + NOTIFICATION_EMAIL, {
    method: 'POST',
    body: JSON.stringify(emailData),
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json'
    }
  }).then(response => {
    if(response.ok) {
      console.log('✅ تم إرسال البريد الإلكتروني بنجاح إلى ' + NOTIFICATION_EMAIL);
    } else {
      console.warn('⚠️ مشكلة في إرسال البريد، الرمز:', response.status);
    }
  }).catch(err => {
    console.log('⚠️ لم يتمكن من إرسال البريد (قد لا يتوفر الإنترنت):', err);
  });
}

// دالة للإشعارات المخصصة حسب النوع
function notifyAction(actionType, itemType, itemName = '') {
  const messages = {
    'fault_added': { title: 'عطل جديد', message: `تم إضافة عطل جديد${itemName ? ' - ' + itemName : ''}` },
    'fault_edited': { title: 'تحديث عطل', message: `تم تعديل عطل${itemName ? ' - ' + itemName : ''}` },
    'fault_deleted': { title: 'حذف عطل', message: `تم حذف عطل${itemName ? ' - ' + itemName : ''}` },
    'maintenance_added': { title: 'صيانة جديدة', message: `تم إضافة صيانة جديدة${itemName ? ' - ' + itemName : ''}` },
    'maintenance_edited': { title: 'تحديث صيانة', message: `تم تعديل صيانة${itemName ? ' - ' + itemName : ''}` },
    'maintenance_deleted': { title: 'حذف صيانة', message: `تم حذف صيانة${itemName ? ' - ' + itemName : ''}` },
    'order_added': { title: 'أمر شراء جديد', message: `تم إضافة أمر شراء جديد${itemName ? ' - ' + itemName : ''}` },
    'order_edited': { title: 'تحديث أمر شراء', message: `تم تعديل أمر شراء${itemName ? ' - ' + itemName : ''}` },
    'order_deleted': { title: 'حذف أمر شراء', message: `تم حذف أمر شراء${itemName ? ' - ' + itemName : ''}` },
    'attendance_added': { title: 'أجازة جديدة', message: `تم تسجيل أجازة جديدة${itemName ? ' - ' + itemName : ''}` },
    'attendance_edited': { title: 'تحديث أجازة', message: `تم تعديل سجل أجازة${itemName ? ' - ' + itemName : ''}` },
    'attendance_deleted': { title: 'حذف أجازة', message: `تم حذف سجل أجازة${itemName ? ' - ' + itemName : ''}` }
  };
  
  const msg = messages[actionType];
  if(msg) {
    showNotification(msg.title, msg.message);
  }
}

// ═════════════════════════════════════════════════════════════════
// 6. دوال اختيار وإدارة قوائم الماكينات
// ═════════════════════════════════════════════════════════════════
// دالة لعرض القيمة أو Dash إذا كانت فارغة
function getSelectedMachineLine(selectId){
  const sel = document.getElementById(selectId);
  if(!sel) return { machine: '', line: '' };
  const opt = sel.options[sel.selectedIndex];
  if(!opt) return { machine: '', line: '' };
  const machine = opt.text || '';
  const line = opt.parentElement && opt.parentElement.label ? opt.parentElement.label : '';
  return { machine: machine.trim(), line: line.trim() };
}

function setSelectMachineLine(selectId, machine, line){
  const sel = document.getElementById(selectId);
  if(!sel) return;
  for(let i=0;i<sel.options.length;i++){
    const o = sel.options[i];
    const grp = o.parentElement && o.parentElement.label ? o.parentElement.label : '';
    if(o.text === (machine||'') && grp === (line||'')){
      sel.selectedIndex = i; return;
    }
  }
  // fallback: try match by machine text only
  for(let i=0;i<sel.options.length;i++) if(sel.options[i].text === (machine||'')){ sel.selectedIndex = i; return; }
  sel.selectedIndex = 0;
}

// -- Grouped selection support (group -> items)
const MACHINE_GROUPS = {
  "خط ١": ["سيمولتان ١","انتاليو ١","انتاليو ٢","نوتاسكرين ١","ترقيم ١"],
  "خط ٢": ["سيمولتان ٢","انتاليو ٣","انتاليو ٤","نوتاسكرين ٢","ترقيم ٢"],
  "خط ٣": ["سيمولتان ٣","انتاليو ٥","انتاليو ٦","اوبتي نوتا","ترقيم ٣"],
  "خط ٤": ["سيمولتان ٤","انتاليو ٧","انتاليو ٨","Foil SPM 140","ترقيم ٤"],
  "تشطيب": ["BPS 1","BPS 2","BPS 3","Cutlink 1","Cutlink 2","Cutpak 1","Cutpak 2","Kallfas Shrink Offline 1","Kallfas Shrink Offline 2","Bars"],
  "الفرم": ["BDS 1","BDS 2","Silo 1","Silo 2"],
  "التجهيزات": [
    "lathe machine 1","lathe machine 2","plastirota 1","plastirota 2","plastmix 1","plastmix 2",
    "plate grinding 1","plate grinding 2","plate coat 1","plate coat 2","pilfora lv","Plate Shear","plate Bright",
    "حوض النيكل 1+ Rectifier 1","حوض النيكل 2+ Rectifier 2","حوض الإزالة والتنشيط + Rectifier 3","جهاز نزع الاملاح من المياه","scrubber",
    "CToP 1","CToP 2","PolyWash 1","PolyWash 2","PolyExpose 1","PolyExpose 2","Plate Bender","Plate Punch IV",
    "Vertical burning-in oven","Vertical drying cabinet","Gravograph 1","Gravograph 2","plate check","Mathemat digital","و ملحقاته CTiP",
    "Galvano Lab","قسم الاحبار","tensiometer","microscopes","Plate Inspection","اللورجي","حوض الصيانه","وحده المعالجه","Mathemat digital 2"],
  "معمل الجودة": ["__custom__"],
  "أخري": ["__custom__"]
};

function initGroupSelects(){
  const groups = Object.keys(MACHINE_GROUPS);
  const mg = document.getElementById('machineGroup');
  const mg2 = document.getElementById('mainGroup');
  if(mg){ mg.innerHTML = '<option value="">اختر مكان الماكينة</option>'; groups.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; mg.appendChild(o); }); }
  if(mg2){ mg2.innerHTML = '<option value="">اختر مكان الماكينة</option>'; groups.forEach(g=>{ const o=document.createElement('option'); o.value=g; o.textContent=g; mg2.appendChild(o); }); }
}

function populateItemsForGroup(groupName, itemSelectId){
  const items = MACHINE_GROUPS[groupName] || [];
  const sel = document.getElementById(itemSelectId);
  if(!sel) return;
  
  // حدد أي حاويات سيتم التحكم بها
  let itemContainer = null;
  let customContainer = null;
  
  if(itemSelectId === 'machineItem') {
    itemContainer = document.getElementById('machineItemContainer');
    customContainer = document.getElementById('customMachineGroupContainer');
  } else if(itemSelectId === 'mainItem') {
    itemContainer = document.getElementById('mainItemContainer');
    customContainer = document.getElementById('customMainGroupContainer');
  }
  
 // إذا كانت المجموعة المختارة "أخري" أو "معمل الجودة"، اخفِ select واعرض حقول النص الحر
  if(groupName === 'أخري' || groupName === 'معمل الجودة') {
    sel.innerHTML = '<option value="">اختر الماكينة</option>';
    sel.disabled = true;
    if(itemContainer) itemContainer.style.display = 'none';
    if(customContainer) customContainer.style.display = 'block';
    let placeEl = null;
    let nameEl = null;
    let placeContainer = null;
    // اختر المعرفات الصحيحة حسب نوع النموذج
    if(itemSelectId === 'machineItem') {
      placeEl = document.getElementById('customMachinePlace');
      nameEl = document.getElementById('customMachineName');
      placeContainer = document.getElementById('customMachinePlaceContainer');
    } else if(itemSelectId === 'mainItem') {
      placeEl = document.getElementById('customMainPlace');
      nameEl = document.getElementById('customMainName');
      placeContainer = document.getElementById('customMainPlaceContainer');
    }
    // إخفاء حقل "مكان الماكينة" فقط لـ "معمل الجودة" وإظهاره لـ "أخري"
    if(groupName === 'معمل الجودة') {
      if(placeContainer) placeContainer.style.display = 'none';
      if(placeEl) placeEl.removeAttribute('required');
      if(nameEl) nameEl.setAttribute('required','required');
    } else if(groupName === 'أخري') {
      if(placeContainer) placeContainer.style.display = 'block';
      if(placeEl) placeEl.setAttribute('required','required');
      if(nameEl) nameEl.setAttribute('required','required');
    }
    return;
  }
  
  // إظهار select وإخفاء حقول النص الحر
  if(itemContainer) itemContainer.style.display = 'block';
  if(customContainer) customContainer.style.display = 'none';
  let placeContainer = null;
  let placeEl = null;
  let nameEl = null;
  // اختر المعرفات الصحيحة حسب نوع النموذج
  if(itemSelectId === 'machineItem') {
    placeContainer = document.getElementById('customMachinePlaceContainer');
    placeEl = document.getElementById('customMachinePlace');
    nameEl = document.getElementById('customMachineName');
  } else if(itemSelectId === 'mainItem') {
    placeContainer = document.getElementById('customMainPlaceContainer');
    placeEl = document.getElementById('customMainPlace');
    nameEl = document.getElementById('customMainName');
  }
  // إظهار حقل "مكان الماكينة" إذا كان موجوداً
  if(placeContainer) placeContainer.style.display = 'block';
  // تأكد من إزالة صفة required من حقول النص الحر عند اختيار مجموعة عادية
  if(placeEl) placeEl.removeAttribute('required');
  if(nameEl) nameEl.removeAttribute('required');
  
  if(!groupName || items.length===0){ sel.innerHTML = '<option value="">اختر الماكينة</option>'; sel.disabled = true; return; }
  sel.disabled = false; sel.innerHTML = '<option value="">اختر الماكينة</option>';
  items.forEach(it=>{ const o = document.createElement('option'); o.value = it; o.textContent = it; sel.appendChild(o); });
}

function getSelectedMachineLineFromGroups(groupId, itemId){
  const g = document.getElementById(groupId);
  const it = document.getElementById(itemId);
  const line = g ? (g.value||'') : '';
  let machine = it ? (it.value||'') : '';
  
  // إذا كانت المجموعة "أخري" أو "معمل الجودة"، احصل على القيم من حقول النص الحر
  if(line === 'أخري' || line === 'معمل الجودة') {
    if(itemId === 'machineItem') {
      const place = document.getElementById('customMachinePlace');
      const name = document.getElementById('customMachineName');
      machine = (name ? name.value.trim() : '');
      // استخدم place كـ machine فقط إذا كانت المجموعة "أخري"
      if(place && place.value.trim() && line === 'أخري') {
        machine = place.value.trim() + ' - ' + machine;
      }
    } else if(itemId === 'mainItem') {
      const place = document.getElementById('customMainPlace');
      const name = document.getElementById('customMainName');
      machine = (name ? name.value.trim() : '');
      // استخدم place كـ machine فقط إذا كانت المجموعة "أخري"
      if(place && place.value.trim() && line === 'أخري') {
        machine = place.value.trim() + ' - ' + machine;
      }
    }
  }
  
  return { machine: machine.trim(), line: line.trim() };
}

function setGroupSelection(groupId, itemId, machine, line){
  const g = document.getElementById(groupId);
  const it = document.getElementById(itemId);
  if(!g || !it) return;
  g.value = line || '';
  populateItemsForGroup(g.value, itemId);
  
  // إذا كانت المجموعة المختارة "أخري" أو "معمل الجودة"، لا تحاول البحث في القائمة
  if(line === 'أخري' || line === 'معمل الجودة') {
    return;
  }
  
  if(machine){ for(let i=0;i<it.options.length;i++){ if(it.options[i].value === machine){ it.selectedIndex = i; break; } } }
}

document.addEventListener('DOMContentLoaded', function(){ initGroupSelects();
  document.getElementById('machineGroup')?.addEventListener('change', function(){ populateItemsForGroup(this.value, 'machineItem'); });
  document.getElementById('mainGroup')?.addEventListener('change', function(){ populateItemsForGroup(this.value, 'mainItem'); });
});

// Auto-fill worker number when a worker name is selected in attendance
document.addEventListener('DOMContentLoaded', function(){
  const workerNameSelect = document.getElementById('workerName');
  const workerNumInput = document.getElementById('workerNum');
  if(!workerNameSelect) return;
  
  // Function to update worker number based on selected name
  function updateWorkerNum(){
    const name = (workerNameSelect.value||'').trim();
    if(!name) {
      if(workerNumInput) workerNumInput.value = '';
      return;
    }
    // Look up in WORKER_MAP
    if(WORKER_MAP[name]){
      if(workerNumInput) workerNumInput.value = WORKER_MAP[name];
    } else {
      // If not found, clear it
      if(workerNumInput) workerNumInput.value = '';
    }
  }
  
  // Update on change
  workerNameSelect.addEventListener('change', updateWorkerNum);
  
  // Initialize on page load
  updateWorkerNum();
});

// --- Multi-select hidden UI helpers (person & mainPerson)
function getSelectedValues(selectId){
  const sel = document.getElementById(selectId); if(!sel) return []; return Array.from(sel.selectedOptions).map(o=>o.value).filter(v=>v && v.trim());
}
function setMultiSelectValues(selectId, csvOrArray){
  const sel = document.getElementById(selectId); if(!sel) return;
  let arr = [];
  if(Array.isArray(csvOrArray)) arr = csvOrArray;
  else if(typeof csvOrArray === 'string' && csvOrArray.trim() !== '') arr = csvOrArray.split(',').map(s=>s.trim()).filter(Boolean);
  for(let i=0;i<sel.options.length;i++){ sel.options[i].selected = arr.includes(sel.options[i].value); }
}
function renderSelectedChips(selectId, chipsId){
  const sel = document.getElementById(selectId); const cont = document.getElementById(chipsId); if(!sel || !cont) return; cont.innerHTML='';
  const vals = getSelectedValues(selectId);
  if(vals.length===0){ cont.innerHTML = '<span class="empty">—</span>'; return; }
  vals.forEach(v=>{
    const span = document.createElement('span'); span.className='chip'; span.style.cssText='display:inline-block;background:#eef;padding:4px 8px;border-radius:12px;margin:2px;font-size:13px';
    span.textContent = v;
    const rem = document.createElement('button'); rem.type='button'; rem.textContent='✕'; rem.style.cssText='background:transparent;border:0;color:#900;cursor:pointer;margin-left:6px';
    rem.addEventListener('click', ()=>{ for(let i=0;i<sel.options.length;i++){ if(sel.options[i].value===v){ sel.options[i].selected=false; break; } } renderSelectedChips(selectId,chipsId); });
    span.appendChild(rem);
    cont.appendChild(span);
  });
}

document.addEventListener('DOMContentLoaded', function(){
  // Toggle button for showing/hiding part fields
  const partChangedSelect = document.getElementById('partChanged');
  const partFieldsContainer = document.getElementById('partFieldsContainer');
  
  if(partChangedSelect && partFieldsContainer) {
    // Function to toggle part fields visibility
    function togglePartFields() {
      partFieldsContainer.style.display = partChangedSelect.value === 'yes' ? 'block' : 'none';
    }
    
    // Listen for changes
    partChangedSelect.addEventListener('change', togglePartFields);
    
    // Initialize on page load
    togglePartFields();
  }

  // Toggle button for showing/hiding maintenance part fields
  const mainPartChangedSelect = document.getElementById('mainPartChanged');
  const mainPartFieldsContainer = document.getElementById('mainPartFieldsContainer');
  
  if(mainPartChangedSelect && mainPartFieldsContainer) {
    // Function to toggle part fields visibility
    function toggleMainPartFields() {
      mainPartFieldsContainer.style.display = mainPartChangedSelect.value === 'yes' ? 'block' : 'none';
    }
    
    // Listen for changes
    mainPartChangedSelect.addEventListener('change', toggleMainPartFields);
    
    // Initialize on page load
    toggleMainPartFields();
  }
  
  // toggle buttons — show/hide select and update chips after change
  const personToggle = document.getElementById('personToggle');
  const mainPersonToggle = document.getElementById('mainPersonToggle');
  const personSel = document.getElementById('person');
  const mainPersonSel = document.getElementById('mainPerson');
  const orderPersonToggle = document.getElementById('orderPersonToggle');
  const orderPersonSel = document.getElementById('orderPerson');

  personToggle?.addEventListener('click', function(){
    if(!personSel) return;
    personSel.style.display = (personSel.style.display==='none'?'block':'none');
    if(personSel.style.display!=='none') personSel.focus();
    // update chips to reflect current selection whenever the list is toggled
    renderSelectedChips('person','personChips');
  });

  mainPersonToggle?.addEventListener('click', function(){
    if(!mainPersonSel) return;
    mainPersonSel.style.display = (mainPersonSel.style.display==='none'?'block':'none');
    if(mainPersonSel.style.display!=='none') mainPersonSel.focus();
    renderSelectedChips('mainPerson','mainPersonChips');
  });

  // order person toggle/listeners
  orderPersonToggle?.addEventListener('click', function(){
    if(!orderPersonSel) return;
    orderPersonSel.style.display = (orderPersonSel.style.display==='none'?'block':'none');
    if(orderPersonSel.style.display!=='none') orderPersonSel.focus();
    renderSelectedChips('orderPerson','orderPersonChips');
  });

  // update chips live when the user changes selection inside the hidden multi-select
  personSel?.addEventListener('change', function(){
    renderSelectedChips('person','personChips');
    // hide the multi-select after selection to keep UI compact
    personSel.style.display = 'none';
  });
  mainPersonSel?.addEventListener('change', function(){
    renderSelectedChips('mainPerson','mainPersonChips');
    mainPersonSel.style.display = 'none';
  });
  orderPersonSel?.addEventListener('change', function(){
    renderSelectedChips('orderPerson','orderPersonChips');
    orderPersonSel.style.display = 'none';
  });

  // render initial chips
  renderSelectedChips('person','personChips');
  renderSelectedChips('mainPerson','mainPersonChips');
  renderSelectedChips('orderPerson','orderPersonChips');
});

function displayValue(value) {
  const val = String(value || '').trim();
  if (!val || val === 'undefined' || val === 'null' || val === '0') {
    return '<span class="empty">—</span>';
  }
  return escapeHtml(val);
}

// تأكد من أن جميع السجلات لديها IDs
maintenance.forEach(m => { if(!m.id) m.id = uid(); });
faults.forEach(f => { if(!f.id) f.id = uid(); });
orders.forEach(o => { if(!o.id) o.id = uid(); });
attendance.forEach(a => { if(!a.id) a.id = uid(); });
trash.faults.forEach(f => { if(!f.id) f.id = uid(); });
trash.orders.forEach(o => { if(!o.id) o.id = uid(); });
trash.maintenance.forEach(m => { if(!m.id) m.id = uid(); });
(trash.attendance||[]).forEach(a => { if(!a.id) a.id = uid(); });
saveAll();

function startTrashSync(){
  // if(trashSyncInterval) return; // Already syncing
  if (typeof trashSyncInterval !== "undefined" && trashSyncInterval) {
        clearInterval(trashSyncInterval);
    }
  console.log('🔄 بدء مزامنة سلة المحذوفات');
  // Initial load
  loadTrashFromServer();
  // Then refresh every 2 seconds while viewing trash
  trashSyncInterval = setInterval(loadTrashFromServer, 2000);
}

function stopTrashSync(){
  if(trashSyncInterval){
    clearInterval(trashSyncInterval);
    trashSyncInterval = null;
    console.log('⏹️ إيقاف مزامنة سلة المحذوفات');
  }
}

function loadTrashFromServer(){
  // Load all trash data in parallel and wait for all to complete
  const promises = [];
  
  // تحميل الأعطال المحذوفة
  promises.push(
    fetch(API_URL + '?kind=trash_faults')
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data)) return;
        trash.faults = data;
        console.log('✅ تحمّلت الأعطال المحذوفة:', data.length);
      })
      .catch(err => console.error('❌ خطأ في تحميل الأعطال المحذوفة', err))
  );

  // تحميل الأوامر المحذوفة
  promises.push(
    fetch(API_URL + '?kind=trash_orders')
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data)) return;
        trash.orders = data;
        console.log('✅ تحمّلت الأوامر المحذوفة:', data.length);
      })
      .catch(err => console.error('❌ خطأ في تحميل الأوامر المحذوفة', err))
  );

  // تحميل الصيانات المحذوفة
  promises.push(
    fetch(API_URL + '?kind=trash_maintenance')
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data)) return;
        trash.maintenance = data;
        console.log('✅ تحمّلت الصيانات المحذوفة:', data.length);
      })
      .catch(err => console.error('❌ خطأ في تحميل الصيانات المحذوفة', err))
  );

  // تحميل سجلات الحضور المحذوفة
  promises.push(
    fetch(API_URL + '?kind=trash_attendance')
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data)) return;
        trash.attendance = data;
        console.log('✅ تحمّلت سجلات الحضور المحذوفة:', data.length);
      })
      .catch(err => console.error('❌ خطأ في تحميل سجلات الحضور المحذوفة', err))
  );

  // انتظر كل الـ fetches وبعدين رندر مرة واحدة - وارجع Promise
  return Promise.all(promises).then(() => {
    console.log('🎉 انتهت كل عمليات التحميل - الآن الرندر');
    saveAll();
    renderTrash();
  }).catch(err => {
    console.error('خطأ عام في loadTrashFromServer:', err);
    renderTrash(); // رندر حتى لو في أخطاء
    throw err; // مرر الخطأ للأعلى
  });
}

/* Helper for POSTing to API with safe JSON/text handling */
function apiPost(payload){
  return fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify(payload)
  }).then(async (r)=>{
    const text = await r.text().catch(()=>null);
    let json = null;
    try{ if(text) json = JSON.parse(text); }catch(e){ /* non-json response */ }
    return { ok: r.ok, status: r.status, statusText: r.statusText, json: json, text: text };
  });
}

/* CRUD faults */
// ═════════════════════════════════════════════════════════════════
// 7. عمليات CRUD للأعطال (إضافة، تعديل، حذف)
// ═════════════════════════════════════════════════════════════════
let editingFaultId = null;
document.getElementById('addBtn').addEventListener('click', onAddOrSave);
document.getElementById('clearBtn').addEventListener('click', clearFaultForm);
function clearFaultForm(){
  editingFaultId = null;
  document.getElementById('machineGroup').value = '';
  populateItemsForGroup('', 'machineItem');
  document.getElementById('customMachinePlace').value = '';
  document.getElementById('customMachineName').value = '';
  setMultiSelectValues('person',''); renderSelectedChips('person','personChips');
  document.getElementById('description').value=''; 
  document.getElementById('solution').value=''; 
  document.getElementById('shift').value='صباحية'; 
  document.getElementById('date').value=getTodayDate(); 
  document.getElementById('partChanged').value='no';
  document.getElementById('partFieldsContainer').style.display='none';
  document.getElementById('lcode').value=''; 
  document.getElementById('partName').value=''; 
  document.getElementById('partQty').value=0; 
  document.getElementById('status').value='تم الإصلاح'; 
  document.getElementById('addBtn').innerText='إضافة العطل';
}

function onAddOrSave(){
  if(editingFaultId) return saveEditFault();
  
  const selML = getSelectedMachineLineFromGroups('machineGroup','machineItem');
  
  // التحقق من القائم بالعطل أولاً (إجباري في جميع الحالات)
  if(!(getSelectedValues('person').length > 0 || (personChips && personChips.textContent.trim() !== ''))) {
    alert('من فضلك اختر اسم/أسماء القائم بالعطل. (حقل إجباري)');
    return;
  }
  
  // التحقق من الحقول المطلوبة حسب نوع المجموعة
  if(selML.line === 'معمل الجودة') {
    // عند اختيار "معمل الجودة"، اطلب اسم الماكينة والقائم بالعطل
    const customName = document.getElementById('customMachineName').value.trim();
    if(!customName) {
      alert('من فضلك ادخل اسم الماكينة');
      return;
    }
  } else if(selML.line === 'أخري') {
    // عند اختيار "أخري"، يجب ملء حقل مكان الماكينة واسم الماكينة
    const place = document.getElementById('customMachinePlace').value.trim();
    const customName = document.getElementById('customMachineName').value.trim();
    if(!place) {
      alert('من فضلك أدخل مكان الماكينة');
      return;
    }
    if(!customName) {
      alert('من فضلك ادخل اسم الماكينة');
      return;
    }
  } else {
    // عند اختيار مجموعة عادية، يجب اختيار الماكينة من القائمة
    if(!selML.machine) {
      alert('من فضلك اختر الماكينة');
      return;
    }
  }
  
  // التحقق من الحقول الأخرى الإجبارية
  var person = document.getElementById('person');
  var personChips = document.getElementById('personChips');
  var description = document.getElementById('description');
  var solution = document.getElementById('solution');
  var shift = document.getElementById('shift');
  var date = document.getElementById('date');
  var partChanged = document.getElementById('partChanged');
  var lcode = document.getElementById('lcode');
  var partName = document.getElementById('partName');
  var partQty = document.getElementById('partQty');
  var status = document.getElementById('status');
  
  if(!(getSelectedValues('person').length > 0 || (personChips && personChips.textContent.trim() !== ''))){ alert('من فضلك اختر اسم/أسماء القائم بالعطل.'); return; }
  if(!description || description.value.trim()===''){  alert('من فضلك ادخل وصف العطل.'); return; }
  if(!solution || solution.value.trim()===''){  alert('من فضلك ادخل شرح حل العطل.'); return; }
  if(!shift || shift.value.trim()===''){  alert('من فضلك اختر الوردية.'); return; }
  if(!date || date.value.trim()===''){  alert('من فضلك اختر التاريخ.'); return; }
  if(!partChanged || partChanged.value.trim()===''){  alert('من فضلك اختر هل تم تغيير قطعة غيار.'); return; }
  if(partChanged && partChanged.value === 'yes'){
    if(!lcode || lcode.value.trim()===''){  alert('من فضلك ادخل كود المخزن (L Number).'); return; }
    if(!partName || partName.value.trim()===''){  alert('من فضلك ادخل اسم قطعة الغيار.'); return; }
    if(!partQty || partQty.value === '' || Number(partQty.value) <= 0){  alert('من فضلك ادخل كمية صحيحة لقطعة الغيار.'); return; }
  }
  if(!status || status.value.trim()===''){  alert('من فضلك اختر حالة العطل.'); return; }
  
  // Get the part changed value
  const partChangedVal = document.getElementById('partChanged').value;
  
  // Only use part fields if "yes" was selected
  const lcodeVal = partChangedVal === 'yes' ? document.getElementById('lcode').value.trim() : '';
  const partNameVal = partChangedVal === 'yes' ? document.getElementById('partName').value.trim() : '';
  const partQtyVal = partChangedVal === 'yes' ? Number(document.getElementById('partQty').value||0) : 0;
  
  const f = {
    id: uid(),
    machine: selML.machine,
    line: selML.line,
    person: getSelectedValues('person').join(', '),
    description: document.getElementById('description').value.trim(),
    solution: document.getElementById('solution').value.trim(),
    shift: document.getElementById('shift').value,
    date: formatDateOnly(document.getElementById('date').value),
    partChanged: partChangedVal,
    lcode: lcodeVal,
    partName: partNameVal,
    partQty: partQtyVal,
    status: document.getElementById('status').value
  };
  fetch(API_URL, {
  method: 'POST',
  // headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({ kind: 'fault', op: 'add', data: f })
}).then(r => r.json())
  .then(res => {
    if (!res.ok) alert('في مشكلة في حفظ العطل على السيرفر، هيتحفظ Local بس');
  }).catch(err => {
    console.error(err);
    alert('السيرفر مش متاح حاليًا، هيتحفظ Local بس');
  });
  faults.unshift(f);
  clearFaultForm(); 
  currentPageFaults = 1;
  renderFaultTable(); 
  drawDashboard(); 
  show('faults');
  // إرسال إشعار عند إضافة عطل
  notifyAction('fault_added', 'fault', f.machine);
  showSuccess('تم الإدخال');
  
  // عرض تفاصيل آخر عطل بعد التسجيل
  setTimeout(function() {
    showLatestFaultNotification();
  }, 500);
}

/* edit fault */
function startEditFault(id){
  const f = faults.find(x=>x.id===id); if(!f) return alert('السجل غير موجود'); editingFaultId = id;
  setGroupSelection('machineGroup','machineItem', f.machine, f.line);
  // إذا كان الخط "أخري"، املأ حقول النص الحر
  if(f.line === 'أخري') {
    // استخراج مكان الماكينة واسم الماكينة من f.machine
    const parts = f.machine.split(' - ');
    if(parts.length === 2) {
      document.getElementById('customMachinePlace').value = parts[0].trim();
      document.getElementById('customMachineName').value = parts[1].trim();
    } else {
      document.getElementById('customMachinePlace').value = '';
      document.getElementById('customMachineName').value = f.machine;
    }
  } else {
    document.getElementById('customMachinePlace').value = '';
    document.getElementById('customMachineName').value = '';
  }
  setMultiSelectValues('person', f.person);
  renderSelectedChips('person','personChips');
  document.getElementById('description').value = f.description;
  document.getElementById('solution').value = f.solution || '';
  document.getElementById('shift').value = f.shift;
  document.getElementById('date').value = f.date;
  // Set part changed based on whether part fields have values
  const hasPartData = f.lcode || f.partName || f.partQty;
  document.getElementById('partChanged').value = hasPartData ? 'yes' : 'no';
  document.getElementById('partFieldsContainer').style.display = hasPartData ? 'block' : 'none';
  document.getElementById('lcode').value = f.lcode;
  document.getElementById('partName').value = f.partName;
  document.getElementById('partQty').value = f.partQty;
  document.getElementById('status').value = f.status;
  document.getElementById('addBtn').innerText = 'حفظ التعديل';
}

function saveEditFault(){
  const idx = faults.findIndex(x=>x.id===editingFaultId); if(idx===-1) return alert('خطأ التعديل');

  // Get the part changed value
  const partChanged = document.getElementById('partChanged').value;
  
  // Only use part fields if "yes" was selected
  const lcode = partChanged === 'yes' ? document.getElementById('lcode').value.trim() : '';
  const partName = partChanged === 'yes' ? document.getElementById('partName').value.trim() : '';
  const partQty = partChanged === 'yes' ? Number(document.getElementById('partQty').value||0) : 0;

  // حدّث في المصفوفة
  const selML2 = getSelectedMachineLineFromGroups('machineGroup','machineItem');
  faults[idx].machine = selML2.machine;
  faults[idx].line = selML2.line;
  faults[idx].person = getSelectedValues('person').join(', ');
  faults[idx].description = document.getElementById('description').value.trim();
  faults[idx].solution = document.getElementById('solution').value.trim();
  faults[idx].shift = document.getElementById('shift').value;
  faults[idx].date = formatDateOnly(document.getElementById('date').value);
  faults[idx].partChanged = partChanged;
  faults[idx].lcode = lcode;
  faults[idx].partName = partName;
  faults[idx].partQty = partQty;
  faults[idx].status = document.getElementById('status').value;

   // ابعت Update للـ Sheet
  const f = faults[idx];
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'fault', op: 'update', data: f })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('التعديل لم يُحفظ على السيرفر (Sheet)');
    })
    .catch(err => console.error('fault update error', err));

  editingFaultId = null;
  clearFaultForm(); 
  renderFaultTable(); 
  drawDashboard(); 
  show('faults');
  // إرسال إشعار عند تعديل عطل
  notifyAction('fault_edited', 'fault', faults[idx].machine);
  showSuccess('تم التعديل');
}

function moveToTrashFault(id){
  const f = faults.find(x=>x.id===id);
  if(!f) return;
  
  // حدّث حقل Delete إلى True في السيرفر
  f.deleted = true;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'fault', op: 'update', data: f })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('مشكلة في تحديث الحذف على السيرفر');
    })
    .catch(err => console.error('fault move to trash error', err));

  // انقل من faults إلى trash محليًا
  const idx = faults.findIndex(x=>x.id===id);
  if(idx !== -1) {
    const deletedFault = faults.splice(idx,1)[0];
    trash.faults.unshift(deletedFault);
    saveAll();
    renderFaultTable();
    renderTrash();
    drawDashboard();
    // إرسال إشعار عند حذف عطل
    notifyAction('fault_deleted', 'fault', deletedFault.machine);
    showSuccess('تم الحذف');
  }
}

function restoreFault(id){
  const f = trash.faults.find(x=>x.id===id);
  if(!f) return;
  
  // حدّث حقل Delete إلى False في السيرفر
  f.deleted = false;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'fault', op: 'update', data: f })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('مشكلة في استرجاع السجل من السيرفر');
    })
    .catch(err => console.error('fault restore error', err));

  // انقل من trash إلى faults محليًا
  const idx = trash.faults.findIndex(x=>x.id===id);
  if(idx !== -1) {
    faults.unshift(trash.faults.splice(idx,1)[0]);
    saveAll();
    renderFaultTable();
    renderTrash();
    drawDashboard();
  }
}
// function permanentDeleteFault(id){ const idx = trash.faults.findIndex(x=>x.id===id); if(idx===-1) return; if(!confirm('حذف نهائي؟')) return; trash.faults.splice(idx,1); saveAll(); renderTrash(); }
function permanentDeleteFault(id){
  const idx = trash.faults.findIndex(x=>x.id===id);
  if(idx===-1) return;
  if(!confirm('حذف نهائي؟')) return;
  stopTrashSync();

  // حذف محلي فوري
  trash.faults.splice(idx,1);
  saveAll(); renderTrash();
  console.log('✓ تم حذف العطل محليًا:', id);

  // إرسال للسيرفر في الخلفية (بدون انتظار)
  apiPost({ kind: 'fault', op: 'delete', data: { id } })
    .then(res => {
      console.log('✓ استجابة السيرفر:', res);
      if(res.ok || (res.json && res.json.ok)) console.log('✓ تم حذف من السيرفر');
      else console.warn('⚠ السيرفر لم يؤكد الحذف:', res.text || res.statusText);
    })
    .catch(err => console.error('⚠ خطأ الإرسال للسيرفر:', err))
    .finally(() => startTrashSync());
}


/* CRUD orders */
// ═════════════════════════════════════════════════════════════════
// 8. عمليات CRUD لأوامر الشراء
// ═════════════════════════════════════════════════════════════════
let editingOrderId = null;
document.getElementById('addOrderBtn').addEventListener('click', ()=> {
  if(editingOrderId) return saveEditOrder(); addOrder();});
document.getElementById('clearOrderBtn').addEventListener('click', clearOrderForm);

function addOrder(){
  // تأكد من اختيار القائم/القائمين على أمر الشراء
  if(getSelectedValues('orderPerson').length === 0){ alert('من فضلك اختر القائم على أمر الشراء.'); return; }
  const o = { 
    id: uid(), 
    orderNum: document.getElementById('orderNum').value.trim(), 
    supplyNum: document.getElementById('supplyNum').value.trim(), 
    date: formatDateOnly(document.getElementById('orderDate').value), 
    person: getSelectedValues('orderPerson').join(', '), 
    details: document.getElementById('orderDetails').value.trim() 
  };
  fetch(API_URL, {
  method: 'POST',
  // headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({ kind: 'order', op: 'add', data: o })
}).then(r => r.json())
  .then(res => {
    if (!res.ok) alert('مشكلة في حفظ الأمر على السيرفر، هيتحفظ Local بس');
  }).catch(err => {
    console.error(err);
    alert('السيرفر مش متاح حاليًا، هيتحفظ Local بس');
  });
  orders.unshift(o); clearOrderForm(); currentPageOrders = 1; renderOrderTable(); renderTrash();
  // إرسال إشعار عند إضافة أمر شراء
  notifyAction('order_added', 'order', o.orderNum || 'جديد');
  showSuccess('تم الإدخال');
}
function startEditOrder(id){
  const o = orders.find(x=>x.id===id); if(!o) return alert('غير موجود');
  editingOrderId = id;
  document.getElementById('orderNum').value = o.orderNum;
  document.getElementById('supplyNum').value = o.supplyNum;
  document.getElementById('orderDate').value = o.date;
  // set multi-select values and render chips
  setMultiSelectValues('orderPerson', o.person);
  renderSelectedChips('orderPerson','orderPersonChips');
  document.getElementById('orderDetails').value = o.details;
  document.getElementById('addOrderBtn').innerText = 'حفظ التعديل';
}
// function saveEditOrder(){ const idx=orders.findIndex(x=>x.id===editingOrderId); if(idx===-1) return; orders[idx].orderNum=document.getElementById('orderNum').value.trim(); orders[idx].supplyNum=document.getElementById('supplyNum').value.trim(); orders[idx].date=document.getElementById('orderDate').value; orders[idx].person=document.getElementById('orderPerson').value.trim(); orders[idx].details=document.getElementById('orderDetails').value.trim(); editingOrderId=null; clearOrderForm(); renderOrderTable(); }
function saveEditOrder(){
  const idx = orders.findIndex(x=>x.id===editingOrderId); 
  if(idx===-1) return;

  // تأكد من اختيار القائم/القائمين على أمر الشراء عند الحفظ
  if(getSelectedValues('orderPerson').length === 0){ alert('من فضلك اختر القائم على أمر الشراء.'); return; }

  orders[idx].orderNum = document.getElementById('orderNum').value.trim();
  orders[idx].supplyNum= document.getElementById('supplyNum').value.trim();
  orders[idx].date     = formatDateOnly(document.getElementById('orderDate').value);
  orders[idx].person   = getSelectedValues('orderPerson').join(', ');
  orders[idx].details  = document.getElementById('orderDetails').value.trim();

  const o = orders[idx];
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'order', op: 'update', data: o })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('تعديل الأمر لم يُحفظ على السيرفر');
    })
    .catch(err => console.error('order update error', err));

  editingOrderId=null; 
  clearOrderForm(); 
  renderOrderTable();
  // إرسال إشعار عند تعديل أمر شراء
  notifyAction('order_edited', 'order', orders[idx].orderNum || 'تعديل');
  showSuccess('تم التعديل');
}

function clearOrderForm(){ 
  document.getElementById('orderNum').value=''; 
  document.getElementById('supplyNum').value=''; 
  document.getElementById('orderDate').value=getTodayDate(); 
  setMultiSelectValues('orderPerson',''); renderSelectedChips('orderPerson','orderPersonChips');
  document.getElementById('orderDetails').value=''; 
  editingOrderId=null; 
  document.getElementById('addOrderBtn').innerText='إضافة أمر'; 
}

function moveToTrashOrder(id){
  const o = orders.find(x=>x.id===id);
  if(!o) return;
  
  // حدّث حقل Delete إلى True في السيرفر
  o.deleted = true;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'order', op: 'update', data: o })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('مشكلة في تحديث الحذف على السيرفر');
    })
    .catch(err => console.error('order move to trash error', err));

  // انقل من orders إلى trash محليًا
  const idx = orders.findIndex(x=>x.id===id);
  if(idx !== -1) {
    const deletedOrder = orders.splice(idx,1)[0];
    trash.orders.unshift(deletedOrder);
    saveAll();
    renderOrderTable();
    renderTrash();
    // إرسال إشعار عند حذف أمر شراء
    notifyAction('order_deleted', 'order', deletedOrder.orderNum || 'حذف');
    showSuccess('تم الحذف');
  }
}

function restoreOrder(id){
  const o = trash.orders.find(x=>x.id===id);
  if(!o) return;
  
  // حدّث حقل Delete إلى False في السيرفر
  o.deleted = false;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'order', op: 'update', data: o })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('مشكلة في استرجاع السجل من السيرفر');
    })
    .catch(err => console.error('order restore error', err));

  // انقل من trash إلى orders محليًا
  const idx = trash.orders.findIndex(x=>x.id===id);
  if(idx !== -1) {
    orders.unshift(trash.orders.splice(idx,1)[0]);
    saveAll();
    renderOrderTable();
    renderTrash();
  }
}
function permanentDeleteOrder(id){
  const idx = trash.orders.findIndex(x=>x.id===id);
  if(idx===-1) return;
  if(!confirm('حذف نهائي؟')) return;
  stopTrashSync();

  // حذف محلي فوري
  trash.orders.splice(idx,1);
  saveAll(); renderTrash();
  console.log('✓ تم حذف الأمر محليًا:', id);

  // إرسال للسيرفر في الخلفية
  apiPost({ kind: 'order', op: 'delete', data: { id } })
    .then(res => {
      console.log('✓ استجابة السيرفر:', res);
      if(res.ok || (res.json && res.json.ok)) console.log('✓ تم حذف من السيرفر');
      else console.warn('⚠ السيرفر لم يؤكد الحذف:', res.text || res.statusText);
    })
    .catch(err => console.error('⚠ خطأ الإرسال للسيرفر:', err))
    .finally(() => startTrashSync());
}

// function permanentDeleteOrder(id){ const idx=trash.orders.findIndex(x=>x.id===id); if(idx===-1) return; if(!confirm('حذف نهائي؟')) return; trash.orders.splice(idx,1); saveAll(); renderTrash(); }

/* MAINTENANCE CRUD */
// ═════════════════════════════════════════════════════════════════
// 9. عمليات CRUD للصيانة
// ═════════════════════════════════════════════════════════════════
let editingMaintenanceId = null;
document.getElementById('addMaintenanceBtn').addEventListener('click', ()=> {
  if(editingMaintenanceId) return saveEditMaintenance(); addMaintenance();});
document.getElementById('clearMaintenanceBtn').addEventListener('click', clearMaintenanceForm);

function addMaintenance(){
  const selMainML = getSelectedMachineLineFromGroups('mainGroup','mainItem');
  
  // التحقق من الحقول المطلوبة حسب نوع المجموعة
  const mainDateVal = formatDateOnly(document.getElementById('mainDate').value);
  if(selMainML.line === 'معمل الجودة') {
    // عند اختيار "معمل الجودة"، اطلب اسم الماكينة والقائم بالصيانة والتاريخ
    const customName = document.getElementById('customMainName').value.trim();
    if(!customName) {
      alert('من فضلك ادخل اسم الماكينة');
      return;
    }
    // التحقق من القائم بالصيانة
    if(getSelectedValues('mainPerson').length === 0){ 
      alert('من فضلك اختر اسم/أسماء القائم بالصيانة.');
      return; 
    }
    // التحقق من التاريخ (إجباري لمعمل الجودة)
    if(!mainDateVal){
      alert('من فضلك اختر التاريخ.');
      return;
    }
  } else if(selMainML.line === 'أخري') {
    // عند اختيار "أخري"، يجب ملء حقل مكان الماكينة واسم الماكينة
    const place = document.getElementById('customMainPlace').value.trim();
    const customName = document.getElementById('customMainName').value.trim();
    if(!place) {
      alert('من فضلك أدخل مكان الماكينة');
      return;
    }
    if(!customName) {
      alert('من فضلك ادخل اسم الماكينة');
      return;
    }
    if(getSelectedValues('mainPerson').length === 0){ 
      alert('من فضلك اختر اسم/أسماء القائم بالصيانة.');
      return; 
    }
    // التحقق من التاريخ لحالة "أخري"
    if(!mainDateVal){
      alert('من فضلك اختر التاريخ.');
      return;
    }
  } else {
    // عند اختيار مجموعة عادية، يجب:
    // 1. اختيار الماكينة من القائمة
    // 2. اختيار اسم/أسماء القائم بالصيانة
    if(!selMainML.machine) {
      alert('من فضلك اختر الماكينة');
      return;
    }
    if(getSelectedValues('mainPerson').length === 0){ 
      alert('من فضلك اختر اسم/أسماء القائم بالصيانة.');
      return; 
    }
    // التحقق من التاريخ أيضاً (عام)
    if(!mainDateVal){
      alert('من فضلك اختر التاريخ.');
      return;
    }
  }
  
  const partChanged = document.getElementById('mainPartChanged').value;
  const m = { 
    id: uid(), 
    machine: selMainML.machine, 
    line: selMainML.line, 
    person: getSelectedValues('mainPerson').join(', '), 
    date: formatDateOnly(document.getElementById('mainDate').value), 
    partChanged: partChanged,
    lcode: partChanged === 'yes' ? document.getElementById('mainLcode').value.trim() : '', 
    partName: partChanged === 'yes' ? document.getElementById('mainPartName').value.trim() : '', 
    partQty: partChanged === 'yes' ? document.getElementById('mainPartQty').value.trim() : '', 
    type: document.getElementById('mainType').value.trim(), 
    notes: document.getElementById('mainNotes').value.trim() 
  };
  
  // ابعت للـ Server
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'maintenance', op: 'add', data: m })
  }).then(r => r.json())
    .then(res => {
      if (!res.ok) alert('في مشكلة في حفظ الصيانة على السيرفر، هيتحفظ Local بس');
    }).catch(err => {
      console.error(err);
      alert('السيرفر مش متاح حاليًا، هيتحفظ Local بس');
    });
  
  maintenance.unshift(m); 
  saveAll();
  clearMaintenanceForm(); 
  currentPageMaintenance = 1;
  renderMaintenanceTable(); 
  renderTrash();
  // إرسال إشعار عند إضافة صيانة
  notifyAction('maintenance_added', 'maintenance', m.machine);
  showSuccess('تم الإدخال');
  // عرض إشعار الصيانة الأخيرة مباشرة
  showLatestMaintenanceNotification();
}

function startEditMaintenance(id){
  const m = maintenance.find(x=>x.id===id); 
  if(!m) return alert('غير موجود'); 
  editingMaintenanceId=id; 
  setGroupSelection('mainGroup','mainItem', m.machine, m.line);
  // إذا كان الخط "أخري"، املأ حقول النص الحر
  if(m.line === 'أخري') {
    // استخراج مكان الماكينة واسم الماكينة من m.machine
    const parts = m.machine.split(' - ');
    if(parts.length === 2) {
      document.getElementById('customMainPlace').value = parts[0].trim();
      document.getElementById('customMainName').value = parts[1].trim();
    } else {
      document.getElementById('customMainPlace').value = '';
      document.getElementById('customMainName').value = m.machine;
    }
  } else {
    document.getElementById('customMainPlace').value = '';
    document.getElementById('customMainName').value = '';
  }
  setMultiSelectValues('mainPerson', m.person);
  renderSelectedChips('mainPerson','mainPersonChips'); 
  document.getElementById('mainDate').value=m.date; 
  document.getElementById('mainPartChanged').value = m.partChanged || 'no';
  document.getElementById('mainLcode').value=m.lcode || ''; 
  document.getElementById('mainPartName').value=m.partName || ''; 
  document.getElementById('mainPartQty').value=m.partQty || '0'; 
  document.getElementById('mainPartFieldsContainer').style.display = (m.partChanged === 'yes') ? 'block' : 'none';
  document.getElementById('mainType').value=m.type; 
  document.getElementById('mainNotes').value=m.notes; 
  document.getElementById('addMaintenanceBtn').innerText='حفظ التعديل';
}

function saveEditMaintenance(){
  const idx = maintenance.findIndex(x=>x.id===editingMaintenanceId); 
  if(idx===-1) return;

  const selMainML2 = getSelectedMachineLineFromGroups('mainGroup','mainItem');
  const partChanged = document.getElementById('mainPartChanged').value;
  maintenance[idx].machine  = selMainML2.machine;
  maintenance[idx].line     = selMainML2.line;
  maintenance[idx].person   = getSelectedValues('mainPerson').join(', ');
  maintenance[idx].date     = formatDateOnly(document.getElementById('mainDate').value);
  maintenance[idx].partChanged = partChanged;
  maintenance[idx].lcode    = partChanged === 'yes' ? document.getElementById('mainLcode').value.trim() : '';
  maintenance[idx].partName = partChanged === 'yes' ? document.getElementById('mainPartName').value.trim() : '';
  maintenance[idx].partQty  = partChanged === 'yes' ? document.getElementById('mainPartQty').value.trim() : '';
  maintenance[idx].type     = document.getElementById('mainType').value.trim();
  maintenance[idx].notes    = document.getElementById('mainNotes').value.trim();

  // ابعت Update للـ Sheet
  const m = maintenance[idx];
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'maintenance', op: 'update', data: m })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('التعديل لم يُحفظ على السيرفر (Sheet)');
    })
    .catch(err => {
      console.error(err);
      alert('السيرفر مش متاح، التعديل اتحفظ Local بس');
    });

  editingMaintenanceId=null; 
  clearMaintenanceForm(); 
  renderMaintenanceTable();
  // إرسال إشعار عند تعديل صيانة
  notifyAction('maintenance_edited', 'maintenance', maintenance[idx].machine);
  showSuccess('تم التعديل');
}

function clearMaintenanceForm(){ 
  document.getElementById('mainGroup').value = '';
  populateItemsForGroup('', 'mainItem');
  document.getElementById('customMainPlace').value = '';
  document.getElementById('customMainName').value = '';
  setMultiSelectValues('mainPerson',''); renderSelectedChips('mainPerson','mainPersonChips'); 
  document.getElementById('mainDate').value=getTodayDate(); 
  document.getElementById('mainPartChanged').value='no';
  document.getElementById('mainLcode').value=''; 
  document.getElementById('mainPartName').value=''; 
  document.getElementById('mainPartQty').value='0'; 
  document.getElementById('mainPartFieldsContainer').style.display='none';
  document.getElementById('mainType').value='أسبوعية'; 
  document.getElementById('mainNotes').value=''; 
  editingMaintenanceId=null; 
  document.getElementById('addMaintenanceBtn').innerText='إضافة صيانة'; 
}

function moveToTrashMaintenance(id){
  const idx = maintenance.findIndex(x=>x.id===id);
  if(idx === -1) return;
  
  // علّم كـ deleted = true (soft delete)
  maintenance[idx].deleted = true;
  
  // ابعت للـ Server كـ update (يخليها في الشيت بـ deleted = true)
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'maintenance', op: 'update', data: maintenance[idx] })
  }).then(r=>r.json())
    .catch(err => console.error('خطأ في الحذف:', err));
  
  // اسحب من maintenance وحطها في trash
  const movedItem = maintenance.splice(idx,1)[0];
  trash.maintenance.unshift(movedItem);
  
  saveAll();
  renderMaintenanceTable();
  renderTrash();
  // إرسال إشعار عند حذف صيانة
  notifyAction('maintenance_deleted', 'maintenance', movedItem.machine);
  showSuccess('تم الحذف');
}

function restoreMaintenance(id){
  const idx = trash.maintenance.findIndex(x=>x.id===id);
  if(idx === -1) return;
  
  // اسحب من trash وعلّم deleted = false
  const restoredItem = trash.maintenance.splice(idx,1)[0];
  restoredItem.deleted = false;
  
  // ابعت للـ Server كـ update (يخليها في الشيت بـ deleted = false)
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'maintenance', op: 'update', data: restoredItem })
  }).then(r=>r.json())
    .catch(err => console.error('خطأ في الاسترجاع:', err));
  
  maintenance.unshift(restoredItem);
  saveAll();
  renderMaintenanceTable();
  renderTrash();
}

function permanentDeleteMaintenance(id){
  const idx = trash.maintenance.findIndex(x=>x.id===id);
  if(idx===-1) return;
  if(!confirm('حذف نهائي؟')) return;
  stopTrashSync();

  // حذف محلي فوري
  trash.maintenance.splice(idx,1);
  saveAll(); renderTrash();
  console.log('✓ تم حذف الصيانة محليًا:', id);

  // إرسال للسيرفر في الخلفية
  apiPost({ kind: 'maintenance', op: 'delete', data: { id } })
    .then(res => {
      console.log('✓ استجابة السيرفر:', res);
      if(res.ok || (res.json && res.json.ok)) console.log('✓ تم حذف من السيرفر');
      else console.warn('⚠ السيرفر لم يؤكد الحذف:', res.text || res.statusText);
    })
    .catch(err => console.error('⚠ خطأ الإرسال للسيرفر:', err))
    .finally(() => startTrashSync());
}

/* MAINTENANCE FILTERS */
// ═════════════════════════════════════════════════════════════════
// 10. تصفية وفلترة سجلات الصيانة
// ═════════════════════════════════════════════════════════════════
document.getElementById('applyMaintenanceFilterBtn').addEventListener('click', applyMaintenanceFilters);
function applyMaintenanceFilters(){ 
  const q=(document.getElementById('searchMaintenance').value||'').toLowerCase();
  const filterType = (document.getElementById('filterMaintenanceType')?.value||'').trim();
  const dateFrom = document.getElementById('dateFromMaintenance')?.value;
  const dateTo = document.getElementById('dateToMaintenance')?.value;

  // عرض البطاقات على الموبايل إذا وُجدت
  const cardsContainer = document.getElementById('maintenanceCards');
  if(cardsContainer) cardsContainer.style.display = '';

  // حدّد حالة الفلترة بناءً على الحقول الحالية
  const active = Boolean(q || filterType || dateFrom || dateTo);
  isFilteredMaintenance = active;
  currentPageMaintenance = 1;
  document.getElementById('maintenancePagination').style.display = isFilteredMaintenance ? 'none' : '';

  // إعادة عرض الجدول بحسب الحالة (filtered vs normal)
  renderMaintenanceTable();
}

// دالة منفصلة لفلتر التاريخ فقط
document.getElementById('applyDateFilterMaintenanceBtn')?.addEventListener('click', applyMaintenanceFilters);
document.getElementById('searchMaintenance')?.addEventListener('input', applyMaintenanceFilters);

/* MAINTENANCE EXPORTS */
document.getElementById('exportMaintenanceCsv').addEventListener('click', ()=>{
  const visibleRows = Array.from(document.querySelectorAll('#maintenanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('لا توجد بيانات للتصدير'); return; }
  
  const headers=['#','machine','line','person','date','lcode','partName','partQty','type','notes'];
  const rows = [];
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    rows.push({
      '#': i+1,
      machine: cells[1].textContent,
      line: cells[2].textContent,
      person: cells[3].textContent,
      date: cells[4].textContent,
      lcode: cells[5].textContent,
      partName: cells[6].textContent,
      partQty: cells[7].textContent,
      type: cells[8].textContent,
      notes: cells[9].textContent
    });
  });
  const csv = arrayToCsv(headers, rows);
  downloadBlob(csv, `maintenance_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
});

document.getElementById('exportMaintenanceDoc').addEventListener('click', ()=>{
  if(!maintenance.length){ alert('لا توجد بيانات للتصدير'); return; }
  const title = 'تقرير الصيانة';
  const headers = ['#','الماكينة','الخط','القائم','التاريخ','L Number','القطعة','الكمية','النوع','الملاحظات'];
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body><h2 style="text-align:center">نظام إدارة الأعطال والصيانة — الكهرباء</h2><h3 style="text-align:center">${title}</h3><p>تاريخ: ${new Date().toLocaleDateString()}</p><table><thead><tr>${headers.map(h=>'<th>'+h+'</th>').join('')}</tr></thead><tbody>`;

  if(!isFilteredMaintenance){
    const allMaintenance = maintenance.filter(m => !m.deleted);
    if(!allMaintenance.length){ alert('لا توجد بيانات للتصدير'); return; }
    allMaintenance.forEach((m,i)=>{
      html += `<tr><td>${i+1}</td><td>${escapeHtml(m.machine||'')}</td><td>${escapeHtml(m.line||'')}</td><td>${escapeHtml(m.person||'')}</td><td>${escapeHtml(m.date||'')}</td><td>${escapeHtml(m.lcode||'')}</td><td>${escapeHtml(m.partName||'')}</td><td>${escapeHtml(m.partQty||'')}</td><td>${escapeHtml(m.type||'')}</td><td>${escapeHtml(m.notes||'')}</td></tr>`;
    });
    html += '</tbody></table></body></html>';
    downloadBlob(html, `maintenance_all_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
    return;
  }

  const visibleRows = Array.from(document.querySelectorAll('#maintenanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('لا توجد بيانات للتصدير'); return; }
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1]?.textContent||'')}</td><td>${escapeHtml(cells[2]?.textContent||'')}</td><td>${escapeHtml(cells[3]?.textContent||'')}</td><td>${escapeHtml(cells[4]?.textContent||'')}</td><td>${escapeHtml(cells[5]?.textContent||'')}</td><td>${escapeHtml(cells[6]?.textContent||'')}</td><td>${escapeHtml(cells[7]?.textContent||'')}</td><td>${escapeHtml(cells[8]?.textContent||'')}</td><td>${escapeHtml(cells[9]?.textContent||'')}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  downloadBlob(html, `maintenance_filtered_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
});

/* Print Current Page - Maintenance */
document.getElementById('printMaintenanceCurrentPage')?.addEventListener('click', ()=>{
  const visibleRows = Array.from(document.querySelectorAll('#maintenanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('لا توجد بيانات للطباعة'); return; }

  // ملخص إجمالي
  const totalMaint = visibleRows.length;
  const uniqueMachines = Array.from(new Set(visibleRows.map(tr=>tr.querySelectorAll('td')[1]?.textContent?.trim()).filter(Boolean)));
  let summaryHtml = '';
  if(totalMaint){
    summaryHtml = `<div style="background:#e8f7e8;color:#0A4C88;font-weight:700;padding:10px 18px;border-radius:8px;margin-bottom:12px;text-align:center;box-shadow:0 1px 6px #0001;font-size:16px">إجمالي الصيانات: <span style="color:#00796b">${totalMaint}</span> | عدد الماكينات: <span style="color:#00796b">${uniqueMachines.length}</span></div>`;
  }

  const title='تقرير الصيانة'; 
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>نظام إدارة الأعطال والصيانة — الكهرباء</h2><h3>${title}</h3><p>تاريخ: ${new Date().toLocaleDateString()}</p></div>`;
  html += summaryHtml;
  html += `<table><thead><tr><th>#</th><th>الماكينة</th><th>الخط</th><th>القائم</th><th>التاريخ</th><th>L Number</th><th>القطعة</th><th>الكمية</th><th>النوع</th><th>الملاحظات</th></tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td><td>${escapeHtml(cells[5].textContent)}</td><td>${escapeHtml(cells[6].textContent)}</td><td>${escapeHtml(cells[7].textContent)}</td><td>${escapeHtml(cells[8].textContent)}</td><td>${escapeHtml(cells[9].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  const w=window.open('','_blank'); 
  w.document.write(html); 
  w.document.close(); 
  setTimeout(()=>w.print(),300);
});

/* Print ALL - Maintenance (print plain full table, no grouped summary) */
document.getElementById('printMaintenanceBtn').removeEventListener('click', null);
document.getElementById('printMaintenanceBtn').addEventListener('click', ()=>{
  if(!maintenance || !maintenance.length){ alert('لا توجد بيانات للطباعة'); return; }

  // احصل على كل الصيانات الغير محذوفة
  const allMaintenance = maintenance.filter(m => !m.deleted);
  if(!allMaintenance.length){ alert('لا توجد بيانات للطباعة'); return; }

  const title='تقرير الصيانة';
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>نظام إدارة الأعطال والصيانة — الكهرباء</h2><h3>${title}</h3><p>تاريخ: ${new Date().toLocaleDateString()}</p></div>`;
  // احسب ملخص بسيط (عدد الماكينات وأنواع الصيانة)
  const uniqueMachines = Array.from(new Set(allMaintenance.map(m => (m.machine||'').trim()).filter(Boolean)));
  const weeklyCount = allMaintenance.filter(m => m.type === 'أسبوعية').length;
  const monthlyCount = allMaintenance.filter(m => m.type === 'شهرية').length;
  const quarterCount = allMaintenance.filter(m => m.type === 'ربع سنوي').length;
  const yearlyCount = allMaintenance.filter(m => m.type === 'سنوية').length;
  html += `<div style="text-align:center;margin:8px 0 14px 0;font-weight:700">عدد الماكينات: <span style="color:#00796b">${uniqueMachines.length}</span> | أسبوعية: <span style="color:#00796b">${weeklyCount}</span> | شهرية: <span style="color:#00796b">${monthlyCount}</span> | ربع سنوي: <span style="color:#00796b">${quarterCount}</span> | سنوية: <span style="color:#00796b">${yearlyCount}</span></div>`;
  html += `<table><thead><tr><th>#</th><th>الماكينة</th><th>الخط</th><th>القائم</th><th>التاريخ</th><th>L Number</th><th>القطعة</th><th>الكمية</th><th>النوع</th><th>الملاحظات</th></tr></thead><tbody>`;
  allMaintenance.forEach((m, i)=> {
    html += `<tr><td>${i+1}</td><td>${escapeHtml(m.machine)}</td><td>${escapeHtml(m.line)}</td><td>${escapeHtml(m.person)}</td><td>${escapeHtml(m.date)}</td><td>${escapeHtml(m.lcode)}</td><td>${escapeHtml(m.partName)}</td><td>${escapeHtml(m.partQty)}</td><td>${escapeHtml(m.type)}</td><td>${escapeHtml(m.notes||'')}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  const w=window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=>w.print(),300);
});

            document.getElementById('emptyTrashBtn').addEventListener('click', () => {
  if (!confirm('حذف نهائي لكل المحذوفات (أعطال وأوامر وصيانات)؟')) return;

  // جهّز الـ IDs اللي هتتمسح من الشيت
  const faultIds = (trash.faults || []).map(f => f.id);
  const orderIds = (trash.orders || []).map(o => o.id);
  const maintenanceIds = (trash.maintenance || []).map(m => m.id);
  const attendanceIds = (trash.attendance || []).map(a => a.id);
  
  const totalItems = faultIds.length + orderIds.length + maintenanceIds.length + attendanceIds.length;
  console.log('🗑️ حذف نهائي - الأعطال:', faultIds.length, 'الأوامر:', orderIds.length, 'الصيانات:', maintenanceIds.length, 'الحضور:', attendanceIds.length, 'الإجمالي:', totalItems);

  // اذا مافيش حاجة للحذف
  if (totalItems === 0) {
    alert('السلة فارغة - لا يوجد شيء للحذف');
    return;
  }

  // حذف محلي فوري
  trash = { faults: [], orders: [], maintenance: [], attendance: [] };
  saveAll(); renderTrash();
  console.log('✅ تم حذف كل ' + totalItems + ' سجل محليًا');
  alert('تم حذف ' + totalItems + ' سجل نهائيًا!');

  // إرسال طلبات الحذف للسيرفر في الخلفية (بدون انتظار)
  const allIds = [];
  faultIds.forEach(id=> allIds.push({ kind: 'fault', id }));
  orderIds.forEach(id=> allIds.push({ kind: 'order', id }));
  maintenanceIds.forEach(id=> allIds.push({ kind: 'maintenance', id }));
  attendanceIds.forEach(id=> allIds.push({ kind: 'attendance', id }));

  allIds.forEach(x => {
    apiPost({ kind: x.kind, op: 'delete', data: { id: x.id } })
      .then(res => console.log('✓ حذف من السيرفر:', x.kind, x.id, res))
      .catch(err => console.warn('⚠ خطأ في حذف السيرفر:', x.kind, x.id, err));
  });

  // حاول إعادة تحميل السلة من السيرفر بعد تأخير
  setTimeout(() => {
    loadTrashFromServer().catch(e => console.log('تحديث السلة من السيرفر:', e));
  }, 2000);
});

/* ATTENDANCE: CRUD, render, exports */
// ═════════════════════════════════════════════════════════════════
// 12. عمليات CRUD وتصدير سجلات الأجازات والحضور
// ═════════════════════════════════════════════════════════════════
let editingAttendanceId = null;

// أسماء الأيام بالعربي
const arabicDayNames = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];

// دالة لحساب أيام الأجازة تلقائياً
function calculateVacationDays(startDateStr, numDays) {
  const startDate = new Date(startDateStr);
  const dayNames = [];
  
  for (let i = 0; i < numDays; i++) {
    const currentDate = new Date(startDate);
    currentDate.setDate(startDate.getDate() + i);
    const dayIndex = currentDate.getDay();
    dayNames.push(arabicDayNames[dayIndex]);
  }
  
  return dayNames.join(', ');
}

document.getElementById('addAttendanceBtn').addEventListener('click', ()=>{ if(editingAttendanceId) return saveEditAttendance(); addAttendance(); });
document.getElementById('clearAttendanceBtn').addEventListener('click', clearAttendanceForm);

function clearAttendanceForm(){
  editingAttendanceId = null;
  document.getElementById('workerName').value=''; 
  document.getElementById('workerNum').value=''; 
  document.getElementById('absenceDate').value=getTodayDate(); 
  document.getElementById('daysCount').value=1;
  document.getElementById('vacationType').value='';
  document.getElementById('addAttendanceBtn').innerText='إضافة سجل';
}

function addAttendance(){
  const startDate = formatDateOnly(document.getElementById('absenceDate').value);
  const daysCount = Number(document.getElementById('daysCount').value||1);
  const vacationType = document.getElementById('vacationType').value.trim();
  
  if (!startDate) {
    alert('الرجاء إدخال تاريخ بداية الأجازة');
    return;
  }
  
  if (!vacationType) {
    alert('الرجاء اختيار نوع الاجازة');
    return;
  }
  
  // احسب أيام الأجازة تلقائياً
  const daysName = calculateVacationDays(startDate, daysCount);
  
  const a = { 
    id: uid(), 
    workerName: document.getElementById('workerName').value.trim(), 
    workerNum: document.getElementById('workerNum').value.trim(), 
    absenceDate: startDate, 
    daysCount: daysCount, 
    absenceDay: daysName,  // الأيام محسوبة تلقائياً
    vacationType: vacationType
  };
  
  // ابعت للـ Server
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'add', data: a })
  }).then(r => r.json())
    .then(res => {
      if (!res.ok) alert('مشكلة في حفظ السجل على السيرفر، هيتحفظ Local بس');
    }).catch(err => {
      console.error(err);
      alert('السيرفر مش متاح حاليًا، هيتحفظ Local بس');
    });
  
  attendance.unshift(a);
  // Unlock attendance for this session and mark that only the newly added record should be visible
  try{ sessionStorage.setItem('attendanceUnlocked','true'); sessionStorage.setItem('attendanceVisibleOnlyId', a.id); }catch(e){}
  clearAttendanceForm(); currentPageAttendance = 1; renderAttendanceTable(); show('attendance');
  // إرسال إشعار عند إضافة أجازة
  notifyAction('attendance_added', 'attendance', a.workerName);
  showSuccess('تم الإدخال');
}

function startEditAttendance(id){ 
  const a = attendance.find(x=>x.id===id); 
  if(!a) return alert('السجل غير موجود'); 
  editingAttendanceId = id; 
  document.getElementById('workerName').value=a.workerName; 
  // trigger the change event to auto-fill the worker number
  document.getElementById('workerName').dispatchEvent(new Event('change'));
  document.getElementById('absenceDate').value=a.absenceDate; 
  document.getElementById('daysCount').value=a.daysCount;
  document.getElementById('vacationType').value=a.vacationType || '';
  document.getElementById('addAttendanceBtn').innerText='حفظ التعديل'; 
}

function saveEditAttendance(){ 
  const idx = attendance.findIndex(x=>x.id===editingAttendanceId); 
  if(idx===-1) return alert('خطأ التعديل');
  
  const startDate = formatDateOnly(document.getElementById('absenceDate').value);
  const daysCount = Number(document.getElementById('daysCount').value||1);
  const vacationType = document.getElementById('vacationType').value.trim();
  
  if (!vacationType) {
    alert('الرجاء اختيار نوع الاجازة');
    return;
  }
  
  // احسب الأيام تلقائياً
  const daysName = calculateVacationDays(startDate, daysCount);
  
  attendance[idx].workerName = document.getElementById('workerName').value.trim(); 
  attendance[idx].workerNum = document.getElementById('workerNum').value.trim(); 
  attendance[idx].absenceDate = startDate; 
  attendance[idx].daysCount = daysCount;
  attendance[idx].absenceDay = daysName;
  attendance[idx].vacationType = vacationType;
  
  // ابعت Update للـ Server
  const a = attendance[idx];
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'update', data: a })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('التعديل لم يُحفظ على السيرفر');
    })
    .catch(err => console.error('attendance update error', err));
  
  editingAttendanceId = null; 
  clearAttendanceForm(); 
  renderAttendanceTable(); 
  // إرسال إشعار عند تعديل أجازة
  notifyAction('attendance_edited', 'attendance', attendance[idx].workerName);
  showSuccess('تم التعديل');
}

function deleteAttendance(id){
  if(!confirm('حذف السجل؟')) return;
  const idx = attendance.findIndex(x=>x.id===id);
  if(idx===-1) return;
  
  const item = attendance[idx];
  // حدّث حقل Delete إلى True في السيرفر
  item.deleted = true;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'update', data: item })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('مشكلة في تحديث الحذف على السيرفر');
    })
    .catch(err => console.error('attendance move to trash error', err));
  
  // move to trash.attendance
  const movedItem = attendance.splice(idx,1)[0];
  if(!trash.attendance) trash.attendance = [];
  trash.attendance.unshift(movedItem);
  saveAll();
  renderAttendanceTable();
  renderTrash();
  // إرسال إشعار عند حذف أجازة
  notifyAction('attendance_deleted', 'attendance', movedItem.workerName);
}

function restoreAttendance(id){
  const idx = trash.attendance.findIndex(x=>x.id===id);
  if(idx===-1) return;
  
  const item = trash.attendance[idx];
  // حدّث حقل Delete إلى False في السيرفر
  item.deleted = false;
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({ kind: 'attendance', op: 'update', data: item })
  }).then(r=>r.json())
    .then(res => {
      if(!res.ok) alert('مشكلة في استرجاع السجل من السيرفر');
    })
    .catch(err => console.error('attendance restore error', err));
  
  // انقل من trash إلى attendance محليًا
  const movedItem = trash.attendance.splice(idx,1)[0];
  attendance.unshift(movedItem);
  saveAll();
  renderAttendanceTable();
  renderTrash();
}

function permanentDeleteAttendance(id){
  const idx = trash.attendance.findIndex(x=>x.id===id);
  if(idx===-1) return;
  if(!confirm('حذف نهائي؟')) return;
  stopTrashSync();

  // حذف محلي فوري
  trash.attendance.splice(idx,1);
  saveAll(); renderTrash();
  console.log('✓ تم حذف سجل الحضور محليًا:', id);

  // إرسال للسيرفر في الخلفية
  apiPost({ kind: 'attendance', op: 'delete', data: { id } })
    .then(res => {
      console.log('✓ استجابة السيرفر:', res);
      if(res.ok || (res.json && res.json.ok)) console.log('✓ تم حذف من السيرفر');
      else console.warn('⚠ السيرفر لم يؤكد الحذف:', res.text || res.statusText);
    })
    .catch(err => console.error('⚠ خطأ الإرسال للسيرفر:', err))
    .finally(() => startTrashSync());
}

function renderAttendanceTable(){ 
  const tbody = document.querySelector('#attendanceTable tbody'); 
  tbody.innerHTML=''; 
  const cardsDiv = document.getElementById('attendanceCards'); 
  cardsDiv.innerHTML=''; 
  const attendanceUnlocked = (sessionStorage.getItem('attendanceUnlocked') === 'true');
  // إذا كانت البطاقات/الطاولة مقفلة، لا نعرض أي بيانات على الديسكتوب أو الموبايل
  if(!attendanceUnlocked){
    try{ document.getElementById('attendancePagination').style.display = 'none'; }catch(e){}
    // leave table and cards empty while locked
    saveAll();
    return;
  }
  // اقرأ شروط الفلترة الحالية
  const q = (document.getElementById('searchAttendance')?.value||'').toLowerCase();
  const searchBy = 'name';
  const dateFrom = document.getElementById('dateFromAttendance')?.value;
  const dateTo = document.getElementById('dateToAttendance')?.value;

  let dataToRender = [];
  let totalPages = 1;
  const visibleOnlyId = sessionStorage.getItem('attendanceVisibleOnlyId');
  if(visibleOnlyId){
    const found = attendance.find(x=>x.id === visibleOnlyId && !x.deleted);
    if(found){ dataToRender = [found]; totalPages = 1; }
    else {
      // If the requested visible-only record isn't loaded yet, do not fall back
      // to showing all records (this prevents unlocking from exposing all cards
      // before data arrives). Hide pagination and return early.
      try{ document.getElementById('attendancePagination').style.display = 'none'; }catch(e){}
      saveAll();
      return;
    }
  }
  
  if(isFilteredAttendance){
    if(!visibleOnlyId){
      dataToRender = attendance.filter(a => {
      if(a.deleted) return false;
      const name = (a.workerName || a.personName || a.empName || a.emp || '').toString();
      const num = (a.workerNum || a.personId || '').toString();
      const text = `${name} ${num} ${a.absenceDate||a.date||''} ${a.notes||''}`.toLowerCase();
      const rowDate = (a.absenceDate || a.date || '').toString();
      let dateMatch = true;
      if(dateFrom && dateTo) dateMatch = (rowDate >= dateFrom && rowDate <= dateTo);
      else if(dateFrom) dateMatch = (rowDate >= dateFrom);
      else if(dateTo) dateMatch = (rowDate <= dateTo);
      // respect searchBy: 'name'|'num'|'all'
      let match = true;
      if(q){
        if(searchBy === 'name') match = name.toLowerCase().includes(q);
        else if(searchBy === 'num') match = num.toLowerCase().includes(q);
        else match = text.includes(q);
      }
      return match && dateMatch;
    });
    totalPages = 1;
    }
  } else {
    if(!visibleOnlyId){
      const paginationData = paginate(attendance, currentPageAttendance);
      dataToRender = paginationData.items;
      totalPages = paginationData.totalPages;
    }
  }

  dataToRender.forEach((a, pageIndex)=>{
    const globalIndex = isFilteredAttendance ? pageIndex + 1 : (currentPageAttendance - 1) * ITEMS_PER_PAGE + pageIndex + 1;
    const tr=document.createElement('tr'); 
    const name = escapeHtml(a.workerName || a.personName || a.empName || a.emp || '');
    const num = escapeHtml(a.workerNum || a.personId || '');
    const date = escapeHtml(a.absenceDate || a.date || '');
    const days = escapeHtml(a.daysCount || a.days || '');
    const dayName = escapeHtml(a.absenceDay || a.dayType || '');
    const vacationType = escapeHtml(a.vacationType || '');
    tr.innerHTML = `<td>${globalIndex}</td><td>${name}</td><td>${num}</td><td>${date}</td><td>${days}</td><td>${dayName}</td><td>${vacationType}</td><td class="no-print actions"><button class="btn ghost" onclick="startEditAttendance('${a.id}')">تعديل</button><button class="btn" onclick="deleteAttendance('${a.id}')">حذف</button></td>`; 
    tbody.appendChild(tr);

    const card = document.createElement('div');
    card.className = 'order-card';
    // Minimal attendance card for mobile: show same columns as desktop table
    card.innerHTML = `
      <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">إجازة #${globalIndex}</div>
      <div class="order-card-row"><div class="order-card-label">اسم العامل:</div><div class="order-card-value">${displayValue(name)}</div></div>
      <div class="order-card-row"><div class="order-card-label">رقم العامل:</div><div class="order-card-value">${displayValue(num)}</div></div>
      <div class="order-card-row"><div class="order-card-label">تاريخ التغيب:</div><div class="order-card-value">${displayValue(date)}</div></div>
      <div class="order-card-row"><div class="order-card-label">عدد الأيام:</div><div class="order-card-value">${displayValue(days)}</div></div>
      <div class="order-card-row"><div class="order-card-label">يوم التغيب:</div><div class="order-card-value">${displayValue(dayName)}</div></div>
      <div class="order-card-row"><div class="order-card-label">نوع الاجازة:</div><div class="order-card-value">${displayValue(vacationType)}</div></div>
      <div class="order-card-actions">
        <button class="btn ghost" onclick="startEditAttendance('${a.id}')">تعديل</button>
        <button class="btn" onclick="deleteAttendance('${a.id}')">حذف</button>
      </div>
    `;
    if(attendanceUnlocked){
      cardsDiv.appendChild(card);
    }
  }); 

  // تحديث أزرار pagination - إخفاء إذا كانت مفلترة
  if(!isFilteredAttendance) {
    updatePaginationButtons('#attendancePagination', totalPages, currentPageAttendance, (pageNum) => {
      currentPageAttendance = pageNum;
      renderAttendanceTable();
    });
  }

  saveAll(); 
}

/* Attendance password modal and controls */
const ATTENDANCE_PASSWORD = 'CBE_ELEC@2026'; // <-- غيّر هذه الكلمة حسب الحاجة

function showAttendancePasswordModal(){
  const modal = document.getElementById('attendancePasswordModal');
  const input = document.getElementById('attendancePasswordInput');
  if(!modal) return;
  modal.classList.add('active');
  modal.setAttribute('aria-hidden','false');
  input.value = '';
  setTimeout(()=>input.focus(),50);
}

function closeAttendancePasswordModal(){
  const modal = document.getElementById('attendancePasswordModal');
  if(!modal) return;
  modal.classList.remove('active');
  modal.setAttribute('aria-hidden','true');
}

function unlockAttendanceCards(){
  sessionStorage.setItem('attendanceUnlocked','true');
  // Re-render to show cards
  renderAttendanceTable();
  closeAttendancePasswordModal();
}

function checkAttendancePassword(){
  const val = document.getElementById('attendancePasswordInput').value || '';
  if(val === ATTENDANCE_PASSWORD){ unlockAttendanceCards(); }
  else { alert('كلمة المرور خاطئة'); }
}

document.getElementById('attendancePasswordSubmit')?.addEventListener('click', checkAttendancePassword);
document.getElementById('attendancePasswordCancel')?.addEventListener('click', closeAttendancePasswordModal);
document.getElementById('attendancePasswordInput')?.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') checkAttendancePassword(); if(e.key==='Escape') closeAttendancePasswordModal(); });

// Add a small placeholder button to allow opening modal when locked
function ensureAttendanceLockedPlaceholder(){
  const cardsDiv = document.getElementById('attendanceCards');
  if(!cardsDiv) return;
  // remove existing placeholder if any
  const existing = document.getElementById('attendanceCardsLockedPlaceholder');
  if(existing) existing.remove();
  const unlocked = (sessionStorage.getItem('attendanceUnlocked') === 'true');
  if(!unlocked){
    const ph = document.createElement('div');
    ph.id = 'attendanceCardsLockedPlaceholder';
    ph.className = 'box';
    ph.style.textAlign = 'center';
    ph.style.padding = '12px';
    ph.style.marginTop = '8px';
    ph.innerHTML = `<div style="margin-bottom:8px;font-weight:600">عرض بطاقات الأجازات مقفل</div><button class="btn" id="openAttendancePasswordBtn">فتح بكلمة مرور</button>`;
    cardsDiv.parentNode.insertBefore(ph, cardsDiv.nextSibling);
    document.getElementById('openAttendancePasswordBtn')?.addEventListener('click', showAttendancePasswordModal);
    // hide the cards container itself so it won't appear via CSS rules
    cardsDiv.style.display = 'none';
    // also hide the table view and disable related controls to prevent desktop exposure
    const tableView = document.querySelector('#attendanceTable')?.closest('.table-view');
    if(tableView) tableView.style.display = 'none';
    const idsToHide = ['exportAttendanceCsv','exportAttendanceDoc','applyAttendanceFilterBtn','applyDateFilterAttendanceBtn','printAttendanceCurrentPage','printAttendanceBtn','attendancePagination','searchAttendance','attendanceSummary'];
    idsToHide.forEach(id=>{ const el = document.getElementById(id); if(el) el.style.display = 'none'; });
  } else {
    cardsDiv.style.display = '';
    const tableView = document.querySelector('#attendanceTable')?.closest('.table-view');
    if(tableView) tableView.style.display = '';
    const idsToShow = ['exportAttendanceCsv','exportAttendanceDoc','applyAttendanceFilterBtn','applyDateFilterAttendanceBtn','printAttendanceCurrentPage','printAttendanceBtn','attendancePagination','searchAttendance','attendanceSummary'];
    idsToShow.forEach(id=>{ const el = document.getElementById(id); if(el) el.style.display = ''; });
  }
}

// call placeholder updater after render
const _origRenderAttendanceTable = renderAttendanceTable;
renderAttendanceTable = function(){ _origRenderAttendanceTable(); ensureAttendanceLockedPlaceholder(); }

function populateAttendanceSearchNames(){
  try{
    const namesSet = new Set();
    // from workerName select
    const workerSel = document.getElementById('workerName');
    if(workerSel){ Array.from(workerSel.options).forEach(o=>{ const v=(o.value||'').trim(); if(v) namesSet.add(v); }); }
    // from attendance records
    (attendance||[]).forEach(a=>{ if(a && a.workerName) namesSet.add(a.workerName); });

    const names = Array.from(namesSet).sort((a,b)=> a.localeCompare(b,'ar'));

    // If searchAttendance is a select, populate it
    const searchEl = document.getElementById('searchAttendance');
    if(searchEl && searchEl.tagName === 'SELECT'){
      const first = document.createElement('option'); first.value = ''; first.textContent = 'اختر اسم العامل';
      searchEl.innerHTML = '';
      searchEl.appendChild(first);
      names.forEach(n=>{ const opt = document.createElement('option'); opt.value = n; opt.textContent = n; searchEl.appendChild(opt); });
      return;
    }

    // Otherwise, try to populate a datalist if present
    const dl = document.getElementById('attendanceNamesList');
    if(dl){ dl.innerHTML = ''; names.forEach(n=>{ const opt = document.createElement('option'); opt.value = n; dl.appendChild(opt); }); }
  }catch(e){ console.error('populateAttendanceSearchNames error', e); }
}

/* Attendance filters & exports */
document.getElementById('applyAttendanceFilterBtn').addEventListener('click', applyAttendanceFilters);
function applyAttendanceFilters(){ 
  const q=(document.getElementById('searchAttendance').value||'').toLowerCase();
  const searchBy = 'name';
  const dateFrom = document.getElementById('dateFromAttendance')?.value;
  const dateTo = document.getElementById('dateToAttendance')?.value;

  // Ensure card-view is visible on mobile
  // Update locked placeholder / visibility
  ensureAttendanceLockedPlaceholder();

  // Set filtered state based on inputs
  const active = Boolean(q || dateFrom || dateTo);
  isFilteredAttendance = active;
  currentPageAttendance = 1;
  document.getElementById('attendancePagination').style.display = isFilteredAttendance ? 'none' : '';

  // If user filtered by a name (text in search), compute total vacations and days for matching worker(s)
  try{
    const summaryEl = document.getElementById('attendanceSummary');
    if(summaryEl){
      const qTrim = (q||'').trim();
      if(qTrim){
        const matched = (attendance||[]).filter(a => {
          if(a.deleted) return false;
          const name = (a.workerName||'').toLowerCase();
          const num = (a.workerNum||'').toLowerCase();
          if(searchBy === 'name') return name.includes(qTrim);
          if(searchBy === 'num') return num.includes(qTrim);
          return name.includes(qTrim) || num.includes(qTrim);
        });
        const total = matched.length;
        const totalDays = matched.reduce((sum, a) => sum + (parseInt(a.daysCount) || parseInt(a.days) || 0), 0);
        const uniqNames = Array.from(new Set(matched.map(m=>m.workerName).filter(Boolean)));
        const displayName = uniqNames.length===1 ? uniqNames[0] : qTrim;
        summaryEl.innerText = `إجمالي الأجازات لـ ${displayName}: ${total} سجل • إجمالي الأيام: ${totalDays} يوم`;
        summaryEl.style.display = total? 'block' : 'none';
      } else {
        summaryEl.innerText = '';
        summaryEl.style.display = 'none';
      }
    }
  }catch(e){ console.error('attendance summary error', e); }

  // Re-render table (renderAttendanceTable will use the filter inputs when isFilteredAttendance=true)
  renderAttendanceTable();
}

// دالة منفصلة لفلتر التاريخ فقط
document.getElementById('applyDateFilterAttendanceBtn')?.addEventListener('click', applyAttendanceFilters);
// apply filter immediately when a name is selected from the select
document.getElementById('searchAttendance')?.addEventListener('input', applyAttendanceFilters);

document.getElementById('exportAttendanceCsv').addEventListener('click', ()=>{
  // احصل على البيانات المرئية بعد الفلتر من الكائنات مباشرة بدل الجدول
  const q = (document.getElementById('searchAttendance')?.value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromAttendance')?.value;
  const dateTo = document.getElementById('dateToAttendance')?.value;
  let filtered = attendance.filter(a => {
    if(a.deleted) return false;
    const name = (a.workerName || '').toLowerCase();
    const rowDate = (a.absenceDate || a.date || '').toString();
    let dateMatch = true;
    if(dateFrom && dateTo) dateMatch = (rowDate >= dateFrom && rowDate <= dateTo);
    else if(dateFrom) dateMatch = (rowDate >= dateFrom);
    else if(dateTo) dateMatch = (rowDate <= dateTo);
    return (!q || name.includes(q)) && dateMatch;
  });
  if(!filtered.length){ alert('لا توجد بيانات للتصدير'); return; }
  
  const headers=['#','workerName','workerNum','absenceDate','daysCount','absenceDay','vacationType'];
  const rows = [];
  filtered.forEach((a, i) => {
    rows.push({
      '#': i+1,
      workerName: a.workerName || '',
      workerNum: a.workerNum || '',
      absenceDate: a.absenceDate || a.date || '',
      daysCount: a.daysCount || a.days || '',
      absenceDay: a.absenceDay || a.dayType || '',
      vacationType: a.vacationType || ''
    });
  });
  const csv = arrayToCsv(headers, rows);
  downloadBlob(csv, `attendance_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
});

document.getElementById('exportAttendanceDoc').addEventListener('click', ()=>{
  if(!attendance.length){ alert('لا توجد بيانات للتصدير'); return; }
  const title='تقرير الغياب';
  const headers = ['#','اسم العامل','رقم العامل','تاريخ التغيب','عدد الأيام','يوم التغيب','نوع الاجازة'];
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}.summary{background:#f0f0f0;padding:10px;margin:15px 0;border-radius:4px;font-weight:bold}</style></head><body><h2 style="text-align:center">نظام إدارة الأعطال وأوامر الشراء — الكهرباء</h2><h3 style="text-align:center">${title}</h3><p>تاريخ: ${new Date().toLocaleDateString()}</p><table><thead><tr>${headers.map(h=>'<th>'+h+'</th>').join('')}</tr></thead><tbody>`;

  if(!isFilteredAttendance){
    const allAttendance = attendance.filter(a => !a.deleted);
    if(!allAttendance.length){ alert('لا توجد بيانات للتصدير'); return; }
    allAttendance.forEach((a,i)=> {
      html += `<tr><td>${i+1}</td><td>${escapeHtml(a.workerName || '')}</td><td>${escapeHtml(a.workerNum || '')}</td><td>${escapeHtml(a.absenceDate || a.date || '')}</td><td>${escapeHtml(a.daysCount || a.days || '')}</td><td>${escapeHtml(a.absenceDay || a.dayType || '')}</td><td>${escapeHtml(a.vacationType || '')}</td></tr>`;
    });
    html += '</tbody></table></body></html>';
    downloadBlob(html, `attendance_all_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
    return;
  }

  const visibleRows = Array.from(document.querySelectorAll('#attendanceTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('لا توجد بيانات للتصدير'); return; }
  visibleRows.forEach((tr, i)=>{
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1]?.textContent||'')}</td><td>${escapeHtml(cells[2]?.textContent||'')}</td><td>${escapeHtml(cells[3]?.textContent||'')}</td><td>${escapeHtml(cells[4]?.textContent||'')}</td><td>${escapeHtml(cells[5]?.textContent||'')}</td><td>${escapeHtml(cells[6]?.textContent||'')}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  downloadBlob(html, `attendance_filtered_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
});

/* Print Current Page - Attendance */
document.getElementById('printAttendanceCurrentPage')?.addEventListener('click', ()=>{
  // احصل على البيانات المرئية بعد الفلتر من الكائنات مباشرة بدل الجدول
  const q = (document.getElementById('searchAttendance')?.value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromAttendance')?.value;
  const dateTo = document.getElementById('dateToAttendance')?.value;
  let filtered = attendance.filter(a => {
    if(a.deleted) return false;
    const name = (a.workerName || '').toLowerCase();
    const rowDate = (a.absenceDate || a.date || '').toString();
    let dateMatch = true;
    if(dateFrom && dateTo) dateMatch = (rowDate >= dateFrom && rowDate <= dateTo);
    else if(dateFrom) dateMatch = (rowDate >= dateFrom);
    else if(dateTo) dateMatch = (rowDate <= dateTo);
    return (!q || name.includes(q)) && dateMatch;
  });
  if(!filtered.length){ alert('لا توجد بيانات للطباعة'); return; }
  
  const title='تقرير الغياب'; 
  const totalDays = filtered.reduce((sum, a) => sum + (parseInt(a.daysCount) || parseInt(a.days) || 0), 0);
  const uniqNames = Array.from(new Set(filtered.map(m=>m.workerName).filter(Boolean)));
  const workerName = uniqNames.length===1 ? uniqNames[0] : 'جميع الموظفين';
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}.summary{background:#f0f0f0;padding:10px;margin:15px 0;border-radius:4px;font-weight:bold}</style></head><body>`;
  html += `<div style="text-align:center"><h2>نظام إدارة الأعطال وأوامر الشراء — الكهرباء</h2><h3>${title}</h3><p>تاريخ: ${new Date().toLocaleDateString()}</p></div>`;
  html += `<div class="summary">الموظف: ${escapeHtml(workerName)} | إجمالي أيام التغيب: ${totalDays} يوم</div>`;
  html += `<table><thead><tr><th>#</th><th>اسم العامل</th><th>رقم العامل</th><th>تاريخ التغيب</th><th>عدد الأيام</th><th>يوم التغيب</th><th>نوع الاجازة</th></tr></thead><tbody>`;
  filtered.forEach((a, i)=> {
    html += `<tr><td>${i+1}</td><td>${escapeHtml(a.workerName || '')}</td><td>${escapeHtml(a.workerNum || '')}</td><td>${escapeHtml(a.absenceDate || a.date || '')}</td><td>${escapeHtml(a.daysCount || a.days || '')}</td><td>${escapeHtml(a.absenceDay || a.dayType || '')}</td><td>${escapeHtml(a.vacationType || '')}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  const w=window.open('','_blank'); 
  w.document.write(html); 
  w.document.close(); 
  setTimeout(()=>w.print(),300);
});

/* Print ALL - Attendance (all data regardless of pagination) */
document.getElementById('printAttendanceBtn').removeEventListener('click', null);
document.getElementById('printAttendanceBtn').addEventListener('click', ()=>{
  if(!attendance || !attendance.length){ alert('لا توجد بيانات للطباعة'); return; }
  
  // احصل على كل سجلات الأجازات الغير محذوفة
  const allAttendance = attendance.filter(a => !a.deleted);
  if(!allAttendance.length){ alert('لا توجد بيانات للطباعة'); return; }
  
  const title='تقرير الأجازات'; 
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>نظام إدارة الأعطال والصيانة وأوامر الشراء والأجازات — الكهرباء</h2><h3>${title}</h3><p>تاريخ: ${new Date().toLocaleDateString()}</p></div>`;
  html += `<table><thead><tr><th>#</th><th>اسم العامل</th><th>رقم العامل</th><th>تاريخ الأجازة</th><th>عدد الأيام</th><th>يوم الأجازة</th><th>نوع الاجازة</th></tr></thead><tbody>`;
  allAttendance.forEach((a, i)=> {
    const name = escapeHtml(a.workerName || a.personName || '');
    const num = escapeHtml(a.workerNum || a.personId || '');
    const date = escapeHtml(a.absenceDate || a.date || '');
    const days = escapeHtml(a.daysCount || a.days || '');
    const dayName = escapeHtml(a.absenceDay || a.dayType || '');
    const vacationType = escapeHtml(a.vacationType || '');
    html += `<tr><td>${i+1}</td><td>${name}</td><td>${num}</td><td>${date}</td><td>${days}</td><td>${dayName}</td><td>${vacationType}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  const w=window.open('','_blank'); 
  w.document.write(html); 
  w.document.close(); 
  setTimeout(()=>w.print(),300);
});

/* filters */
// ═════════════════════════════════════════════════════════════════
// 13. فلترة البحث والتصفية للأعطال والأوامر
// ═════════════════════════════════════════════════════════════════
document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
document.getElementById('clearFiltersBtn').addEventListener('click', ()=>{ 
  document.getElementById('search').value=''; 
  document.getElementById('filterStatus').value=''; 
  document.getElementById('dateFromFault').value=''; 
  document.getElementById('dateToFault').value=''; 
  applyFilters(); 
});

function applyFilters(){
  const q = (document.getElementById('search').value||'').toLowerCase();
  const st = (document.getElementById('filterStatus').value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromFault').value;
  const dateTo = document.getElementById('dateToFault').value;

  // Ensure card-view is visible on mobile
  const cardsContainer = document.getElementById('faultCards');
  if(cardsContainer) cardsContainer.style.display = '';

  // تم إلغاء ظهور ملخص البحث في الصفحة

  // Set filtered flag and re-render via data arrays (render will handle correct date logic)
  const active = Boolean(q || st || dateFrom || dateTo);
  isFilteredFaults = active;
  currentPageFaults = 1;
  document.getElementById('faultsPagination').style.display = isFilteredFaults ? 'none' : '';
  renderFaultTable();
}

// دالة منفصلة لفلتر التاريخ فقط
document.getElementById('applyDateFilterFaultBtn')?.addEventListener('click', applyFilters);

/* order filter */
document.getElementById('applyOrderFilterBtn').addEventListener('click', applyOrderFilters);
function applyOrderFilters(){ 
  const q=(document.getElementById('searchOrder').value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromOrder').value;
  const dateTo = document.getElementById('dateToOrder').value;
  
  // Ensure card-view is visible on mobile
  const cardsContainer = document.getElementById('orderCards');
  if(cardsContainer) cardsContainer.style.display = '';
  
  // Set filtered flag and re-render via data arrays (render will handle correct date logic)
  const active = Boolean(q || dateFrom || dateTo);
  isFilteredOrders = active;
  currentPageOrders = 1;
  document.getElementById('ordersPagination').style.display = isFilteredOrders ? 'none' : '';
  renderOrderTable();
}

// دالة منفصلة لفلتر التاريخ فقط
document.getElementById('applyDateFilterOrderBtn')?.addEventListener('click', applyOrderFilters);

/* exports: CSV and Word (table) and print */
// ═════════════════════════════════════════════════════════════════
// 14. دوال التصدير والطباعة (CSV, Word, PDF)
// ═════════════════════════════════════════════════════════════════
function arrayToCsv(headers, rows){
  const esc = v => `"${String(v||'').replace(/"/g,'""')}"`;
  const lines = [headers.map(esc).join(',')].concat(rows.map(r=>headers.map(h=>esc(r[h])).join(',')));
  return lines.join('\r\n');
}
function downloadBlob(content, filename, type){
  const blob = new Blob([content], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
}

/* Faults exports (filtered only) */
document.getElementById('exportCsvAll').addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#faultTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('لا توجد بيانات للتصدير'); return; }
  
  const headers = ['#','machine','line','person','description','solution','shift','date','lcode','partName','partQty','status'];
  const rows = [];
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    rows.push({
      '#': i+1,
      machine: cells[1].textContent,
      line: cells[2].textContent,
      person: cells[3].textContent,
      description: cells[4].textContent,
      solution: cells[5].textContent,
      shift: cells[6].textContent,
      date: cells[7].textContent,
      lcode: cells[8].textContent,
      partName: cells[9].textContent,
      partQty: cells[10].textContent,
      status: cells[11].textContent
    });
  });
  const csv = arrayToCsv(headers, rows);
  downloadBlob(csv, `faults_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
});

/* Word export as table (filtered faults only) */
document.getElementById('exportDocAll').addEventListener('click', ()=> {
  // إذا ما فيش فلتر مفعل نصدر كل السجلات (غير المحذوفة)، وإلا نصدر الصفوف المرئية فقط
  const title = 'تقرير الأعطال';
  const headers = ['#','الماكينة','الخط','القائم','الوصف','حل العطل','الوردية','التاريخ','L Number','اسم القطعة','الكمية','الحالة'];
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body><h2 style="text-align:center">نظام إدارة الأعطال وأوامر الشراء — الكهرباء</h2><h3 style="text-align:center">${title}</h3><p>تاريخ: ${new Date().toLocaleDateString()}</p><table><thead><tr>${headers.map(h=>'<th>'+h+'</th>').join('')}</tr></thead><tbody>`;

  if(!isFilteredFaults){
    // صدّر كل السجلات المحلية غير المحذوفة
    const allFaults = faults.filter(f => !f.deleted);
    if(!allFaults.length){ alert('لا توجد بيانات للتصدير'); return; }
    allFaults.forEach((f,i)=>{
      html += `<tr><td>${i+1}</td><td>${escapeHtml(f.machine||'')}</td><td>${escapeHtml(f.line||'')}</td><td>${escapeHtml(f.person||'')}</td><td>${escapeHtml(f.description||'')}</td><td>${escapeHtml(f.solution||'')}</td><td>${escapeHtml(f.shift||'')}</td><td>${escapeHtml(f.date||'')}</td><td>${escapeHtml(f.lcode||'')}</td><td>${escapeHtml(f.partName||'')}</td><td>${escapeHtml(f.partQty||'')}</td><td>${escapeHtml(f.status||'')}</td></tr>`;
    });
    html += '</tbody></table></body></html>';
    downloadBlob(html, `faults_all_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
    return;
  }

  // بخلاف ذلك، صدّر الصفوف المرئية في الجدول (بعد الفلترة)
  const visibleRows = Array.from(document.querySelectorAll('#faultTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('لا توجد بيانات للتصدير'); return; }
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    html += `<tr>` +
            `<td>${i+1}</td>` +
            `<td>${escapeHtml(cells[1]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[2]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[3]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[4]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[5]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[6]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[7]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[8]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[9]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[10]?.textContent||'')}</td>` +
            `<td>${escapeHtml(cells[11]?.textContent||'')}</td>` +
            `</tr>`;
  });
  html += '</tbody></table></body></html>';
  downloadBlob(html, `faults_filtered_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
});

/* Orders exports (filtered only) */
document.getElementById('exportOrdersCsv').addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#orderTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('لا توجد بيانات للتصدير'); return; }
  
  const headers=['#','orderNum','supplyNum','date','person','details'];
  const rows = [];
  visibleRows.forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    rows.push({
      '#': i+1,
      orderNum: cells[0].textContent,
      supplyNum: cells[1].textContent,
      date: cells[2].textContent,
      person: cells[3].textContent,
      details: cells[4].textContent
    });
  });
  const csv = arrayToCsv(headers, rows);
  downloadBlob(csv, `orders_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
});
document.getElementById('exportOrdersDoc').addEventListener('click', ()=> {
  if(!orders.length){ alert('لا توجد بيانات للتصدير'); return; }
  const title='تقرير أوامر الشراء';
  const headers = ['#','أمر الشراء','توريد','التاريخ','القائم','تفاصيل'];
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body><h2 style="text-align:center">نظام إدارة الأعطال وأوامر الشراء — الكهرباء</h2><h3 style="text-align:center">${title}</h3><p>تاريخ: ${new Date().toLocaleDateString()}</p><table><thead><tr>${headers.map(h=>'<th>'+h+'</th>').join('')}</tr></thead><tbody>`;

  if(!isFilteredOrders){
    const allOrders = orders.filter(o => !o.deleted);
    if(!allOrders.length){ alert('لا توجد بيانات للتصدير'); return; }
    allOrders.forEach((o,i)=>{
      html += `<tr><td>${i+1}</td><td>${escapeHtml(o.orderNum||'')}</td><td>${escapeHtml(o.supplyNum||'')}</td><td>${escapeHtml(o.date||'')}</td><td>${escapeHtml(o.person||'')}</td><td>${escapeHtml(o.details||'')}</td></tr>`;
    });
    html += '</tbody></table></body></html>';
    downloadBlob(html, `orders_all_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
    return;
  }

  const visibleRows = Array.from(document.querySelectorAll('#orderTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('لا توجد بيانات للتصدير'); return; }
  visibleRows.forEach((tr, i)=>{
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[0]?.textContent||'')}</td><td>${escapeHtml(cells[1]?.textContent||'')}</td><td>${escapeHtml(cells[2]?.textContent||'')}</td><td>${escapeHtml(cells[3]?.textContent||'')}</td><td>${escapeHtml(cells[4]?.textContent||'')}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  downloadBlob(html, `orders_filtered_${new Date().toISOString().slice(0,10)}.doc`, 'application/msword');
});
/* Print Current Page - Faults */
document.getElementById('printPdfCurrentPage')?.addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#faultTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('لا توجد بيانات للطباعة'); return; }

  // ملخص البحث عند الطباعة فقط
  const q = (document.getElementById('search').value||'').toLowerCase();
  let searchSummaryHtml = '';
  if(q.trim()){
    const matched = visibleRows;
    const totalFaults = matched.length;
    const uniqueMachines = Array.from(new Set(matched.map(tr=>tr.querySelectorAll('td')[1]?.textContent?.trim()).filter(Boolean)));
    if(totalFaults){
      searchSummaryHtml = `<div style="background:#e8f7e8;color:#0A4C88;font-weight:700;padding:10px 18px;border-radius:8px;margin-bottom:12px;text-align:center;box-shadow:0 1px 6px #0001;font-size:16px">نتائج البحث: <span style="color:#00796b">${q}</span> — عدد الأعطال: <span style="color:#00796b">${totalFaults}</span> | عدد الماكينات المطابقة: <span style="color:#00796b">${uniqueMachines.length}</span></div>`;
    }
  }

  const title = 'تقرير الأعطال';
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>نظام إدارة الأعطال وأوامر الشراء — الكهرباء</h2><h3>${title}</h3><p>تاريخ: ${new Date().toLocaleDateString()}</p></div>`;
  html += searchSummaryHtml;
  html += `<table><thead><tr><th>#</th><th>الماكينة</th><th>الخط</th><th>القائم</th><th>الوصف</th><th>حل العطل</th><th>الوردية</th><th>التاريخ</th><th>L Number</th><th>القطعة</th><th>الكمية</th><th>الحالة</th></tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td><td>${escapeHtml(cells[5].textContent)}</td><td>${escapeHtml(cells[6].textContent)}</td><td>${escapeHtml(cells[7].textContent)}</td><td>${escapeHtml(cells[8].textContent)}</td><td>${escapeHtml(cells[9].textContent)}</td><td>${escapeHtml(cells[10].textContent)}</td><td>${escapeHtml(cells[11].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  const w = window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=> w.print(),400);
});

/* Print ALL - Faults (all data regardless of pagination) */
document.getElementById('printPdfAll').removeEventListener('click', null);
document.getElementById('printPdfAll').addEventListener('click', ()=> {
  if(!faults || !faults.length){ alert('لا توجد بيانات للطباعة'); return; }

  // حصل على كل الأعطال الغير محذوفة
  const allFaults = faults.filter(f => !f.deleted);
  if(!allFaults.length){ alert('لا توجد بيانات للطباعة'); return; }

  // ملخص إجمالي
  const totalFaults = allFaults.length;
  const uniqueMachines = Array.from(new Set(allFaults.map(f=>f.machine).filter(Boolean)));
  let summaryHtml = '';
  if(totalFaults){
    summaryHtml = `<div style="background:#e8f7e8;color:#0A4C88;font-weight:700;padding:10px 18px;border-radius:8px;margin-bottom:12px;text-align:center;box-shadow:0 1px 6px #0001;font-size:16px">إجمالي الأعطال: <span style="color:#00796b">${totalFaults}</span> | عدد الماكينات: <span style="color:#00796b">${uniqueMachines.length}</span></div>`;
  }

  const title = 'تقرير الأعطال';
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>نظام إدارة الأعطال وأوامر الشراء — الكهرباء</h2><h3>${title}</h3><p>تاريخ: ${new Date().toLocaleDateString()}</p></div>`;
  html += summaryHtml;
  html += `<table><thead><tr><th>#</th><th>الماكينة</th><th>الخط</th><th>القائم</th><th>الوصف</th><th>حل العطل</th><th>الوردية</th><th>التاريخ</th><th>L Number</th><th>القطعة</th><th>الكمية</th><th>الحالة</th></tr></thead><tbody>`;
  allFaults.forEach((f, i)=> {
    html += `<tr><td>${i+1}</td><td>${escapeHtml(f.machine)}</td><td>${escapeHtml(f.line)}</td><td>${escapeHtml(f.person)}</td><td>${escapeHtml(f.description)}</td><td>${escapeHtml(f.solution||'')}</td><td>${escapeHtml(f.shift)}</td><td>${escapeHtml(f.date)}</td><td>${escapeHtml(f.lcode)}</td><td>${escapeHtml(f.partName)}</td><td>${escapeHtml(f.partQty)}</td><td>${escapeHtml(f.status)}</td></tr>`;
  });
  html += '</tbody></table></body></html>';
  const w = window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=> w.print(),400);
});

/* Print Current Page - Orders */
document.getElementById('printOrdersCurrentPage')?.addEventListener('click', ()=> {
  const visibleRows = Array.from(document.querySelectorAll('#orderTable tbody tr')).filter(tr => tr.style.display !== 'none');
  if(!visibleRows.length){ alert('لا توجد بيانات للطباعة'); return; }
  
  const title='تقرير أوامر الشراء'; 
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>نظام إدارة الأعطال وأوامر الشراء — الكهرباء</h2><h3>${title}</h3><p>تاريخ: ${new Date().toLocaleDateString()}</p></div>`;
  html += `<table><thead><tr><th>#</th><th>أمر الشراء</th><th>توريد</th><th>التاريخ</th><th>القائم</th><th>تفاصيل</th></tr></thead><tbody>`;
  visibleRows.forEach((tr, i)=> {
    const cells = tr.querySelectorAll('td');
    html += `<tr><td>${i+1}</td><td>${escapeHtml(cells[0].textContent)}</td><td>${escapeHtml(cells[1].textContent)}</td><td>${escapeHtml(cells[2].textContent)}</td><td>${escapeHtml(cells[3].textContent)}</td><td>${escapeHtml(cells[4].textContent)}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  const w=window.open('','_blank'); 
  w.document.write(html); 
  w.document.close(); 
  setTimeout(()=>w.print(),300);
});

/* Print ALL - Orders (all data regardless of pagination) */
document.getElementById('printOrdersBtn').removeEventListener('click', null);
document.getElementById('printOrdersBtn').addEventListener('click', ()=> {
  if(!orders || !orders.length){ alert('لا توجد بيانات للطباعة'); return; }
  
  // احصل على كل الأوامر الغير محذوفة
  const allOrders = orders.filter(o => !o.deleted);
  if(!allOrders.length){ alert('لا توجد بيانات للطباعة'); return; }
  
  const title='تقرير أوامر الشراء'; 
  let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;direction:rtl;padding:16px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #666;padding:6px;text-align:right}</style></head><body>`;
  html += `<div style="text-align:center"><h2>نظام إدارة الأعطال وأوامر الشراء — الكهرباء</h2><h3>${title}</h3><p>تاريخ: ${new Date().toLocaleDateString()}</p></div>`;
  html += `<table><thead><tr><th>#</th><th>أمر الشراء</th><th>توريد</th><th>التاريخ</th><th>القائم</th><th>تفاصيل</th></tr></thead><tbody>`;
  allOrders.forEach((o, i)=> {
    html += `<tr><td>${i+1}</td><td>${escapeHtml(o.orderNum)}</td><td>${escapeHtml(o.supplyNum)}</td><td>${escapeHtml(o.date)}</td><td>${escapeHtml(o.person)}</td><td>${escapeHtml(o.details||'')}</td></tr>`;
  });
  html += '</tbody></table></body></html>'; 
  const w=window.open('','_blank'); 
  w.document.write(html); 
  w.document.close(); 
  setTimeout(()=>w.print(),300);
});

/* dashboard */

// زر طباعة ملخص الأعطال
// ═════════════════════════════════════════════════════════════════
// 15. لوحة التحكم والإحصائيات
// ═════════════════════════════════════════════════════════════════
document.getElementById('printFaultsSummaryBtn')?.addEventListener('click', function() {
    // إذا كان هناك بحث باسم ماكينة، أضف ملخص البحث أعلى صفحة الطباعة
    const q = (document.getElementById('search').value||'').toLowerCase();
    let searchSummaryHtml = '';
    if(q.trim()){
      const matched = faults.filter(f => !f.deleted && f.machine.toLowerCase().includes(q));
      const totalFaults = matched.length;
      const uniqueMachines = Array.from(new Set(matched.map(f=>f.machine)));
      if(totalFaults){
        searchSummaryHtml = `<div style=\"background:#e8f7e8;color:#0A4C88;font-weight:700;padding:10px 18px;border-radius:8px;margin-bottom:12px;text-align:center;box-shadow:0 1px 6px #0001;font-size:16px\">نتائج البحث: <span style=\"color:#00796b\">${q}</span> — عدد الأعطال: <span style=\"color:#00796b\">${totalFaults}</span> | عدد الماكينات المطابقة: <span style=\"color:#00796b\">${uniqueMachines.length}</span></div>`;
      }
    }
  // إجمالي الأعطال لكل ماكينة
  const faultsSummary = {};
  faults.filter(f => !f.deleted).forEach(f => {
    const key = `${f.machine} (${f.line})`;
    if (!faultsSummary[key]) faultsSummary[key] = 0;
    faultsSummary[key]++;
  });
  let totalFaults = Object.values(faultsSummary).reduce((a,b)=>a+b,0);
  // تجميع الأعطال حسب المجموعات
  const faultsByGroup = {};
  faults.filter(f => !f.deleted).forEach(f => {
    const group = f.line || 'غير محدد';
    if (!faultsByGroup[group]) faultsByGroup[group] = [];
    faultsByGroup[group].push({ machine: f.machine, count: 1 });
  });
  // دمج الأعطال لنفس الماكينة داخل المجموعة
  Object.keys(faultsByGroup).forEach(group => {
    const machines = {};
    faultsByGroup[group].forEach(item => {
      if (!machines[item.machine]) machines[item.machine] = 0;
      machines[item.machine] += item.count;
    });
    faultsByGroup[group] = machines;
  });
  let html = `<html dir=\"rtl\"><head><meta charset=\"utf-8\"><title>ملخص الأعطال</title><style>
    body{font-family:'Segoe UI',Arial;direction:rtl;background:#f7fafd;padding:32px}
    /* تم حذف صورة الأعطال */
    .summary-title{color:#0A4C88;text-align:center;font-size:28px;font-weight:700;margin-bottom:8px;letter-spacing:1px}
    .summary-desc{text-align:center;color:#444;font-size:16px;margin-bottom:10px}
    .summary-date{color:#666;text-align:center;font-size:15px;margin-bottom:18px}
    .summary-total{background:#e8f7e8;color:#00796b;font-size:18px;font-weight:700;text-align:center;padding:10px 0;margin-bottom:18px;border-radius:8px;box-shadow:0 1px 6px #0001}
    .group-section{margin-bottom:32px}
    .group-title{background:#0A4C88;color:#fff;font-size:22px;font-weight:700;padding:10px 0 10px 0;border-radius:10px;text-align:center;margin-bottom:18px;box-shadow:0 1px 6px #0001}
    .cards-wrap{display:flex;flex-wrap:wrap;gap:18px;justify-content:center}
    .summary-card{background:#fff;border-radius:14px;box-shadow:0 2px 12px #0001;padding:22px 28px;min-width:220px;max-width:320px;margin-bottom:10px;display:flex;flex-direction:column;align-items:center;transition:box-shadow .2s}
    .summary-card:hover{box-shadow:0 4px 18px #0077b633}
    .card-title{font-size:19px;font-weight:700;color:#0A4C88;margin-bottom:6px;text-align:center}
    .card-count{font-size:24px;font-weight:700;color:#00796b;background:#e8f7e8;padding:8px 22px;border-radius:8px;margin-bottom:4px;box-shadow:0 1px 6px #0001}
    .footer{margin-top:30px;text-align:center;color:#888;font-size:14px;letter-spacing:1px}
  </style></head><body>`;
  html += `<div class=\"header-logo\"></div>`;
  // html += `<div class=\"header-logo\"></div>`;
  html += `<div class=\"summary-title\">ملخص الأعطال حسب قوائم الماكينات</div>`;
  html += `<div class=\"summary-desc\">تقرير يوضح توزيع الأعطال لكل مجموعة وماكيناتها</div>`;
  html += `<div class=\"summary-date\">تاريخ الإنشاء: ${new Date().toLocaleDateString()}</div>`;
  html += `<div class=\"summary-total\">إجمالي الأعطال: ${totalFaults.toLocaleString('ar-EG')}</div>`;
  html += searchSummaryHtml;
  const groupOrder = Object.keys(MACHINE_GROUPS).concat(Object.keys(faultsByGroup).filter(g=>!Object.keys(MACHINE_GROUPS).includes(g)));
  const orderedGroups = Object.keys(MACHINE_GROUPS);
  orderedGroups.forEach(group => {
    if(!faultsByGroup[group]) return;
    html += `<div class=\"group-section\"><div class=\"group-title\">${group}</div><div class=\"cards-wrap\">`;
    let machinesOrder = MACHINE_GROUPS[group] || [];
    // عرض حسب ترتيب الماكينات في القائمة
    machinesOrder.forEach(machineName => {
      if(faultsByGroup[group][machineName]){
        html += `<div class=\"summary-card\"><div class=\"card-title\">${machineName}</div><div class=\"card-count\">${faultsByGroup[group][machineName].toLocaleString('ar-EG')}</div></div>`;
      }
    });
    // عرض أي ماكينة غير موجودة في القائمة بعدهم
    Object.entries(faultsByGroup[group]).forEach(([machine, count]) => {
      if(!machinesOrder.includes(machine)){
        html += `<div class=\"summary-card\"><div class=\"card-title\">${machine}</div><div class=\"card-count\">${count.toLocaleString('ar-EG')}</div></div>`;
      }
    });
    html += `</div></div>`;
  });
  html += `<div class=\"footer\">نظام إدارة الأعطال والصيانة — الكهرباء | تم الإنشاء بواسطة فريق الإدارة الفنية</div>`;
  html += '</body></html>';
  const w = window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=>w.print(),400);
});

// زر طباعة ملخص الصيانات
document.getElementById('printMaintenanceSummaryBtn')?.addEventListener('click', function() {
  // ملخص الصيانة: أسبوعية، شهرية، سنوية
  const types = ['أسبوعية','شهرية','سنوية'];
  const summary = {};
  types.forEach(type => { summary[type] = 0; });
  maintenance.filter(m => !m.deleted).forEach(m => {
    if (types.includes(m.type)) summary[m.type]++;
  });
  let totalMaint = maintenance.filter(m => !m.deleted).length;
  // تجميع الصيانة حسب المجموعات
  const maintByGroup = {};
  maintenance.filter(m => !m.deleted).forEach(m => {
    const group = m.line || 'غير محدد';
    if (!maintByGroup[group]) maintByGroup[group] = [];
    maintByGroup[group].push({ machine: m.machine, type: m.type });
  });
  // دمج أنواع الصيانة لنفس الماكينة داخل المجموعة
  Object.keys(maintByGroup).forEach(group => {
    const machines = {};
    maintByGroup[group].forEach(item => {
      if (!machines[item.machine]) machines[item.machine] = {};
      if (!machines[item.machine][item.type]) machines[item.machine][item.type] = 0;
      machines[item.machine][item.type]++;
    });
    maintByGroup[group] = machines;
  });
  let html = `<html dir=\"rtl\"><head><meta charset=\"utf-8\"><title>ملخص الصيانة</title><style>
    body{font-family:'Segoe UI',Arial;direction:rtl;background:#f7fafd;padding:32px}
    .header-logo{display:block;margin:0 auto 10px auto;width:80px;height:80px;border-radius:50%;background:#0A4C88 url('https://i.imgur.com/1Q9Z1Zy.png') no-repeat center/60px;box-shadow:0 2px 12px #0002}
    .summary-title{color:#0A4C88;text-align:center;font-size:28px;font-weight:700;margin-bottom:8px;letter-spacing:1px}
    .summary-desc{text-align:center;color:#444;font-size:16px;margin-bottom:10px}
    .summary-date{color:#666;text-align:center;font-size:15px;margin-bottom:18px}
    .summary-total{background:#e8f7e8;color:#00796b;font-size:18px;font-weight:700;text-align:center;padding:10px 0;margin-bottom:18px;border-radius:8px;box-shadow:0 1px 6px #0001}
    .group-section{margin-bottom:32px}
    .group-title{background:#0A4C88;color:#fff;font-size:22px;font-weight:700;padding:10px 0 10px 0;border-radius:10px;text-align:center;margin-bottom:18px;box-shadow:0 1px 6px #0001}
    .cards-wrap{display:flex;flex-wrap:wrap;gap:18px;justify-content:center}
    .summary-card{background:#fff;border-radius:14px;box-shadow:0 2px 12px #0001;padding:22px 28px;min-width:220px;max-width:320px;margin-bottom:10px;display:flex;flex-direction:column;align-items:center;transition:box-shadow .2s}
    .summary-card:hover{box-shadow:0 4px 18px #0077b633}
    .card-title{font-size:19px;font-weight:700;color:#0A4C88;margin-bottom:6px;text-align:center}
    .card-type{font-size:15px;color:#0077b6;margin-bottom:8px}
    .card-count{font-size:24px;font-weight:700;color:#00796b;background:#e8f7e8;padding:8px 22px;border-radius:8px;margin-bottom:4px;box-shadow:0 1px 6px #0001}
    .footer{margin-top:30px;text-align:center;color:#888;font-size:14px;letter-spacing:1px}
  </style></head><body>`;
  html += `<div class=\"summary-title\">ملخص الصيانة حسب قوائم الماكينات</div>`;
  html += `<div class=\"summary-desc\">تقرير يوضح توزيع الصيانة لكل مجموعة وماكيناتها وأنواع الصيانة</div>`;
  html += `<div class=\"summary-date\">تاريخ الإنشاء: ${new Date().toLocaleDateString()}</div>`;
  html += `<div class=\"summary-total\">إجمالي عمليات الصيانة: ${totalMaint.toLocaleString('ar-EG')}</div>`;
  Object.entries(maintByGroup).forEach(([group, machines]) => {
    html += `<div class=\"group-section\"><div class=\"group-title\">${group}</div><div class=\"cards-wrap\">`;
    Object.entries(machines).forEach(([machine, typesObj]) => {
      Object.entries(typesObj).forEach(([type, count]) => {
        html += `<div class=\"summary-card\"><div class=\"card-title\">${machine}</div><div class=\"card-type\">${type}</div><div class=\"card-count\">${count.toLocaleString('ar-EG')}</div></div>`;
      });
    });
    html += `</div></div>`;
  });
  html += `<div class=\"footer\">نظام إدارة الأعطال والصيانة — الكهرباء | تم الإنشاء بواسطة فريق الإدارة الفنية</div>`;
  html += '</body></html>';
  const w = window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=>w.print(),400);
});
function applyDashboardTile(title){
  // faults statuses
  const faultStatuses = ['تم الإصلاح','جاري الإصلاح','تحت التجربة','بانتظار رد الشركة','بانتظار قطعة الغيار'];
  // maintenance types mapping
  const maintMap = {
    'صيانة أسبوعية':'أسبوعية',
    'صيانة شهرية':'شهرية',
    'الصيانات ربع سنوية':'ربع سنوي',
    'صيانة سنوية':'سنوية',
    'صيانة طارئة':'طارئة'
  };

  // Faults tiles
  if(title.includes('أعطال') || faultStatuses.some(s=> title.includes(s) )){
    // clear search/date filters
    const statusTitle = faultStatuses.find(s=> title.includes(s));
    if(statusTitle){ document.getElementById('filterStatus').value = statusTitle; }
    else { document.getElementById('filterStatus').value = ''; }
    document.getElementById('search').value = '';
    document.getElementById('dateFromFault').value = '';
    document.getElementById('dateToFault').value = '';
    show('faults');
    applyFilters();
    return;
  }

  // Maintenance tiles
  if(title.includes('صيانة') || title.includes('الصيانات')){
    const mapped = maintMap[title] || '';
    document.getElementById('filterMaintenanceType').value = mapped;
    document.getElementById('searchMaintenance').value = '';
    document.getElementById('dateFromMaintenance').value = '';
    document.getElementById('dateToMaintenance').value = '';
    show('maintenance');
    applyMaintenanceFilters();
    return;
  }
}

function drawDashboard(){
  const total = faults.length;
  const done = faults.filter(f=>f.status==='تم الإصلاح').length;
  const working = faults.filter(f=>f.status==='جاري الإصلاح').length;
  const testing = faults.filter(f=>f.status==='تحت التجربة').length;
  const waitC = faults.filter(f=>f.status==='بانتظار رد الشركة').length;
  const waitP = faults.filter(f=>f.status==='بانتظار قطعة الغيار').length;

  const maintenanceTotal = maintenance.length;
  const mainWeekly = maintenance.filter(m=>m.type==='أسبوعية').length;
  const mainMonthly = maintenance.filter(m=>m.type==='شهرية').length;
  const mainQuarterAll = maintenance.filter(m=>m.type==='ربع سنوي').length;
  const mainYearly = maintenance.filter(m=>m.type==='سنوية').length;
  const mainEmergency = maintenance.filter(m=>m.type==='طارئة').length;

  // حساب عدد الصيانات الربعية في الربع الحالي
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentQuarter = Math.floor(now.getMonth()/3) + 1;
  function quarterOf(dateStr){
    const d = new Date(dateStr);
    if(isNaN(d)) return { year: null, quarter: null };
    return { year: d.getFullYear(), quarter: Math.floor(d.getMonth()/3) + 1 };
  }
  const mainQuarterCurrent = maintenance.filter(m => {
    if(m.type !== 'ربع سنوي') return false;
    const q = quarterOf(m.date);
    return q.year === currentYear && q.quarter === currentQuarter;
  }).length;

  const tiles = document.getElementById('tiles'); tiles.innerHTML='';
  function tileColor(title){
    // أخضر للنتائج الجيدة / إجمالي، أصفر للحالات الجارية/تحت الاختبار/بانتظار، أزرق للصيانات
    const greenRegex = /تم\s?الإصلاح|إجمالي\s?الأعطال/;
    const yellowRegex = /جاري\s?الإصلاح|تحت\s?التجربة|تحت\s?الاختبار|بانتظار/;
    const blueRegex = /صيانة|الصيانات|صيانة\s?أسبوعية|صيانة\s?شهرية|ربع\s?سنوي|صيانة\s?سنوية|صيانة\s?طارئة/;
    if(greenRegex.test(title)) return { bg: '#e8f7e8', fg: '#08365F' };
    if(yellowRegex.test(title)) return { bg: '#fff8dc', fg: '#08365F' };
    if(blueRegex.test(title)) return { bg: '#e6f0ff', fg: '#08365F' };
    return { bg: '#fff', fg: '#000' };
  }
  const addTile = (title,val)=> {
    const d=document.createElement('div'); d.className='tile';
    d.innerHTML=`<h4 style="margin:0 0 6px 0">${title}</h4><div style="font-weight:700;font-size:20px">${val}</div>`;
    // apply color for tiles (bg + foreground)
    const clr = tileColor(title);
    d.style.background = clr.bg;
    d.style.color = clr.fg;
    // make tile clickable: apply filter and navigate
    d.style.cursor = 'pointer';
    d.addEventListener('click', function(){
      try{ applyDashboardTile(title); }catch(e){ console.error('tile click error', e); }
    });
    tiles.appendChild(d);
  };
  addTile('إجمالي الأعطال', total);
  addTile('تم الإصلاح', done);
  addTile('جاري الإصلاح', working);
  addTile('أعطال تحت التجربة', testing);
  addTile('بانتظار رد الشركة', waitC);
  addTile('بانتظار قطعة الغيار', waitP);
  addTile('إجمالي الصيانات', maintenanceTotal);
  addTile('صيانة أسبوعية', mainWeekly);
  addTile('صيانة شهرية', mainMonthly);
  addTile('الصيانات ربع سنوية', mainQuarterAll);
  addTile('صيانة سنوية', mainYearly);
  addTile('صيانة طارئة', mainEmergency);

  const canvas = document.getElementById('pie'); const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
  const data = [done, working, testing, waitC, waitP]; const colors=['#8ed08e','#ffd966','#fff3b0','#ffd59e','#ffb4b4']; const labels=['تم الإصلاح','جاري الإصلاح','تحت التجربة','بانتظار رد الشركة','بانتظار قطعة الغيار'];
  const cx=canvas.width/2, cy=canvas.height/2, r=Math.min(cx,cy)-20;
  let start=0; const totalSum = data.reduce((a,b)=>a+b,0);
  for(let i=0;i<data.length;i++){
    const slice = totalSum===0?0:(data[i]/totalSum)*(Math.PI*2);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle=colors[i]; ctx.arc(cx,cy,r,start,start+slice); ctx.closePath(); ctx.fill();
    start += slice;
  }
  ctx.font='13px Arial'; let ly=10; for(let i=0;i<labels.length;i++){ ctx.fillStyle=colors[i]; ctx.fillRect(10,ly,12,12); ctx.fillStyle='#000'; ctx.fillText(` ${labels[i]} (${data[i]})`, 28, ly+10); ly+=18; }
  const tbody = document.querySelector('#dashTable tbody'); tbody.innerHTML=''; labels.forEach((lab,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${lab}</td><td>${data[i]}</td>`; tbody.appendChild(tr);});
}

/* init render */
// ═════════════════════════════════════════════════════════════════
// 16. الإنشاء والتهيئة الأولية
// ═════════════════════════════════════════════════════════════════
// تأكد من طلب كلمة المرور بعد كل تحديث/ريفرش بإزالة العلم المخزن عند تحميل الصفحة
try{ sessionStorage.removeItem('attendanceUnlocked'); }catch(e){}
// أيضاً أزل معرف السجل الوحيد لعرض كل السجلات بعد الريفرش عند إدخال كلمة المرور
try{ sessionStorage.removeItem('attendanceVisibleOnlyId'); }catch(e){}
renderFaultTable(); renderOrderTable(); renderMaintenanceTable(); renderAttendanceTable(); renderTrash(); drawDashboard();

function loadFromServer() {
  // 1) تحميل الأعطال من السيرفر
  fetch(API_URL + '?kind=faults')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      // نضّف التواريخ
      data.forEach(f => { if(f.date) f.date = formatDateOnly(f.date); });
      // فصل الأعطال النشطة عن المحذوفة بناءً على عمود "Delete?"
      faults = data.filter(f => !f.deleted && f.deleted !== 'Yes' && f.deleted !== 'TRUE' && f.deleted !== true);
      const deletedFaults = data.filter(f => f.deleted === 'Yes' || f.deleted === 'TRUE' || f.deleted === true);
      
      trash.faults = deletedFaults;  // حط المحذوفة في السلة
      renderFaultTable();         // اعرض جدول الأعطال النشطة
      renderTrash();              // اعرض سلة المحذوفات
      drawDashboard();            // حدّث الـ Dashboard
      saveAll();                  // احفظ البيانات محليًا
    })
    .catch(err => {
      console.error('خطأ في تحميل الأعطال من السيرفر', err);
    });

  // 2) تحميل أوامر الشراء من السيرفر
  fetch(API_URL + '?kind=orders')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      // نضّف التواريخ
      data.forEach(o => { if(o.date) o.date = formatDateOnly(o.date); });
      // فصل الأوامر النشطة عن المحذوفة بناءً على عمود "Delete?"
      orders = data.filter(o => !o.deleted && o.deleted !== 'Yes' && o.deleted !== 'TRUE' && o.deleted !== true);
      const deletedOrders = data.filter(o => o.deleted === 'Yes' || o.deleted === 'TRUE' || o.deleted === true);
      
      trash.orders = deletedOrders;  // حط المحذوفة في السلة
      renderOrderTable();         // اعرض جدول الأوامر النشطة
      renderTrash();              // اعرض سلة المحذوفات
      saveAll();                  // احفظ البيانات محليًا
    })
    .catch(err => {
      console.error('خطأ في تحميل أوامر الشراء من السيرفر', err);
    });

  // 3) تحميل سجلات الصيانة من السيرفر
  fetch(API_URL + '?kind=maintenance')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      // نضّف التواريخ
      data.forEach(m => { if(m.date) m.date = formatDateOnly(m.date); });
      // فصل الصيانات النشطة عن المحذوفة بناءً على حقل "deleted"
      maintenance = data.filter(m => !m.deleted && m.deleted !== 'Yes' && m.deleted !== 'TRUE' && m.deleted !== true);
      const deletedMaintenance = data.filter(m => m.deleted === 'Yes' || m.deleted === 'TRUE' || m.deleted === true);
      
      trash.maintenance = deletedMaintenance;  // حط المحذوفة في السلة
      renderMaintenanceTable();             // اعرض جدول الصيانات النشطة
      renderTrash();                        // اعرض سلة المحذوفات
      drawDashboard();                      // حدّث الـ Dashboard
      saveAll();                            // احفظ البيانات محليًا
    })
    .catch(err => {
      console.error('خطأ في تحميل سجلات الصيانة من السيرفر', err);
    });

  // 4) تحميل سجلات الأجازات من السيرفر
  fetch(API_URL + '?kind=attendance')
    .then(r => r.json())
    .then(data => {
      if (!Array.isArray(data)) return;
      // نضّف التواريخ
      data.forEach(a => { if(a.absenceDate) a.absenceDate = formatDateOnly(a.absenceDate); });
      // فصل السجلات النشطة عن المحذوفة بناءً على حقل "deleted"
      attendance = data.filter(a => !a.deleted && a.deleted !== 'Yes' && a.deleted !== 'TRUE' && a.deleted !== true);
      const deletedAttendance = data.filter(a => a.deleted === 'Yes' || a.deleted === 'TRUE' || a.deleted === true);
      
      trash.attendance = deletedAttendance;  // حط المحذوفة في السلة
      renderAttendanceTable();            // اعرض جدول الأجازات النشطة
      renderTrash();                      // اعرض سلة المحذوفات
      saveAll();                          // احفظ البيانات محليًا
    })
    .catch(err => {
      console.error('خطأ في تحميل سجلات الأجازات من السيرفر', err);
    });
}

// تحميل البيانات من السيرفر بعد ما نعمل رندر مبدئي من localStorage (لو موجودة)
loadFromServer();

function renderFaultTable(){ 
  // ═════════════════════════════════════════════════════════════════
  // 17. دوال الرسم والتصيير (Render) الرئيسية
  // ═════════════════════════════════════════════════════════════════
  const tbody = document.querySelector('#faultTable tbody'); 
  tbody.innerHTML=''; 
  const cardsDiv = document.getElementById('faultCards');
  cardsDiv.innerHTML = '';
  
  // اقرأ شروط الفلترة الحالية
  const q = (document.getElementById('search')?.value||'').toLowerCase();
  const st = (document.getElementById('filterStatus')?.value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromFault')?.value;
  const dateTo = document.getElementById('dateToFault')?.value;

  let dataToRender = [];
  let totalPages = 1;
  if(isFilteredFaults){
    dataToRender = faults.filter(f => {
      if(f.deleted) return false;
      const text = `${f.machine||''} ${f.line||''} ${f.person||''} ${f.description||''} ${f.solution||''} ${f.status||''}`.toLowerCase();
      const statusMatch = !st || text.includes(st);
      const rowDate = f.date || '';
      let dateMatch = true;
      if(dateFrom && dateTo) dateMatch = (rowDate >= dateFrom && rowDate <= dateTo);
      else if(dateFrom) dateMatch = (rowDate >= dateFrom);
      else if(dateTo) dateMatch = (rowDate <= dateTo);
      return ((!q || text.includes(q)) && statusMatch && dateMatch);
    });
    totalPages = 1;
  } else {
    const paginationData = paginate(faults, currentPageFaults);
    dataToRender = paginationData.items;
    totalPages = paginationData.totalPages;
  }
  
  dataToRender.forEach((f, pageIndex)=>{ 
    // الرقم العام (مع الترتيب التنازلي)
    const globalIndex = isFilteredFaults ? pageIndex + 1 : (currentPageFaults - 1) * ITEMS_PER_PAGE + pageIndex + 1;
    
    // Table row
    const tr=document.createElement('tr'); 
    tr.innerHTML = `<td>${globalIndex}</td><td>${escapeHtml(f.machine)}</td><td>${escapeHtml(f.line)}</td><td>${escapeHtml(f.person)}</td><td>${escapeHtml(f.description)}</td><td>${escapeHtml(f.solution||'')}</td><td>${escapeHtml(f.shift)}</td><td>${escapeHtml(f.date)}</td><td>${escapeHtml(f.lcode)}</td><td>${escapeHtml(f.partName)}</td><td>${escapeHtml(f.partQty)}</td><td class="status-cell">${escapeHtml(f.status)}</td><td class="no-print actions"><button class="btn ghost" onclick="startEditFault('${f.id}')">تعديل</button><button class="btn" onclick="moveToTrashFault('${f.id}')">حذف</button></td>`; 
    const sc = tr.querySelector('.status-cell'); 
    if(f.status==='تم الإصلاح') sc.classList.add('status-okay'); 
    else if(f.status==='جاري الإصلاح' || f.status==='تحت التجربة') sc.classList.add('status-working'); 
    else if(f.status==='بانتظار رد الشركة') sc.classList.add('status-wait-company'); 
    else if(f.status==='بانتظار قطعة الغيار') sc.classList.add('status-wait-part'); 
    tbody.appendChild(tr); 
    
    // Card view for mobile
    const card = document.createElement('div');
    card.className = 'fault-card';
    const statusClass = f.status==='تم الإصلاح'?'status-okay':(f.status==='جاري الإصلاح'||f.status==='تحت التجربة')?'status-working':(f.status==='بانتظار رد الشركة')?'status-wait-company':'status-wait-part';
    card.innerHTML = `
      <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">${globalIndex} - ${escapeHtml(f.machine)}</div>
      <div class="fault-card-row"><div class="fault-card-label">الخط:</div><div class="fault-card-value">${displayValue(f.line)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">القائم:</div><div class="fault-card-value">${displayValue(f.person)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">الوصف:</div><div class="fault-card-value">${displayValue(f.description)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">حل العطل:</div><div class="fault-card-value">${displayValue(f.solution)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">الوردية:</div><div class="fault-card-value">${displayValue(f.shift)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">التاريخ:</div><div class="fault-card-value">${displayValue(f.date)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">L Number:</div><div class="fault-card-value">${displayValue(f.lcode)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">اسم القطعة:</div><div class="fault-card-value">${displayValue(f.partName)}</div></div>
      <div class="fault-card-row"><div class="fault-card-label">الكمية:</div><div class="fault-card-value">${displayValue(f.partQty)}</div></div>
      <div class="fault-card-row" style="margin-top:14px"><div class="fault-card-label">الحالة:</div><div class="fault-card-value"><div class="card-status-badge ${statusClass}">${escapeHtml(f.status)}</div></div></div>
      <div class="fault-card-actions">
        <button class="btn ghost" onclick="startEditFault('${f.id}')">تعديل</button>
        <button class="btn" onclick="moveToTrashFault('${f.id}')">حذف</button>
      </div>
    `;
    cardsDiv.appendChild(card);
  });
  
  // تحديث أزرار pagination - إخفاء إذا كانت مفلترة
  if(!isFilteredFaults) {
    updatePaginationButtons('#faultsPagination', totalPages, currentPageFaults, (pageNum) => {
      currentPageFaults = pageNum;
      renderFaultTable();
    });
  }
  
  saveAll(); 
}

function renderOrderTable(){ 
  const tbody = document.querySelector('#orderTable tbody'); 
  tbody.innerHTML=''; 
  const cardsDiv = document.getElementById('orderCards');
  cardsDiv.innerHTML = '';
  
  // اقرأ شروط الفلترة الحالية
  const q=(document.getElementById('searchOrder')?.value||'').toLowerCase();
  const dateFrom = document.getElementById('dateFromOrder')?.value;
  const dateTo = document.getElementById('dateToOrder')?.value;

  let dataToRender = [];
  let totalPages = 1;
  if(isFilteredOrders){
    dataToRender = orders.filter(o => {
      if(o.deleted) return false;
      const text = `${o.orderNum||''} ${o.supplyNum||''} ${o.person||''} ${o.details||''}`.toLowerCase();
      const rowDate = o.date || '';
      let dateMatch = true;
      if(dateFrom && dateTo) dateMatch = (rowDate >= dateFrom && rowDate <= dateTo);
      else if(dateFrom) dateMatch = (rowDate >= dateFrom);
      else if(dateTo) dateMatch = (rowDate <= dateTo);
      return (!q || text.includes(q)) && dateMatch;
    });
    totalPages = 1;
  } else {
    const paginationData = paginate(orders, currentPageOrders);
    dataToRender = paginationData.items;
    totalPages = paginationData.totalPages;
  }
  
  dataToRender.forEach((o, pageIndex)=>{ 
    // الرقم العام (مع الترتيب التنازلي)
    const globalIndex = isFilteredOrders ? pageIndex + 1 : (currentPageOrders - 1) * ITEMS_PER_PAGE + pageIndex + 1;
    
    // Table row
    const tr=document.createElement('tr'); 
    tr.innerHTML = `<td>${escapeHtml(o.orderNum)}</td><td>${escapeHtml(o.supplyNum)}</td><td>${escapeHtml(o.date)}</td><td>${escapeHtml(o.person)}</td><td>${escapeHtml(o.details||'')}</td><td class="no-print actions"><button class="btn ghost" onclick="startEditOrder('${o.id}')">تعديل</button><button class="btn" onclick="moveToTrashOrder('${o.id}')">حذف</button></td>`; 
    tbody.appendChild(tr); 
    
    // Card view for mobile
    const card = document.createElement('div');
    card.className = 'order-card';
    card.innerHTML = `
      <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">أمر #${globalIndex}</div>
      <div class="order-card-row"><div class="order-card-label">أمر الشراء:</div><div class="order-card-value">${displayValue(o.orderNum)}</div></div>
      <div class="order-card-row"><div class="order-card-label">التوريد:</div><div class="order-card-value">${displayValue(o.supplyNum)}</div></div>
      <div class="order-card-row"><div class="order-card-label">التاريخ:</div><div class="order-card-value">${displayValue(o.date)}</div></div>
      <div class="order-card-row"><div class="order-card-label">القائم:</div><div class="order-card-value">${displayValue(o.person)}</div></div>
      <div class="order-card-row"><div class="order-card-label">التفاصيل:</div><div class="order-card-value">${displayValue(o.details)}</div></div>
      <div class="order-card-actions">
        <button class="btn ghost" onclick="startEditOrder('${o.id}')">تعديل</button>
        <button class="btn" onclick="moveToTrashOrder('${o.id}')">حذف</button>
      </div>
    `;
    cardsDiv.appendChild(card);
  }); 
  
  // تحديث أزرار pagination - إخفاء إذا كانت مفلترة
  if(!isFilteredOrders) {
    updatePaginationButtons('#ordersPagination', totalPages, currentPageOrders, (pageNum) => {
      currentPageOrders = pageNum;
      renderOrderTable();
    });
  }
  
  saveAll(); 
}

function renderMaintenanceTable(){ 
  const tbody = document.querySelector('#maintenanceTable tbody'); 
  tbody.innerHTML=''; 
  const cardsDiv = document.getElementById('maintenanceCards');
  cardsDiv.innerHTML = '';
  
  // قراءة شروط الفلترة الحالية (للمساعدة عند إعادة العرض)
  const q = (document.getElementById('searchMaintenance')?.value||'').toLowerCase();
  const filterType = (document.getElementById('filterMaintenanceType')?.value||'').trim();
  const dateFrom = document.getElementById('dateFromMaintenance')?.value;
  const dateTo = document.getElementById('dateToMaintenance')?.value;

  // جهّز البيانات للعرض؛ عند وجود فلتر اعرض النتائج المفلترة مرة واحدة
  let dataToRender = [];
  let totalPages = 1;
  if(isFilteredMaintenance){
    dataToRender = maintenance.filter(m => {
      if(m.deleted) return false;
      const text = `${m.machine||''} ${m.line||''} ${m.person||''} ${m.partName||''} ${m.notes||''} ${m.type||''}`.toLowerCase();
      const typeMatch = !filterType || ((m.type||'') === filterType);
      const rowDate = m.date || '';
      let dateMatch = true;
      if(dateFrom && dateTo) dateMatch = (rowDate >= dateFrom && rowDate <= dateTo);
      else if(dateFrom) dateMatch = (rowDate >= dateFrom);
      else if(dateTo) dateMatch = (rowDate <= dateTo);
      return ((!q || text.includes(q)) && typeMatch && dateMatch);
    });
    totalPages = 1;
  } else {
    const paginationData = paginate(maintenance, currentPageMaintenance);
    dataToRender = paginationData.items;
    totalPages = paginationData.totalPages;
  }

  dataToRender.forEach((m, pageIndex)=>{
    const globalIndex = isFilteredMaintenance ? pageIndex + 1 : (currentPageMaintenance - 1) * ITEMS_PER_PAGE + pageIndex + 1;
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${globalIndex}</td><td>${escapeHtml(m.machine)}</td><td>${escapeHtml(m.line)}</td><td>${escapeHtml(m.person)}</td><td>${escapeHtml(m.date)}</td><td>${escapeHtml(m.lcode)}</td><td>${escapeHtml(m.partName)}</td><td>${escapeHtml(m.partQty)}</td><td>${escapeHtml(m.type)}</td><td>${escapeHtml(m.notes)}</td><td class="no-print actions"><button class="btn ghost" onclick="startEditMaintenance('${m.id}')">تعديل</button><button class="btn" onclick="moveToTrashMaintenance('${m.id}')">حذف</button></td>`;
    tbody.appendChild(tr);

    const card = document.createElement('div');
    card.className = 'order-card';
    card.innerHTML = `
      <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">صيانة #${globalIndex}</div>
      <div class="order-card-row"><div class="order-card-label">الماكينة:</div><div class="order-card-value">${displayValue(m.machine)}</div></div>
      <div class="order-card-row"><div class="order-card-label">الخط:</div><div class="order-card-value">${displayValue(m.line)}</div></div>
      <div class="order-card-row"><div class="order-card-label">القائم:</div><div class="order-card-value">${displayValue(m.person)}</div></div>
      <div class="order-card-row"><div class="order-card-label">التاريخ:</div><div class="order-card-value">${displayValue(m.date)}</div></div>
      <div class="order-card-row"><div class="order-card-label">L Number:</div><div class="order-card-value">${displayValue(m.lcode)}</div></div>
      <div class="order-card-row"><div class="order-card-label">القطعة:</div><div class="order-card-value">${displayValue(m.partName)}</div></div>
      <div class="order-card-row"><div class="order-card-label">الكمية:</div><div class="order-card-value">${displayValue(m.partQty)}</div></div>
      <div class="order-card-row"><div class="order-card-label">النوع:</div><div class="order-card-value">${displayValue(m.type)}</div></div>
      <div class="order-card-row"><div class="order-card-label">الملاحظات:</div><div class="order-card-value">${displayValue(m.notes)}</div></div>
      <div class="order-card-actions">
        <button class="btn ghost" onclick="startEditMaintenance('${m.id}')">تعديل</button>
        <button class="btn" onclick="moveToTrashMaintenance('${m.id}')">حذف</button>
      </div>
    `;
    cardsDiv.appendChild(card);
  });

  // تحديث أزرار pagination - إخفاء إذا كانت مفلترة
  if(!isFilteredMaintenance){
    updatePaginationButtons('#maintenancePagination', totalPages, currentPageMaintenance, (pageNum) => {
      currentPageMaintenance = pageNum;
      renderMaintenanceTable();
    });
  }

  saveAll(); 
}

function renderTrash(){
  // FAULTS
  const tf = document.querySelector('#trashFaults tbody');
  const tfCards = document.getElementById('trashFaultsCards');
  
  if(tf) {
    tf.innerHTML='';
    if(tfCards) tfCards.innerHTML='';
    
    (trash.faults || []).forEach((f,i)=>{
      const tr=document.createElement('tr');
      const tdInfo = document.createElement('td');
      tdInfo.innerHTML = `${i+1} - ${escapeHtml(f.machine)} (${escapeHtml(f.date)})`;

      const tdActions = document.createElement('td');
      tdActions.className = 'no-print actions';

      const restoreBtn = document.createElement('button');
      restoreBtn.className = 'btn';
      restoreBtn.textContent = 'استرجاع';
      restoreBtn.addEventListener('click', () => restoreFault(f.id));

      const permBtn = document.createElement('button');
      permBtn.className = 'btn ghost';
      permBtn.textContent = 'حذف نهائي';
      permBtn.addEventListener('click', () => permanentDeleteFault(f.id));

      tdActions.appendChild(restoreBtn);
      tdActions.appendChild(permBtn);
      tr.appendChild(tdInfo);
      tr.appendChild(tdActions);
      tf.appendChild(tr);

      // Card for mobile
      if(tfCards){
        const card = document.createElement('div');
        card.className = 'fault-card';
        card.innerHTML = `
          <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">عطل #${i+1}</div>
          <div class="fault-card-row"><div class="fault-card-label">الماكينة:</div><div class="fault-card-value">${displayValue(f.machine)}</div></div>
          <div class="fault-card-row"><div class="fault-card-label">التاريخ:</div><div class="fault-card-value">${displayValue(f.date)}</div></div>
          <div class="fault-card-actions">
            <button class="btn" onclick="restoreFault('${f.id}')">استرجاع</button>
            <button class="btn ghost" onclick="permanentDeleteFault('${f.id}')">حذف نهائي</button>
          </div>
        `;
        tfCards.appendChild(card);
      }
    });
  }

  // ORDERS
  const to = document.querySelector('#trashOrders tbody');
  const toCards = document.getElementById('trashOrdersCards');
  
  if(to) {
    to.innerHTML='';
    if(toCards) toCards.innerHTML='';
    
    (trash.orders || []).forEach((o,i)=>{
      const tr=document.createElement('tr');
      const tdInfo = document.createElement('td');
      tdInfo.innerHTML = `${escapeHtml(o.orderNum)} - ${escapeHtml(o.date)}`;

      const tdActions = document.createElement('td');
      tdActions.className = 'no-print actions';

      const restoreBtn = document.createElement('button');
      restoreBtn.className = 'btn';
      restoreBtn.textContent = 'استرجاع';
      restoreBtn.addEventListener('click', () => restoreOrder(o.id));

      const permBtn = document.createElement('button');
      permBtn.className = 'btn ghost';
      permBtn.textContent = 'حذف نهائي';
      permBtn.addEventListener('click', () => permanentDeleteOrder(o.id));

      tdActions.appendChild(restoreBtn);
      tdActions.appendChild(permBtn);
      tr.appendChild(tdInfo);
      tr.appendChild(tdActions);
      to.appendChild(tr);

      // Card for mobile
      if(toCards){
        const card = document.createElement('div');
        card.className = 'order-card';
        card.innerHTML = `
          <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">أمر #${i+1}</div>
          <div class="order-card-row"><div class="order-card-label">رقم الأمر:</div><div class="order-card-value">${displayValue(o.orderNum)}</div></div>
          <div class="order-card-row"><div class="order-card-label">التاريخ:</div><div class="order-card-value">${displayValue(o.date)}</div></div>
          <div class="order-card-actions">
            <button class="btn" onclick="restoreOrder('${o.id}')">استرجاع</button>
            <button class="btn ghost" onclick="permanentDeleteOrder('${o.id}')">حذف نهائي</button>
          </div>
        `;
        toCards.appendChild(card);
      }
    });
  }

  // MAINTENANCE
  const tm = document.querySelector('#trashMaintenance tbody');
  const tmCards = document.getElementById('trashMaintenanceCards');
  
  if(tm){
    tm.innerHTML='';
    if(tmCards) tmCards.innerHTML='';
    
    (trash.maintenance||[]).forEach((m,i)=>{
      const tr=document.createElement('tr');
      const tdInfo = document.createElement('td');
      tdInfo.innerHTML = `${i+1} - ${escapeHtml(m.machine)} (${escapeHtml(m.date)})`;

      const tdActions = document.createElement('td');
      tdActions.className = 'no-print actions';

      const restoreBtn = document.createElement('button');
      restoreBtn.className = 'btn';
      restoreBtn.textContent = 'استرجاع';
      restoreBtn.addEventListener('click', () => restoreMaintenance(m.id));

      const permBtn = document.createElement('button');
      permBtn.className = 'btn ghost';
      permBtn.textContent = 'حذف نهائي';
      permBtn.addEventListener('click', () => permanentDeleteMaintenance(m.id));

      tdActions.appendChild(restoreBtn);
      tdActions.appendChild(permBtn);
      tr.appendChild(tdInfo);
      tr.appendChild(tdActions);
      tm.appendChild(tr);

      // Card for mobile
      if(tmCards){
        const card = document.createElement('div');
        card.className = 'order-card';
        card.innerHTML = `
          <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">صيانة #${i+1}</div>
          <div class="order-card-row"><div class="order-card-label">الماكينة:</div><div class="order-card-value">${displayValue(m.machine)}</div></div>
          <div class="order-card-row"><div class="order-card-label">التاريخ:</div><div class="order-card-value">${displayValue(m.date)}</div></div>
          <div class="order-card-actions">
            <button class="btn" onclick="restoreMaintenance('${m.id}')">استرجاع</button>
            <button class="btn ghost" onclick="permanentDeleteMaintenance('${m.id}')">حذف نهائي</button>
          </div>
        `;
        tmCards.appendChild(card);
      }
    });
  }

  // ATTENDANCE
  const ta = document.querySelector('#trashAttendance tbody');
  const taCards = document.getElementById('trashAttendanceCards');
  
  if(ta){
    ta.innerHTML='';
    if(taCards) taCards.innerHTML='';
    
    (trash.attendance||[]).forEach((a,i)=>{
      const tr=document.createElement('tr');
      const tdIndex = document.createElement('td'); tdIndex.textContent = i+1;
      const tdInfo = document.createElement('td'); tdInfo.innerHTML = `${escapeHtml(a.workerName)} / ${escapeHtml(a.workerNum)}`;
      const tdDate = document.createElement('td'); tdDate.textContent = escapeHtml(a.absenceDate);

      const tdActions = document.createElement('td'); tdActions.className = 'no-print actions';
      const restoreBtn = document.createElement('button'); restoreBtn.className = 'btn'; restoreBtn.textContent = 'استرجاع'; restoreBtn.addEventListener('click', ()=> restoreAttendance(a.id));
      const permBtn = document.createElement('button'); permBtn.className = 'btn ghost'; permBtn.textContent = 'حذف نهائي'; permBtn.addEventListener('click', ()=> permanentDeleteAttendance(a.id));
      tdActions.appendChild(restoreBtn); tdActions.appendChild(permBtn);

      tr.appendChild(tdIndex); tr.appendChild(tdInfo); tr.appendChild(tdDate); tr.appendChild(tdActions);
      ta.appendChild(tr);

      // Card for mobile
      if(taCards){
        const card = document.createElement('div');
        card.className = 'order-card';
        card.innerHTML = `
          <div style="text-align:center;font-weight:600;margin-bottom:12px;font-size:15px;padding-bottom:8px;border-bottom:2px solid #e9eef3">حضور #${i+1}</div>
          <div class="order-card-row"><div class="order-card-label">الاسم:</div><div class="order-card-value">${displayValue(a.workerName)}</div></div>
          <div class="order-card-row"><div class="order-card-label">الرقم:</div><div class="order-card-value">${displayValue(a.workerNum)}</div></div>
          <div class="order-card-row"><div class="order-card-label">التاريخ:</div><div class="order-card-value">${displayValue(a.absenceDate)}</div></div>
          <div class="order-card-actions">
            <button class="btn" onclick="restoreAttendance('${a.id}')">استرجاع</button>
            <button class="btn ghost" onclick="permanentDeleteAttendance('${a.id}')">حذف نهائي</button>
          </div>
        `;
        taCards.appendChild(card);
      }
    });
  }
}

/* wire inputs for live filters & actions */
// ═════════════════════════════════════════════════════════════════
// 18. ربط أزرار وحقول الإدخال مع أحداث البحث والفلترة
// ═════════════════════════════════════════════════════════════════
document.getElementById('search').addEventListener('input', applyFilters);
document.getElementById('filterStatus').addEventListener('input', applyFilters);
document.getElementById('searchOrder').addEventListener('input', applyOrderFilters);

/* ensure exports buttons exist even if no data */
// ═════════════════════════════════════════════════════════════════
// 19. التأكد من وجود الأزرار الأساسية والمعالجات
// ═════════════════════════════════════════════════════════════════
document.getElementById('exportCsvAll').addEventListener('click', ()=>{ if(!faults.length){ alert('لا توجد بيانات للتصدير'); return;} /* handled above */ });
document.getElementById('exportDocAll').addEventListener('click', ()=>{ if(!faults.length){ alert('لا توجد بيانات للتصدير'); return;} });
document.getElementById('exportOrdersCsv').addEventListener('click', ()=>{ if(!orders.length){ alert('لا توجد أوامر للتصدير'); return;} });
document.getElementById('exportOrdersDoc').addEventListener('click', ()=>{ if(!orders.length){ alert('لا توجد أوامر للتصدير'); return;} });
document.getElementById('printPdfAll').addEventListener('click', ()=>{/* handled above */});
document.getElementById('printOrdersBtn').addEventListener('click', ()=>{/* handled above */});

/* final save */
// ═════════════════════════════════════════════════════════════════
// 20. الحفظ النهائي والإغلاق
// ═════════════════════════════════════════════════════════════════
saveAll();
</script>
</script>
<script>
  (function(){
    function showAlert(msg, el){
      alert(msg);
      if(el && typeof el.focus === 'function') el.focus();
    }

    function hasSelection(selectEl){
      if(!selectEl) return false;
      if(selectEl.multiple){
        return Array.from(selectEl.options).some(function(o){ return o.selected && o.value.trim() !== ''; });
      }
      return selectEl.value && selectEl.value.trim() !== '';
    }

    function validateFault(){
      var machineGroup = document.getElementById('machineGroup');
      var machineItem = document.getElementById('machineItem');
      var person = document.getElementById('person');
      var personChips = document.getElementById('personChips');
      var description = document.getElementById('description');
      var solution = document.getElementById('solution');
      var shift = document.getElementById('shift');
      var date = document.getElementById('date');
      var partChanged = document.getElementById('partChanged');
      var lcode = document.getElementById('lcode');
      var partName = document.getElementById('partName');
      var partQty = document.getElementById('partQty');
      var status = document.getElementById('status');

      if(!machineGroup || machineGroup.value.trim()==='') { showAlert('من فضلك اختر المجموعة (الخط).', machineGroup); return false; }
      // إذا كانت المجموعة "معمل الجودة"، اطلب اسم الماكينة والقائم بالعطل
      if(machineGroup && machineGroup.value === 'معمل الجودة'){
        var customName = document.getElementById('customMachineName');
        if(!customName || customName.value.trim() === ''){ showAlert('من فضلك ادخل اسم الماكينة.', customName); return false; }
        if(!(hasSelection(person) || (personChips && personChips.textContent.trim() !== ''))){ showAlert('من فضلك اختر اسم/أسماء القائم بالعطل.', person); return false; }
      } else if(machineGroup && machineGroup.value === 'أخري'){
        var customPlace = document.getElementById('customMachinePlace');
        var customName = document.getElementById('customMachineName');
        if(!customPlace || customPlace.value.trim() === ''){ showAlert('من فضلك ادخل مكان الماكينة.', customPlace || machineGroup); return false; }
        if(!customName || customName.value.trim() === ''){ showAlert('من فضلك ادخل اسم الماكينة.', customName); return false; }
      } else {
        if(!machineItem || machineItem.value.trim()==='') { showAlert('من فضلك اختر الماكينة.', machineItem); return false; }
      }
      if(!(hasSelection(person) || (personChips && personChips.textContent.trim() !== ''))){ showAlert('من فضلك اختر اسم/أسماء القائم بالعطل.', person); return false; }
      if(!description || description.value.trim()===''){ showAlert('من فضلك ادخل وصف العطل.', description); return false; }
      if(!solution || solution.value.trim()===''){ showAlert('من فضلك ادخل شرح حل العطل.', solution); return false; }
      if(!shift || shift.value.trim()===''){ showAlert('من فضلك اختر الوردية.', shift); return false; }
      if(!date || date.value.trim()===''){ showAlert('من فضلك اختر التاريخ.', date); return false; }
      if(!partChanged || partChanged.value.trim()===''){ showAlert('من فضلك اختر هل تم تغيير قطعة غيار.', partChanged); return false; }
      if(partChanged && partChanged.value === 'yes'){
        if(!lcode || lcode.value.trim()===''){ showAlert('من فضلك ادخل كود المخزن (L Number).', lcode); return false; }
        if(!partName || partName.value.trim()===''){ showAlert('من فضلك ادخل اسم قطعة الغيار.', partName); return false; }
        if(!partQty || partQty.value === '' || Number(partQty.value) <= 0){ showAlert('من فضلك ادخل كمية صحيحة لقطعة الغيار.', partQty); return false; }
      }
      if(!status || status.value.trim()===''){ showAlert('من فضلك اختر حالة العطل.', status); return false; }
      return true;
    }

    function validateMaintenance(){
      var mainGroup = document.getElementById('mainGroup');
      var mainItem = document.getElementById('mainItem');
      var mainPerson = document.getElementById('mainPerson');
      var mainPersonChips = document.getElementById('mainPersonChips');
      var mainDate = document.getElementById('mainDate');
      var mainPartChanged = document.getElementById('mainPartChanged');
      var mainLcode = document.getElementById('mainLcode');
      var mainPartName = document.getElementById('mainPartName');
      var mainPartQty = document.getElementById('mainPartQty');
      var mainType = document.getElementById('mainType');

      if(!mainGroup || mainGroup.value.trim()===''){ showAlert('من فضلك اختر المجموعة (الخط).', mainGroup); return false; }
      // إذا كانت المجموعة "معمل الجودة"، اطلب اسم الماكينة والقائم بالصيانة
      if(mainGroup && mainGroup.value === 'معمل الجودة'){
        var customMainName = document.getElementById('customMainName');
        if(!customMainName || customMainName.value.trim() === ''){ showAlert('من فضلك ادخل اسم الماكينة.', customMainName); return false; }
        if(!(hasSelection(mainPerson) || (mainPersonChips && mainPersonChips.textContent.trim() !== ''))){ showAlert('من فضلك اختر اسم/أسماء القائم بالصيانة.', mainPerson); return false; }
      } else if(mainGroup && mainGroup.value === 'أخري'){
        var customMainPlace = document.getElementById('customMainPlace');
        var customMainName = document.getElementById('customMainName');
        if(!customMainPlace || customMainPlace.value.trim() === ''){ showAlert('من فضلك ادخل مكان الماكينة.', customMainPlace || mainGroup); return false; }
        if(!customMainName || customMainName.value.trim() === ''){ showAlert('من فضلك ادخل اسم الماكينة.', customMainName); return false; }
      } else {
        if(!mainItem || mainItem.value.trim()===''){ showAlert('من فضلك اختر الماكينة.', mainItem); return false; }
      }
      if(!(hasSelection(mainPerson) || (mainPersonChips && mainPersonChips.textContent.trim() !== ''))){ showAlert('من فضلك اختر اسم/أسماء القائم بالصيانة.', mainPerson); return false; }
      if(!mainDate || mainDate.value.trim()===''){ showAlert('من فضلك اختر التاريخ.', mainDate); return false; }
      if(!mainPartChanged || mainPartChanged.value.trim()===''){ showAlert('من فضلك اختر هل تم تغيير قطعة غيار.', mainPartChanged); return false; }
      if(mainPartChanged && mainPartChanged.value === 'yes'){
        if(!mainLcode || mainLcode.value.trim()===''){ showAlert('من فضلك ادخل كود المخزن (L Number).', mainLcode); return false; }
        if(!mainPartName || mainPartName.value.trim()===''){ showAlert('من فضلك ادخل اسم قطعة الغيار.', mainPartName); return false; }
        if(!mainPartQty || mainPartQty.value === '' || Number(mainPartQty.value) <= 0){ showAlert('من فضلك ادخل كمية صحيحة لقطعة الغيار.', mainPartQty); return false; }
      }
      if(!mainType || mainType.value.trim()===''){ showAlert('من فضلك اختر نوع الصيانة.', mainType); return false; }
      return true;
    }

    function validateOrder(){
      var orderNum = document.getElementById('orderNum');
      var orderDate = document.getElementById('orderDate');
      var orderPerson = document.getElementById('orderPerson');
      var orderPersonChips = document.getElementById('orderPersonChips');
      var orderDetails = document.getElementById('orderDetails');

      if(!orderNum || orderNum.value.trim()===''){ showAlert('من فضلك ادخل رقم أمر الشراء.', orderNum); return false; }
      if(!orderDate || orderDate.value.trim()===''){ showAlert('من فضلك اختر تاريخ أمر الشراء.', orderDate); return false; }
      if(!(hasSelection(orderPerson) || (orderPersonChips && orderPersonChips.textContent.trim() !== ''))){ showAlert('من فضلك اختر القائم على أمر الشراء.', orderPerson); return false; }
      if(!orderDetails || orderDetails.value.trim()===''){ showAlert('من فضلك ادخل تفاصيل أمر الشراء.', orderDetails); return false; }
      return true;
    }

    // مستمع الحدث للتحقق من الصحة قبل الإرسال (محذوف - يتم التحقق في addMaintenance)
    var addOrderBtn = document.getElementById('addOrderBtn');
    if(addOrderBtn) addOrderBtn.addEventListener('click', function(e){ if(!validateOrder()){ e.stopImmediatePropagation(); e.preventDefault(); } }, true);

    function togglePartFields(selectElId, containerId){
      var sel = document.getElementById(selectElId);
      var container = document.getElementById(containerId);
      if(!sel || !container) return;
      sel.addEventListener('change', function(){
        var required = sel.value === 'yes';
        Array.from(container.querySelectorAll('input')).forEach(function(inp){
          if(required) inp.setAttribute('required','required'); else inp.removeAttribute('required');
        });
        container.style.display = required ? 'block' : 'none';
      });
    }
    togglePartFields('partChanged','partFieldsContainer');
    togglePartFields('mainPartChanged','mainPartFieldsContainer');
  })();
</script>
<!-- Success toast (centered) -->
<style>
  .success-toast{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity .18s ease;z-index:9999}
  .success-toast.show{opacity:1;pointer-events:auto}
  .success-box{background:rgba(255,255,255,0.98);padding:18px 22px;border-radius:12px;display:flex;flex-direction:column;align-items:center;gap:14px;box-shadow:0 8px 30px rgba(0,0,0,0.15);min-width:220px;max-width:90%;direction:rtl;text-align:center}
  .check-circle{width:48px;height:48px;border-radius:50%;background:#28a745;display:flex;align-items:center;justify-content:center;flex:0 0 48px}
  .check-circle svg{width:24px;height:24px;fill:#fff}
  .success-text{font-size:16px;color:#08365F;font-weight:600;white-space:pre-wrap;line-height:1.6}
  @media (max-width:480px){ .success-box{padding:12px 14px} .success-text{font-size:15px} .check-circle{width:44px;height:44px} }
</style>
<div id="successToast" class="success-toast" role="status" aria-live="polite" aria-hidden="true">
  <div class="success-box">
    <div class="check-circle" aria-hidden="true">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.00039 16.2L4.80039 12L3.40039 13.4L9.00039 19L21.0004 7L19.6004 5.6L9.00039 16.2Z"/></svg>
    </div>
    <div id="successToastMsg" class="success-text">تم الإدخال</div>
  </div>
</div>
<script>
  (function(){
    var toast = document.getElementById('successToast');
    var toastMsg = document.getElementById('successToastMsg');
    var hideTimer = null;
    function hide(){ if(!toast) return; toast.classList.remove('show'); toast.setAttribute('aria-hidden','true'); if(hideTimer){ clearTimeout(hideTimer); hideTimer=null; } }
    window.showSuccess = function(msg){
      if(!toast) return; toastMsg.textContent = msg || 'تم'; toast.classList.add('show'); toast.setAttribute('aria-hidden','false');
      if(hideTimer) clearTimeout(hideTimer);
      hideTimer = setTimeout(function(){ hide(); }, 4000); // زيادة المدة من 1600ms إلى 4000ms (4 ثوان)
    };
    // allow click to dismiss
    toast.addEventListener('click', function(){ hide(); });
  })();
</script>
<script>
  (function(){
    const btn = document.getElementById('printMaintenanceSummaryBtn');
    if(!btn) return;
    // replace existing listeners by cloning the button
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
    newBtn.addEventListener('click', function(){
      const maint = (typeof maintenance !== 'undefined' ? maintenance : []).filter(m => !m.deleted);
      const totalMaint = maint.length;
      const maintByGroup = {};
      maint.forEach(m => {
        const group = m.line || 'غير محدد';
        if(!maintByGroup[group]) maintByGroup[group] = [];
        maintByGroup[group].push({ machine: m.machine, type: m.type });
      });
      Object.keys(maintByGroup).forEach(group => {
        const machines = {};
        maintByGroup[group].forEach(item => {
          if(!machines[item.machine]) machines[item.machine] = {};
          if(!machines[item.machine][item.type]) machines[item.machine][item.type] = 0;
          machines[item.machine][item.type]++;
        });
        maintByGroup[group] = machines;
      });

      const orderedGroups = Object.keys(MACHINE_GROUPS).concat(Object.keys(maintByGroup).filter(g => !Object.keys(MACHINE_GROUPS).includes(g)));

      const style = `<style>body{font-family:'Segoe UI',Arial;direction:rtl;background:#f7fafd;padding:24px}.summary-title{color:#0A4C88;text-align:center;font-size:22px;font-weight:700;margin-bottom:8px}.summary-desc{text-align:center;color:#444;font-size:14px;margin-bottom:8px}.summary-date{text-align:center;color:#666;margin-bottom:12px}.summary-total{background:#e8f7e8;color:#00796b;padding:10px;border-radius:6px;text-align:center;font-weight:700;margin-bottom:12px}.group-section{margin-bottom:20px}.group-title{background:#0A4C88;color:#fff;padding:10px;border-radius:8px;text-align:center;margin-bottom:12px}.cards-wrap{display:flex;flex-wrap:wrap;gap:12px;justify-content:center}.summary-card{background:#fff;border-radius:8px;padding:22px 28px;min-width:220px;max-width:320px;margin-bottom:10px;display:flex;flex-direction:column;align-items:center}.card-title{font-size:19px;font-weight:700;color:#0A4C88;margin-bottom:6px;text-align:center}.card-type{font-size:15px;color:#0077b6;margin-bottom:8px}.card-count{font-size:24px;font-weight:700;color:#00796b;background:#e8f7e8;padding:8px 22px;border-radius:8px;margin-bottom:4px;box-shadow:0 1px 6px #0001}.footer{margin-top:30px;text-align:center;color:#888;font-size:14px;letter-spacing:1px}</style>`;

      let html = `<html dir="rtl"><head><meta charset="utf-8"><title>ملخص الصيانة</title>${style}</head><body>`;
      html += `<div class="summary-title">ملخص الصيانة حسب قوائم الماكينات</div>`;
      html += `<div class="summary-desc">تقرير يوضح توزيع الصيانة لكل مجموعة وماكيناتها وأنواع الصيانة</div>`;
      html += `<div class="summary-date">تاريخ الإنشاء: ${new Date().toLocaleDateString()}</div>`;
      html += `<div class="summary-total">إجمالي عمليات الصيانة: ${totalMaint.toLocaleString('ar-EG')}</div>`;

      orderedGroups.forEach(group => {
        if(!maintByGroup[group]) return;
        const machines = maintByGroup[group];
        html += `<div class="group-section"><div class="group-title">${group}</div><div class="cards-wrap">`;
        Object.entries(machines).forEach(([machine, typesObj]) => {
          Object.entries(typesObj).forEach(([type, count]) => {
            html += `<div class="summary-card"><div class="card-title">${escapeHtml(machine)}</div><div class="card-type">${escapeHtml(type)}</div><div class="card-count">${count.toLocaleString('ar-EG')}</div></div>`;
          });
        });
        html += `</div></div>`;
      });

      html += `<div style="text-align:center;color:#888;margin-top:18px;font-size:13px">نظام إدارة الأعطال والصيانة — الكهرباء</div>`;
      html += `</body></html>`;
      const w = window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=>w.print(),400);
    });
  })();
</script>
</body>
</html>
